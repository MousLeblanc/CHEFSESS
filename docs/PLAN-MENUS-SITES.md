# üìã Plan - G√©n√©rateur de Menus par Site

**Date** : 29 octobre 2025  
**Objectif** : Permettre √† chaque site (EHPAD, h√¥pital, etc.) de g√©n√©rer des menus adapt√©s √† tous ses r√©sidents

---

## üéØ Principe

Chaque site a des r√©sidents avec des profils diff√©rents :
- **Portions** : normale, double, demi-portion, quart
- **Textures** : IDDSI 0-7, finger food
- **Allergies** : lactose, gluten, fruits √† coque, etc.
- **Restrictions** : diab√®te, sans sel, sans sucre, etc.

Le syst√®me doit :
1. ‚úÖ Analyser **tous les r√©sidents du site**
2. ‚úÖ Grouper par profils similaires
3. ‚úÖ G√©n√©rer **un menu avec variantes** pour couvrir tous les besoins
4. ‚úÖ Fonctionner pour **n'importe quel √©tablissement** (Vulpia ou autre)

---

## ‚úÖ Ce qui est fait (29 oct)

### **Frontend - `client/js/site-menu-generator.js`**

```javascript
class SiteMenuGenerator {
  constructor(siteId) {
    this.siteId = siteId;  // ‚úÖ G√©n√©rique - n'importe quel site
    this.residents = [];
    this.groupedProfiles = null;
  }

  // ‚úÖ M√©thodes impl√©ment√©es :
  async loadResidents()        // Charge r√©sidents du site
  analyzeProfiles()            // Analyse portions/textures/allergies
  createVariantGroups()        // Cr√©e variantes de menu
  async generateMenu(config)   // Appelle API g√©n√©ration
  formatMenuDisplay()          // Affiche r√©sultats
}
```

**Caract√©ristiques** :
- ‚úÖ **G√©n√©rique** : fonctionne avec n'importe quel `siteId`
- ‚úÖ **Ind√©pendant du groupe** : pas de r√©f√©rence √† Vulpia
- ‚úÖ **Flexible** : supporte tous types d'√©tablissements

---

## üöß Ce qui reste √† faire

### **1. Backend - Endpoint API**

**Fichier** : `routes/menuRoutes.js`

```javascript
// √Ä ajouter
router.post('/generate-site', protect, menuController.generateSiteMenu);
```

**Permissions** :
- ‚úÖ `protect` : authentifi√©
- ‚úÖ V√©rifier que `req.user.siteId` existe
- ‚úÖ Fonctionne pour **tous les √©tablissements** (Vulpia, autres, ind√©pendants)

---

### **2. Controller - Logique de g√©n√©ration**

**Fichier** : `controllers/menuController.js`

```javascript
export const generateSiteMenu = async (req, res) => {
  try {
    const {
      siteId,
      numDays,
      numDishesPerMeal,
      totalResidents,
      variants,      // [{ texture, portion, count, residents }]
      allergies,
      restrictions,
      useStock,
      theme
    } = req.body;

    // 1. V√©rifier permissions
    //    ‚úÖ L'utilisateur peut-il g√©n√©rer pour ce site ?
    //    ‚úÖ Pas de hardcode Vulpia - v√©rifier siteId g√©n√©rique

    // 2. R√©cup√©rer le type d'√©tablissement
    const site = await Site.findById(siteId);
    const establishmentType = site.establishmentType; // ehpad, hopital, etc.

    // 3. G√©n√©rer le menu via OpenAI
    //    ‚úÖ Utiliser variants pour cr√©er adaptations
    //    ‚úÖ G√©rer portions/textures automatiquement

    // 4. Sauvegarder le menu
    const menu = new Menu({
      siteId: siteId,
      groupId: site.groupId,  // ‚úÖ Peut √™tre null (site ind√©pendant)
      establishmentType: establishmentType,
      days: generatedDays,
      variants: variants,
      metadata: {
        totalResidents,
        allergies,
        restrictions
      }
    });

    await menu.save();

    res.json({
      success: true,
      menu: menu,
      message: `Menu g√©n√©r√© pour ${totalResidents} r√©sidents`
    });

  } catch (error) {
    res.status(500).json({
      success: false,
      message: error.message
    });
  }
};
```

**Points cl√©s** :
- ‚úÖ **V√©rification permissions g√©n√©riques** (pas sp√©cifique √† Vulpia)
- ‚úÖ **Support sites ind√©pendants** (`groupId` peut √™tre null)
- ‚úÖ **Type d'√©tablissement dynamique** (EHPAD, h√¥pital, etc.)

---

### **3. Int√©gration Frontend - `ehpad-dashboard.html`**

**Onglet "Menus"** - Ajouter section :

```html
<!-- Section G√©n√©rateur de Menus -->
<div class="card">
  <h2>üçΩÔ∏è G√©n√©rateur de Menus Intelligent</h2>
  <p>G√©n√©rez un menu adapt√© √† tous vos r√©sidents</p>
  
  <form id="site-menu-generator-form">
    <div class="form-group">
      <label>Nombre de jours :</label>
      <input type="number" id="menu-days" value="7" min="1" max="14">
    </div>

    <div class="form-group">
      <label>Plats par repas :</label>
      <input type="number" id="menu-dishes" value="2" min="1" max="5">
    </div>

    <div class="form-group">
      <label>
        <input type="checkbox" id="menu-use-stock">
        Utiliser uniquement les produits en stock
      </label>
    </div>

    <button type="submit">
      <i class="fas fa-magic"></i> G√©n√©rer le menu
    </button>
  </form>

  <!-- R√©sultats -->
  <div id="menu-results" style="display: none;">
    <!-- Sera rempli dynamiquement -->
  </div>
</div>

<!-- Script -->
<script type="module">
  import SiteMenuGenerator from './js/site-menu-generator.js';

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('site-menu-generator-form');
    const resultsDiv = document.getElementById('menu-results');
    
    // R√©cup√©rer le siteId de l'utilisateur connect√©
    const user = JSON.parse(sessionStorage.getItem('user'));
    const siteId = user.siteId;

    if (!siteId) {
      console.error('‚ùå Pas de siteId pour cet utilisateur');
      return;
    }

    // Cr√©er le g√©n√©rateur
    const generator = new SiteMenuGenerator(siteId);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const numDays = parseInt(document.getElementById('menu-days').value);
      const numDishes = parseInt(document.getElementById('menu-dishes').value);
      const useStock = document.getElementById('menu-use-stock').checked;

      try {
        // Afficher loading
        resultsDiv.innerHTML = '<div class="loading">‚è≥ G√©n√©ration en cours...</div>';
        resultsDiv.style.display = 'block';

        // G√©n√©rer le menu
        const result = await generator.generateMenu({
          numDays: numDays,
          numDishesPerMeal: numDishes,
          useStock: useStock
        });

        // Afficher les r√©sultats
        resultsDiv.innerHTML = generator.formatMenuDisplay(result);

      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
      }
    });
  });
</script>
```

---

### **4. Mod√®le Menu - `models/Menu.js`**

**V√©rifier/Ajouter champs** :

```javascript
const menuSchema = new mongoose.Schema({
  siteId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Site',
    required: true
  },
  groupId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Group',
    // ‚úÖ PAS required - sites ind√©pendants possibles
  },
  establishmentType: {
    type: String,
    enum: ['ehpad', 'hopital', 'maison_retraite', 'cantine_scolaire', 'cantine_entreprise'],
    required: true
  },
  days: [{
    dayNumber: Number,
    date: Date,
    meals: {
      breakfast: [{ name: String, description: String, adaptations: [] }],
      lunch: [{ name: String, description: String, adaptations: [] }],
      dinner: [{ name: String, description: String, adaptations: [] }]
    }
  }],
  variants: [{
    texture: String,  // IDDSI level
    portion: String,  // normale, double, demi
    count: Number,    // Nombre de r√©sidents
    residents: [{
      id: mongoose.Schema.Types.ObjectId,
      name: String,
      room: String
    }]
  }],
  metadata: {
    totalResidents: Number,
    allergies: [String],
    restrictions: [String],
    generatedAt: { type: Date, default: Date.now }
  }
});
```

---

### **5. Service OpenAI - G√©n√©ration adapt√©e**

**Fichier** : `services/aiService.js` ou `openaiService.js`

**Fonction √† cr√©er/modifier** :

```javascript
export async function generateSiteMenu({
  establishmentType,
  numDays,
  numDishesPerMeal,
  variants,
  allergies,
  restrictions,
  useStock
}) {
  // Construire le prompt
  const prompt = `
Tu es un chef nutritionniste sp√©cialis√© en ${establishmentType}.

CONTEXTE:
- ${numDays} jours de menus
- ${numDishesPerMeal} plats par repas
- Variantes requises:
${variants.map(v => `  * ${v.count} personnes: ${v.texture} / ${v.portion}`).join('\n')}

CONTRAINTES:
- Allergies √† √©viter: ${allergies.join(', ')}
- Restrictions: ${restrictions.join(', ')}
${useStock ? '- Utiliser uniquement produits en stock' : ''}

G√âN√àRE un menu JSON avec adaptations pour chaque variante.
  `;

  // Appeler OpenAI
  const response = await openai.chat.completions.create({
    model: "gpt-4",
    messages: [
      { role: "system", content: "Tu es un chef nutritionniste expert." },
      { role: "user", content: prompt }
    ],
    temperature: 0.7
  });

  // Parser et retourner
  return JSON.parse(response.choices[0].message.content);
}
```

---

### **6. Tests √† effectuer**

#### **Test 1 : Site Vulpia**
- ‚úÖ EHPAD De Linde (Vulpia Group)
- ‚úÖ R√©sidents vari√©s : Charles (double), Fran√ßois (demi), Claire (demi)
- ‚úÖ Textures : IDDSI 6, IDDSI 7, finger food
- ‚úÖ G√©n√©ration menu ‚Üí Variantes adapt√©es

#### **Test 2 : Site ind√©pendant**
- ‚úÖ Cr√©er un EHPAD hors Vulpia (groupId = null)
- ‚úÖ Ajouter r√©sidents
- ‚úÖ G√©n√©rer menu
- ‚úÖ V√©rifier que √ßa fonctionne

#### **Test 3 : H√¥pital**
- ‚úÖ Cr√©er un h√¥pital
- ‚úÖ R√©sidents avec restrictions m√©dicales
- ‚úÖ G√©n√©rer menu adapt√©

---

## üîë Points cl√©s - G√©n√©ricit√©

### **‚úÖ Ce qui rend le syst√®me g√©n√©rique**

1. **Pas de hardcode Vulpia** :
   ```javascript
   // ‚ùå Mauvais
   if (groupId === 'vulpia_id') { ... }
   
   // ‚úÖ Bon
   const site = await Site.findById(siteId);
   const group = site.groupId ? await Group.findById(site.groupId) : null;
   ```

2. **Support sites ind√©pendants** :
   ```javascript
   groupId: {
     type: mongoose.Schema.Types.ObjectId,
     ref: 'Group',
     required: false  // ‚úÖ Pas obligatoire
   }
   ```

3. **Type d'√©tablissement dynamique** :
   ```javascript
   const establishmentType = site.establishmentType;
   // Peut √™tre : ehpad, hopital, maison_retraite, cantine, etc.
   ```

4. **V√©rification permissions g√©n√©rique** :
   ```javascript
   // V√©rifier que l'utilisateur a acc√®s au site
   if (req.user.siteId.toString() !== siteId) {
     return res.status(403).json({ message: 'Acc√®s refus√©' });
   }
   ```

---

## üì¶ Architecture finale

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  N'importe quel Site                    ‚îÇ
‚îÇ  (Vulpia, autres, ind√©pendants)         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  - siteId: unique                       ‚îÇ
‚îÇ  - groupId: nullable                    ‚îÇ
‚îÇ  - establishmentType: dynamique         ‚îÇ
‚îÇ  - r√©sidents: array                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚¨áÔ∏è
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SiteMenuGenerator                      ‚îÇ
‚îÇ  (Frontend - G√©n√©rique)                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. Charge r√©sidents du siteId          ‚îÇ
‚îÇ  2. Analyse profils                     ‚îÇ
‚îÇ  3. Cr√©e variantes                      ‚îÇ
‚îÇ  4. Appelle API                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚¨áÔ∏è
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  /api/menus/generate-site               ‚îÇ
‚îÇ  (Backend - G√©n√©rique)                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. V√©rifie permissions (siteId)        ‚îÇ
‚îÇ  2. R√©cup√®re type √©tablissement         ‚îÇ
‚îÇ  3. G√©n√®re menu OpenAI                  ‚îÇ
‚îÇ  4. Sauvegarde Menu                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚¨áÔ∏è
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Menu g√©n√©r√© avec variantes             ‚îÇ
‚îÇ  - Adapt√© aux r√©sidents du site         ‚îÇ
‚îÇ  - Ind√©pendant du groupe                ‚îÇ
‚îÇ  - Fonctionne pour tous                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Ordre d'impl√©mentation (Demain)

### **√âtape 1 : Backend (1h)**
1. Cr√©er `generateSiteMenu` dans `menuController.js`
2. Ajouter route dans `menuRoutes.js`
3. V√©rifier mod√®le `Menu.js`
4. Tester avec Postman

### **√âtape 2 : Service OpenAI (45min)**
1. Cr√©er/adapter fonction g√©n√©ration
2. G√©rer variantes dans le prompt
3. Parser r√©ponse JSON

### **√âtape 3 : Frontend UI (1h)**
1. Ajouter section dans `ehpad-dashboard.html`
2. Int√©grer `site-menu-generator.js`
3. G√©rer √©v√©nements formulaire

### **√âtape 4 : Affichage r√©sultats (45min)**
1. Formatter HTML des menus
2. Afficher variantes clairement
3. Permettre sauvegarde/export

### **√âtape 5 : Tests (30min)**
1. Tester site Vulpia (De Linde)
2. Tester site ind√©pendant
3. V√©rifier permissions

**Total estim√© : 4h**

---

## ‚úÖ Checklist finale

Avant de consid√©rer le syst√®me termin√© :

- [ ] Fonctionne pour site Vulpia
- [ ] Fonctionne pour site ind√©pendant (groupId null)
- [ ] Fonctionne pour EHPAD
- [ ] Fonctionne pour h√¥pital
- [ ] Fonctionne pour cantine
- [ ] G√®re correctement les permissions
- [ ] Affiche toutes les variantes
- [ ] Sauvegarde les menus en base
- [ ] Export possible (PDF/Excel)
- [ ] Documentation compl√®te

---

## üìù Notes importantes

### **√âviter**
- ‚ùå Hardcoder "Vulpia"
- ‚ùå Supposer qu'un site a toujours un groupId
- ‚ùå Ignorer le type d'√©tablissement

### **Faire**
- ‚úÖ Utiliser siteId comme identifiant unique
- ‚úÖ V√©rifier groupId (peut √™tre null)
- ‚úÖ Adapter selon establishmentType
- ‚úÖ Permissions g√©n√©riques (pas sp√©cifiques √† Vulpia)

---

## üîñ √âtat actuel

**Date** : 29 octobre 2025, 23:50  
**Commit** : `597cada`  
**Fichier cr√©√©** : `client/js/site-menu-generator.js` ‚úÖ  
**√Ä continuer demain** : Backend + UI + Tests

---

**Ce document servira de guide complet pour l'impl√©mentation demain. üöÄ**

