<!DOCTYPE html>

<html lang="fr">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion - CHaiF SES</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    .container {
      max-width: 400px;
      margin: 3rem auto;
      padding: 2rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    form input {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

    button {
      padding: 0.75rem 2rem;
      background: #e67300;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background: #cc6600;
    }

    .link {
      margin-top: 1rem;
      font-size: 0.95rem;
    }

    .link a {
      color: #3366cc;
      text-decoration: none;
    }

    .link a:hover {
      text-decoration: underline;
    }
    .container { max-width: 400px; margin: 3rem auto; padding: 2rem; background: white; border-radius: 16px; box-shadow: 0 0 12px rgba(0,0,0,0.1); text-align: center; }
    form input { width: 100%; padding: 0.75rem; margin: 0.5rem 0 1rem; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 0.75rem 2rem; background: #e67300; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    button:hover { background: #cc6600; }
    .link { margin-top: 1rem; font-size: 0.95rem; }
    .link a { color: #3366cc; text-decoration: none; }
    .link a:hover { text-decoration: underline; }
    
    .password-wrapper { position: relative; width: 100%; }
    .password-wrapper input { padding-right: 2.5rem; }
    .password-toggle { 
      position: absolute; 
      right: 0.75rem; 
      top: 50%; 
      transform: translateY(-50%); 
      background: none; 
      border: none; 
      cursor: pointer; 
      color: #666; 
      font-size: 1.1rem; 
      padding: 0.5rem; 
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2rem;
      height: 2rem;
    }
    .password-toggle i {
      display: inline-block;
      line-height: 1;
    }
    .password-toggle:hover { color: #333; }
    
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 16px; min-width: 300px; max-width: 400px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; }
    .toast-success { border-left: 4px solid #28a745; }
    .toast-error { border-left: 4px solid #dc3545; }
    .toast-icon { font-size: 18px; font-weight: bold; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body>
  <div id="toast-container"></div>
  
  <div class="container">
    <h1>Connexion ChAIf SES</h1>

    <form id="login-form">
      <input type="email" id="email" placeholder="Email" required />
      <div class="password-wrapper">
        <input type="password" id="password" placeholder="Mot de passe" required />
        <button type="button" class="password-toggle" id="toggle-password" aria-label="Afficher/masquer le mot de passe">
          <i class="fas fa-eye"></i>
        </button>
      </div>
      <button type="submit">Se connecter</button>
    </form>
    

    <div class="link">
      Pas encore de compte ? <a href="choisir-profil.html">S'inscrire</a>
    </div>
  </div>
<script src="js/init.js"></script>
<script type="module">
// Utiliser sessionStorage au lieu de localStorage pour la coh√©rence
document.addEventListener('DOMContentLoaded', async () => {
  // V√©rifier si on vient d'une d√©connexion
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('logout') === 'true') {
    console.log('‚úÖ D√©connexion d√©tect√©e - pas de redirection automatique');
    // Nettoyer l'URL
    window.history.replaceState({}, document.title, '/');
    return;
  }
  
  const userStr = sessionStorage.getItem('user');
  if (!userStr) {
    // Pas de v√©rification localStorage - on utilise uniquement sessionStorage
    return;
  }
  
  try {
    const user = JSON.parse(userStr);
    
    // V√©rifier si on vient d'une d√©connexion explicite ou d'une erreur de session
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('logout') === 'true' || urlParams.get('sessionExpired') === 'true') {
      console.log('‚úÖ D√©connexion ou session expir√©e d√©tect√©e - pas de redirection automatique');
      // Nettoyer l'URL
      window.history.replaceState({}, document.title, '/');
      sessionStorage.removeItem('user');
      return;
    }
    
    // V√©rifier que l'utilisateur est toujours authentifi√© avant de rediriger
    // Cela √©vite les redirections automatiques vers d'autres dashboards apr√®s un hard refresh
    try {
      const authCheck = await fetch('/api/auth/me', {
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (!authCheck.ok) {
        console.log('‚ö†Ô∏è Session expir√©e - pas de redirection automatique');
        sessionStorage.removeItem('user');
        return; // Ne pas rediriger si la session est expir√©e
      }
      
      const authData = await authCheck.json();
      const currentUser = authData?.user || authData;
      
      // V√©rifier que le r√¥le correspond toujours
      if (currentUser.role !== user.role) {
        console.log('‚ö†Ô∏è R√¥le chang√© - pas de redirection automatique');
        sessionStorage.removeItem('user');
        return;
      }
      
      // V√©rifier que l'utilisateur est sur la page de connexion (pas d√©j√† sur un dashboard)
      // Si l'utilisateur est d√©j√† sur un dashboard, ne pas rediriger
      const currentPath = window.location.pathname;
      if (currentPath !== '/' && currentPath !== '/index.html') {
        console.log('‚ö†Ô∏è Utilisateur d√©j√† sur une page - pas de redirection automatique');
        return;
      }
      
      // Pour les utilisateurs de sites (collectivite avec siteId), v√©rifier si on a d√©j√† un siteId stock√©
      // Cela permet d'avoir plusieurs onglets avec des sites diff√©rents
      if (currentUser.role === 'collectivite' && currentUser.siteId) {
        const storedSiteId = sessionStorage.getItem('currentSiteId');
        if (storedSiteId && storedSiteId !== currentUser.siteId) {
          console.log('‚ö†Ô∏è SiteId stock√© diff√®re du siteId du token - pas de redirection automatique');
          console.log('   - SiteId stock√©:', storedSiteId);
          console.log('   - SiteId du token:', currentUser.siteId);
          console.log('   - L\'utilisateur est probablement d√©j√† sur un autre site dans cet onglet');
          return; // Ne pas rediriger pour permettre √† l'utilisateur de choisir
        }
        // Stocker le siteId pour cet onglet seulement si pas d√©j√† stock√©
        if (!storedSiteId) {
          sessionStorage.setItem('currentSiteId', currentUser.siteId);
          console.log('‚úÖ SiteId stock√© pour cet onglet:', currentUser.siteId);
        }
      }
      
      // Importer la fonction de redirection
      const { redirectByRole } = await import('./js/auth.js');
      // Redirection intelligente selon le role et establishmentType
      redirectByRole(currentUser.role, currentUser.establishmentType);
    } catch (authError) {
      console.error('‚ùå Erreur lors de la v√©rification de l\'authentification:', authError);
      // En cas d'erreur, ne pas rediriger automatiquement
      sessionStorage.removeItem('user');
    }
  } catch (error) {
    console.error('Erreur lors de la redirection:', error);
  }
});
</script>
<!-- üßπ Script de nettoyage des anciens tokens (doit √™tre charg√© en premier) -->
<script src="js/token-cleanup.js"></script>

<script type="module" src="js/index.js"></script>
<script type="module" src="js/login.js"></script>
<script>
  // Fonctionnalit√© d'affichage/masquage du mot de passe
  document.addEventListener('DOMContentLoaded', () => {
    const passwordInput = document.getElementById('password');
    const toggleButton = document.getElementById('toggle-password');
    
    if (passwordInput && toggleButton) {
      toggleButton.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        // Changer l'ic√¥ne
        const icon = toggleButton.querySelector('i');
        if (type === 'password') {
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
        } else {
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
        }
      });
    }
  });
</script>

</body>
</html>

