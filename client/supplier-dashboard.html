<!DOCTYPE html>
<html lang="fr">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chef SES - Tableau de bord Fournisseur</title>
    <link rel="stylesheet" href="CSS/main.css">
    <link rel="stylesheet" href="./css/all.min.css">
    <style>
        .dashboard-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #16a085 100%);
            color: white;
            border-radius: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #16a085;
        }

        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #16a085;
            padding-bottom: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        .btn-primary {
            background-color: #16a085;
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .product-header h3 {
            margin: 0;
            color: #2c3e50;
            flex: 1;
        }

        .product-badges {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .promo-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .save-badge {
            background: #27ae60;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .original-price {
            text-decoration: line-through;
            color: #999;
            margin-right: 5px;
        }

        .promo-price {
            color: #e74c3c;
            font-weight: bold;
        }

        .product-info {
            margin-bottom: 15px;
        }

        .product-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .action-buttons {
            margin-top: 15px;
        }

        .orders-list {
            margin-top: 20px;
        }

        .order-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }

        .order-item h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .hidden {
            display: none;
        }

        .show {
            display: block;
        }

        /* Style pour les modales/formulaires centr√©s */
        #add-product-form {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0);
            z-index: 9999;
            overflow-y: auto;
            padding: 20px;
            transition: background-color 0.3s ease;
        }

        #add-product-form.show {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 50px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #add-product-form .modal-wrapper {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }

        #add-product-form.show .modal-wrapper {
            transform: scale(1);
            opacity: 1;
        }

        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-icon {
            margin-right: 10px;
            font-size: 18px;
        }

        .toast-message {
            flex: 1;
        }

        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background-color: #c0392b;
        }

        /* Styles pour les cartes de produits */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .product-card h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #16a085;
            padding-bottom: 10px;
        }

        .product-card p {
            margin: 8px 0;
            color: #555;
        }

        .product-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .product-actions button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Animations pour les notifications */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1>Tableau de bord Fournisseur</h1>
                <p id="business-name">Nom de l'entreprise</p>
            </div>
            <button id="logout-btn" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> D√©connexion
            </button>
        </div>
        
        <script>
            // G√©rer la d√©connexion
            document.getElementById('logout-btn')?.addEventListener('click', async () => {
                console.log('üö™ D√©connexion...');
                
                // 1Ô∏è‚É£ Nettoyer IMM√âDIATEMENT le sessionStorage AVANT l'API
                // Cela √©vite la redirection automatique dans index.html
                sessionStorage.clear();
                
                try {
                    // ‚úÖ S√âCURIT√â : Utiliser fetchWithCSRF pour la protection CSRF
                    const fetchFn = (typeof window !== 'undefined' && window.fetchWithCSRF) ? window.fetchWithCSRF : fetch;
                    
                    // 2Ô∏è‚É£ Appeler l'API pour supprimer le cookie c√¥t√© serveur
                    await fetchFn('/api/auth/logout', {
                        method: 'POST',
                        credentials: 'include', // Important pour envoyer le cookie
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    console.log('‚úÖ Cookie supprim√© c√¥t√© serveur');
                } catch (error) {
                    console.error('‚ùå Erreur lors de la d√©connexion API:', error);
                    // Continuer quand m√™me la d√©connexion m√™me si l'API √©choue
                }
                
                // 3Ô∏è‚É£ Forcer un d√©lai minimal pour s'assurer que tout est nettoy√©
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // 4Ô∏è‚É£ Rediriger vers la page de connexion avec un param√®tre pour √©viter la redirection auto
                window.location.replace('/?logout=true');
            });
        </script>

        <!-- Navigation par onglets -->
        <div class="tab-navigation" style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #ddd; flex-wrap: wrap;">
            <button class="tab-btn active" data-tab="products" style="padding: 1rem 2rem; background: white; border: none; border-bottom: 3px solid #16a085; cursor: pointer; font-weight: 600; transition: all 0.3s; color: #16a085; display: inline-block;">
                <i class="fas fa-boxes"></i> Produits & Stock
            </button>
            <button class="tab-btn" data-tab="orders" style="padding: 1rem 2rem; background: white; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; transition: all 0.3s; color: #2c3e50; display: inline-block;">
                <i class="fas fa-shopping-cart"></i> Commandes
            </button>
            <button class="tab-btn" data-tab="stats" style="padding: 1rem 2rem; background: white; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; transition: all 0.3s; color: #2c3e50; display: inline-block;">
                <i class="fas fa-chart-bar"></i> Statistiques
            </button>
            <button class="tab-btn" data-tab="ratings" style="padding: 1rem 2rem; background: white; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; transition: all 0.3s; color: #2c3e50; display: inline-block;">
                <i class="fas fa-star"></i> Avis Re√ßus
            </button>
            <button class="tab-btn" data-tab="profile" style="padding: 1rem 2rem; background: white; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; transition: all 0.3s; color: #2c3e50; display: inline-block;">
                <i class="fas fa-user-cog"></i> Mon Profil
            </button>
        </div>
        
        <style>
            .tab-btn:hover {
                background: #f8f9fa !important;
                color: #16a085 !important;
            }
            .tab-btn.active {
                background: white !important;
                border-bottom: 3px solid #16a085 !important;
                color: #16a085 !important;
            }
            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
            }
            .clients-list {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }
            .client-card {
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }
            .client-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            }
            .clickable-stat {
                transition: all 0.3s ease;
            }
            .clickable-stat:hover {
                transform: translateY(-3px);
                box-shadow: 0 4px 15px rgba(22, 160, 133, 0.3) !important;
                background: linear-gradient(135deg, #ffffff 0%, #f0f9f7 100%) !important;
            }
            .loading-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 2rem;
            }
            .loader {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #16a085;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin-bottom: 1rem;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>

        <!-- Onglet Produits & Stock -->
        <div id="products-tab" class="tab-content active">
        <div class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Mes Produits</h2>
                <button id="show-add-product" class="btn btn-primary">+ Ajouter un Produit</button>
                <button id="test-direct-btn" class="btn btn-secondary">Test Direct</button>
            </div>

            <!-- Formulaire d'ajout de produit -->
            <form id="add-product-form" class="hidden">
                <div class="modal-wrapper">
                <button type="button" class="modal-close-btn" id="close-product-form">&times;</button>
                <h3>Ajouter un nouveau produit</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="product-name">Nom du produit *</label>
                        <input type="text" id="product-name" required placeholder="ex: Pommes Golden, Filet de b≈ìuf, Riz basmati">
                    </div>
                    <div class="form-group">
                        <label for="product-category">Cat√©gorie *</label>
                        <select id="product-category" required>
                            <option value="">S√©lectionner une cat√©gorie</option>
                            <option value="fruits-legumes">Fruits et L√©gumes</option>
                            <option value="viandes">Viandes et Volailles</option>
                            <option value="poissons">Poissons et Fruits de mer</option>
                            <option value="epicerie">√âpicerie</option>
                            <option value="boissons">Boissons</option>
                            <option value="produits-laitiers">Produits Laitiers</option>
                            <option value="boulangerie">Boulangerie</option>
                            <option value="autres">Autres</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="product-price">Prix (‚Ç¨) *</label>
                        <input type="number" id="product-price" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="product-unit">Unit√© *</label>
                        <select id="product-unit" required>
                            <option value="">S√©lectionner une unit√©</option>
                            <option value="kg">Kilogramme (kg)</option>
                            <option value="g">Gramme (g)</option>
                            <option value="litre">Litre (L)</option>
                            <option value="ml">Millilitre (ml)</option>
                            <option value="pi√®ce">Pi√®ce</option>
                            <option value="paquet">Paquet</option>
                            <option value="bo√Æte">Bo√Æte</option>
                            <option value="sachet">Sachet</option>
                            <option value="bouteille">Bouteille</option>
                            <option value="portion">Portion</option>
                            <option value="carton">Carton</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="delivery-time">D√©lai de livraison (jours) *</label>
                        <input type="number" id="delivery-time" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="min-order">Commande minimum *</label>
                        <input type="number" id="min-order" min="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="product-description">Description</label>
                    <textarea id="product-description" rows="3" placeholder="Description du produit, origine, qualit√©..."></textarea>
                </div>
                
                <!-- Code-barres -->
                <div class="form-group">
                    <label for="product-barcode">Code-barres (EAN-13, UPC, etc.)</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="product-barcode" placeholder="Ex: 3017620422003" pattern="[0-9]{8,13}" style="flex: 1;">
                        <button type="button" id="barcode-lookup-btn" class="btn btn-secondary" onclick="lookupProductByBarcode()" title="Rechercher les informations du produit">
                            <i class="fas fa-search"></i> Rechercher
                        </button>
                    </div>
                    <small style="color: #7f8c8d; margin-top: 0.25rem; display: block;">
                        <i class="fas fa-info-circle"></i> Saisissez le code-barres pour remplir automatiquement les informations de tra√ßabilit√©
                    </small>
                    <div id="barcode-lookup-result" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: #d5f4e6; border-radius: 4px; border-left: 3px solid #27ae60;"></div>
                </div>
                
                <!-- Informations de tra√ßabilit√© (AFSCA) -->
                <div class="form-section" style="border: 2px solid #3498db; padding: 1rem; border-radius: 8px; margin: 1rem 0; background: #e8f4f8;">
                    <h4 style="margin-top: 0; color: #3498db;">
                        <i class="fas fa-shield-alt"></i> Tra√ßabilit√© (Exigences AFSCA)
                    </h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="traceability-country">Pays d'origine *</label>
                            <input type="text" id="traceability-country" placeholder="Ex: France, Belgique, Espagne" required>
                        </div>
                        <div class="form-group">
                            <label for="traceability-batch">Num√©ro de lot</label>
                            <input type="text" id="traceability-batch" placeholder="Ex: LOT-2024-001">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="traceability-number">Num√©ro de tra√ßabilit√©</label>
                            <input type="text" id="traceability-number" placeholder="Num√©ro unique de tra√ßabilit√©">
                        </div>
                        <div class="form-group">
                            <label for="traceability-health-stamp">Estampille sanitaire</label>
                            <input type="text" id="traceability-health-stamp" placeholder="Ex: FR 12.345.001 CE">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="traceability-presentation">Pr√©sentation commerciale</label>
                            <select id="traceability-presentation">
                                <option value="">-- S√©lectionner --</option>
                                <option value="r√©frig√©r√©">R√©frig√©r√©</option>
                                <option value="surgel√©">Surgel√©</option>
                                <option value="conserve">Conserve</option>
                                <option value="4√®me gamme">4√®me gamme</option>
                                <option value="5√®me gamme">5√®me gamme</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="traceability-category">Cat√©gorie produit</label>
                            <input type="text" id="traceability-category" placeholder="Ex: Fruits, L√©gumes, Viande">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="traceability-class">Classe (A/B)</label>
                            <select id="traceability-class">
                                <option value="">-- S√©lectionner --</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Label qualit√©</label>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="traceability-has-label" style="margin: 0;">
                                    <span>Oui</span>
                                </label>
                                <select id="traceability-label-type" style="flex: 1;" disabled>
                                    <option value="">-- Type de label --</option>
                                    <option value="AOC">AOC</option>
                                    <option value="Label Rouge">Label Rouge</option>
                                    <option value="AB">AB (Agriculture Biologique)</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="traceability-production-date">Date de production</label>
                            <input type="date" id="traceability-production-date">
                        </div>
                        <div class="form-group">
                            <label for="traceability-use-by-date">Date limite de consommation</label>
                            <input type="date" id="traceability-use-by-date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="traceability-best-before-date">Date limite d'utilisation optimale (DDM)</label>
                        <input type="date" id="traceability-best-before-date">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="product-promo">Promotion (%)</label>
                        <input type="number" id="product-promo" min="0" max="100" step="1" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="product-save">Produit √† sauver</label>
                        <select id="product-save">
                            <option value="false">Non</option>
                            <option value="true">Oui</option>
                        </select>
                    </div>
                </div>
                
                <!-- Super Promo -->
                <div class="form-section" style="border: 2px solid #f39c12; padding: 1rem; border-radius: 8px; margin: 1rem 0; background: #fff9e6;">
                    <h4 style="margin-top: 0; color: #f39c12;"><i class="fas fa-star"></i> Super Promo</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="super-promo-active" style="margin-right: 0.5rem;">
                                Activer la super promo
                            </label>
                        </div>
                    </div>
                    <div id="super-promo-fields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="super-promo-price">Prix promotionnel (‚Ç¨)</label>
                                <input type="number" id="super-promo-price" min="0" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label for="super-promo-quantity">Quantit√© disponible</label>
                                <input type="number" id="super-promo-quantity" min="0" step="1" placeholder="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="super-promo-end-date">Date de fin (optionnel)</label>
                            <input type="date" id="super-promo-end-date">
                        </div>
                    </div>
                </div>
                
                <!-- Article √† Sauver -->
                <div class="form-section" style="border: 2px solid #e74c3c; padding: 1rem; border-radius: 8px; margin: 1rem 0; background: #ffe6e6;">
                    <h4 style="margin-top: 0; color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Article √† Sauver</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="to-save-active" style="margin-right: 0.5rem;">
                                Activer "√Ä sauver"
                            </label>
                        </div>
                    </div>
                    <div id="to-save-fields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="to-save-price">Prix r√©duit (‚Ç¨)</label>
                                <input type="number" id="to-save-price" min="0" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label for="to-save-quantity">Quantit√© √† sauver</label>
                                <input type="number" id="to-save-quantity" min="0" step="1" placeholder="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="to-save-expiration">Date d'expiration (optionnel)</label>
                            <input type="date" id="to-save-expiration">
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn btn-primary">Ajouter le produit</button>
                    <button type="button" id="cancel-add-product" class="btn btn-secondary">Annuler</button>
                </div>
                </div><!-- fin modal-wrapper -->
            </form>

            <!-- Liste des produits -->
            <div id="products-grid" class="products-grid">
                <!-- Les produits seront charg√©s ici -->
            </div>
        </div>
        </div><!-- Fin onglet Produits & Stock -->

        <!-- Onglet Commandes -->
        <div id="orders-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-shopping-cart"></i> Commandes Re√ßues</h2>
                <div id="orders-list" class="orders-list">
                    <!-- Les commandes seront charg√©es ici -->
                </div>
            </div>
        </div><!-- Fin onglet Commandes -->

        <!-- Onglet Statistiques -->
        <div id="stats-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-chart-bar"></i> Statistiques & Aper√ßu</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Produits Actifs</h3>
                        <div class="number" id="active-products-count">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Commandes en Attente</h3>
                        <div class="number" id="pending-orders-count">0</div>
                    </div>
                    <div class="stat-card clickable-stat" id="clients-stat-card" style="cursor: pointer;">
                        <h3>Clients Actifs</h3>
                        <div class="number" id="active-clients-count">0</div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                            <i class="fas fa-info-circle"></i> Cliquez pour voir les d√©tails
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Commandes</h3>
                        <div class="number" id="total-orders-count">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Section Clients (masqu√©e par d√©faut) -->
            <div class="section" id="clients-section" style="margin-top: 2rem; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2><i class="fas fa-users"></i> Mes Clients</h2>
                    <button id="close-clients-btn" style="background: #e74c3c; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-times"></i> Fermer
                    </button>
                </div>
                <div id="clients-list" class="clients-list" style="margin-top: 1.5rem;">
                    <div class="loading-container" style="text-align: center; padding: 2rem;">
                        <div class="loader"></div>
                        <p>Chargement des clients...</p>
                    </div>
                </div>
            </div>
        </div><!-- Fin onglet Statistiques -->

        <!-- Onglet Avis Re√ßus -->
        <div id="ratings-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-star"></i> Avis Re√ßus</h2>
                <p style="color: #6c757d; margin-bottom: 1.5rem;">Consultez les avis et notes laiss√©s par vos clients.</p>
                
                <!-- Message informatif sur la confidentialit√© -->
                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: start; gap: 1rem;">
                        <div style="font-size: 2rem; flex-shrink: 0;">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.2rem; color: white;">Confidentialit√© de vos avis</h3>
                            <p style="margin: 0; line-height: 1.6; opacity: 0.95;">
                                Les sections <strong>"Points √† am√©liorer"</strong> et <strong>"Suggestions"</strong> sont <strong>strictement priv√©es</strong> et ne sont visibles que par vous. 
                                Elles vous permettent d'identifier les axes d'am√©lioration pour votre service. 
                                Seuls les <strong>"Points positifs"</strong> et la <strong>note globale</strong> sont visibles par les autres utilisateurs de la plateforme.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div id="ratings-loading" style="display: none; text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #16a085;"></i>
                    <p>Chargement des avis...</p>
                </div>
                
                <div id="ratings-container">
                    <!-- Les avis seront charg√©s ici -->
                </div>
            </div>
        </div><!-- Fin onglet Avis Re√ßus -->

        <!-- Onglet Mon Profil -->
        <div id="profile-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-user-cog"></i> Mon Profil Fournisseur</h2>
                <p style="color: #7f8c8d; margin-bottom: 2rem;">G√©rez vos informations de contact, vos coordonn√©es et vos zones de livraison.</p>
                
                <!-- Formulaire de profil -->
                <form id="supplier-profile-form">
                    <!-- Coordonn√©es -->
                    <div class="form-section" style="border: 2px solid #16a085; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; background: #f8f9fa;">
                        <h3 style="margin-top: 0; color: #16a085; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-address-card"></i> Coordonn√©es
                        </h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="supplier-name">Nom du fournisseur *</label>
                                <input type="text" id="supplier-name" required placeholder="Ex: √âpicerie Bio">
                            </div>
                            <div class="form-group">
                                <label for="supplier-contact">Contact *</label>
                                <input type="text" id="supplier-contact" required placeholder="Nom du responsable">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="supplier-email">Email *</label>
                                <input type="email" id="supplier-email" required placeholder="contact@example.com">
                            </div>
                            <div class="form-group">
                                <label for="supplier-phone">T√©l√©phone *</label>
                                <input type="tel" id="supplier-phone" required placeholder="+32 2 123 45 67">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="supplier-address-street">Adresse</label>
                            <input type="text" id="supplier-address-street" placeholder="Rue et num√©ro">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="supplier-address-city">Ville</label>
                                <input type="text" id="supplier-address-city" placeholder="Bruxelles">
                            </div>
                            <div class="form-group">
                                <label for="supplier-address-postalCode">Code postal</label>
                                <input type="text" id="supplier-address-postalCode" placeholder="1000">
                            </div>
                            <div class="form-group">
                                <label for="supplier-address-country">Pays</label>
                                <input type="text" id="supplier-address-country" placeholder="Belgique" value="Belgique">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informations pratiques -->
                    <div class="form-section" style="border: 2px solid #3498db; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; background: #f8f9fa;">
                        <h3 style="margin-top: 0; color: #3498db; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-info-circle"></i> Informations pratiques
                        </h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="supplier-type">Type de fournisseur</label>
                                <select id="supplier-type">
                                    <option value="">S√©lectionner...</option>
                                    <option value="poissonnier">Poissonnier</option>
                                    <option value="boucher">Boucher</option>
                                    <option value="epicier">√âpicier</option>
                                    <option value="primeur">Primeur</option>
                                    <option value="cremier">Cr√©mer</option>
                                    <option value="boulanger">Boulanger</option>
                                    <option value="grossiste">Grossiste</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="supplier-isBio" style="margin-right: 0.5rem;">
                                    Produits bio
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="supplier-notes">Notes / Description</label>
                            <textarea id="supplier-notes" rows="3" placeholder="Informations compl√©mentaires sur votre activit√©..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Livraison gratuite -->
                    <div class="form-section" style="border: 2px solid #e67e22; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; background: #fff8f0;">
                        <h3 style="margin-top: 0; color: #e67e22; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-gift"></i> Livraison gratuite
                        </h3>
                        <p style="color: #7f8c8d; margin-bottom: 1rem; font-size: 0.9rem;">
                            Proposez la livraison gratuite √† partir d'un montant minimum de commande.
                        </p>
                        <div class="form-row">
                            <div class="form-group" style="flex: 0 0 auto; margin-right: 1rem; display: flex; align-items: center; padding-top: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                                    <input type="checkbox" id="free-delivery-enabled" style="width: auto; margin: 0;">
                                    <span>Activer la livraison gratuite</span>
                                </label>
                            </div>
                            <div class="form-group" id="free-delivery-threshold-group" style="display: none; flex: 1;">
                                <label for="free-delivery-threshold">Livraison gratuite √† partir de (‚Ç¨)</label>
                                <input type="number" id="free-delivery-threshold" min="0" step="0.01" placeholder="Ex: 50.00" style="width: 100%;">
                                <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">
                                    <i class="fas fa-info-circle"></i> Montant minimum de commande pour b√©n√©ficier de la livraison gratuite
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zones de livraison -->
                    <div class="form-section" style="border: 2px solid #e74c3c; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; background: #fff5f5;">
                        <h3 style="margin-top: 0; color: #e74c3c; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-truck"></i> Zones de livraison
                        </h3>
                        <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 1rem;">
                            D√©finissez les villes et codes postaux o√π vous pouvez livrer. Les notifications de promotions seront envoy√©es uniquement aux sites situ√©s dans ces zones.
                        </p>
                        
                        <div id="delivery-zones-list" style="margin-bottom: 1.5rem;">
                            <!-- Les zones seront ajout√©es ici dynamiquement -->
                        </div>
                        
                        <div style="border: 2px dashed #e74c3c; padding: 1rem; border-radius: 8px; background: white;">
                            <h4 style="margin-top: 0; color: #e74c3c;">Ajouter une zone de livraison</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="new-zone-city">Ville</label>
                                    <input type="text" id="new-zone-city" placeholder="Ex: Bruxelles" autocomplete="off">
                                    <small style="color: #7f8c8d; display: block; margin-top: 0.25rem;">
                                        <i class="fas fa-info-circle"></i> Commencez √† taper pour voir les suggestions
                                    </small>
                                </div>
                                <div class="form-group">
                                    <label for="new-zone-postalCode">Code postal</label>
                                    <input type="text" id="new-zone-postalCode" placeholder="Ex: 1000">
                                    <small style="color: #7f8c8d;">Si rempli, seule cette zone sera couverte. Sinon, toute la ville sera couverte.</small>
                                </div>
                                <div class="form-group" style="display: flex; align-items: flex-end;">
                                    <button type="button" id="add-delivery-zone-btn" class="btn btn-primary" style="width: 100%;">
                                        <i class="fas fa-plus"></i> Ajouter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" id="cancel-profile-btn" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer les modifications
                        </button>
                    </div>
                </form>
            </div>
        </div><!-- Fin onglet Mon Profil -->

    </div>

    <!-- Toast container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- üîí Helper CSRF (doit √™tre charg√© avant les autres scripts qui font des requ√™tes) -->
    <script type="module" src="js/csrf-helper.js"></script>
    
    <!-- üèôÔ∏è Autocomplete pour les villes (charg√© t√¥t pour √™tre disponible) -->
    <script src="js/city-autocomplete.js" type="module"></script>
    
    <script>
        // Fonction pour r√©cup√©rer l'utilisateur connect√© (depuis sessionStorage uniquement, pas localStorage)
        // ‚úÖ VALIDATION : Utiliser getStoredUser pour une validation stricte
        function getCurrentUser() {
            if (typeof getStoredUser === 'function') {
                return getStoredUser();
            }
            // Fallback si getStoredUser n'est pas disponible
            const user = sessionStorage.getItem('user');
            if (!user) return null;
            if (typeof safeJSONParse === 'function') {
                return safeJSONParse(user, null);
            }
            try {
                return JSON.parse(user);
            } catch {
                return null;
            }
        }

        console.log('üöÄ Chargement de supplier-dashboard.js');

        class SupplierDashboard {
            constructor() {
                console.log('üèóÔ∏è Construction de SupplierDashboard');
                this.deliveryZones = []; // Zones de livraison temporaires
                this.isDemoMode = false; // Mode d√©mo par d√©faut
                this.init();
                this.setupEventListeners();
            }

            async init() {
                // TOUJOURS v√©rifier avec le serveur pour garantir que l'utilisateur est toujours authentifi√©
                console.log('üîê V√©rification de l\'authentification avec le serveur...');
                
                let user = null;
                try {
                    console.log('üîç Appel /api/auth/me avec credentials: include...');
                    const response = await fetch('/api/auth/me', {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('üì° R√©ponse /api/auth/me:', response.status, response.statusText);
                    
                    if (response.status === 401) {
                        console.error('‚ùå Session expir√©e (401 Unauthorized)');
                        sessionStorage.removeItem('user');
                        // Ne PAS rediriger automatiquement - laisser l'utilisateur sur la page
                        // Ne pas utiliser redirectByRole car cela pourrait rediriger vers un autre dashboard
                        console.warn('‚ö†Ô∏è Session expir√©e - Affichage du message d\'erreur sans redirection');
                        // Afficher un message √† l'utilisateur mais ne pas rediriger
                        const errorMsg = document.createElement('div');
                        errorMsg.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #e74c3c; color: white; padding: 1rem; text-align: center; z-index: 10000;';
                        errorMsg.innerHTML = '‚ö†Ô∏è Votre session a expir√©. <a href="/index.html?sessionExpired=true" style="color: white; text-decoration: underline; margin-left: 1rem;">Se reconnecter</a>';
                        document.body.prepend(errorMsg);
                        return; // Arr√™ter l'initialisation
                    } else if (response.ok) {
                        const data = await response.json();
                        console.log('üì¶ Donn√©es re√ßues:', data);
                        user = data?.user || data;
                        
                        if (user) {
                            // Mettre √† jour sessionStorage uniquement (cache temporaire, pas localStorage)
                            // L'authentification r√©elle est g√©r√©e via cookie HTTP-Only c√¥t√© serveur
                            sessionStorage.setItem('user', JSON.stringify(user));
                            console.log('‚úÖ Utilisateur authentifi√©:', user.name || user.businessName, '- Role:', user.role, '- Roles:', user.roles);
                        } else {
                            console.warn('‚ö†Ô∏è Aucun utilisateur dans la r√©ponse');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è R√©ponse non-OK:', response.status);
                        // Essayer de r√©cup√©rer depuis sessionStorage comme fallback (cache temporaire)
                        user = getCurrentUser();
                        if (user) {
                            console.warn('‚ö†Ô∏è Utilisation des donn√©es en cache (sessionStorage)');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erreur lors de la v√©rification de l\'authentification:', error);
                    // En cas d'erreur r√©seau, essayer de r√©cup√©rer depuis sessionStorage comme fallback
                    user = getCurrentUser();
                    if (user) {
                        console.warn('‚ö†Ô∏è Utilisation des donn√©es en cache (sessionStorage) apr√®s erreur');
                    }
                }
                
                // V√©rifier l'authentification et le r√¥le
                console.log('üîç Utilisateur connect√©:', user);
                console.log('üîç Type de user:', typeof user);
                console.log('üîç user.role:', user?.role);
                console.log('üîç user.roles:', user?.roles);
                
                // V√©rifier si l'utilisateur est un fournisseur (v√©rifier √† la fois role et roles)
                // Les fournisseurs ont role='fournisseur' ET/OU roles=['SUPPLIER']
                const isSupplier = user && (
                    user.role === 'fournisseur' || 
                    (user.roles && (user.roles.includes('fournisseur') || user.roles.includes('SUPPLIER')))
                );
                
                console.log('üîç isSupplier:', isSupplier);
                
                if (!user) {
                    console.error('‚ùå Aucun utilisateur connect√© - Mode d√©mo activ√©');
                    // Mode d√©mo - permettre l'acc√®s m√™me sans authentification
                    document.getElementById('business-name').textContent = 'Mode D√©mo';
                    this.isDemoMode = true;
                } else if (!isSupplier) {
                    console.error('‚ùå R√¥le incorrect:', user.role, user.roles, 'attendu: fournisseur ou SUPPLIER - Mode d√©mo activ√©');
                    // Mode d√©mo - permettre l'acc√®s m√™me avec le mauvais r√¥le
                    document.getElementById('business-name').textContent = user.businessName || 'Mode D√©mo';
                    this.isDemoMode = true;
                } else {
                    console.log('‚úÖ Utilisateur fournisseur connect√©:', user.businessName);
                    // Afficher le nom de l'entreprise
                    document.getElementById('business-name').textContent = user.businessName;
                    this.isDemoMode = false;
                    
                    // Charger le profil fournisseur (inclut les zones de livraison)
                    if (typeof this.loadSupplierProfile === 'function') {
                        await this.loadSupplierProfile();
                    }
                }

                // Charger les donn√©es initiales (m√™me en mode d√©mo)
                await this.loadStats();
                await this.loadProducts();
                await this.loadOrders();
            }

            setupEventListeners() {
                console.log('üéØ Configuration des gestionnaires d\'√©v√©nements');
                
                // Gestion du formulaire d'ajout de produit
                const showAddProductBtn = document.getElementById('show-add-product');
                const addProductForm = document.getElementById('add-product-form');
                const cancelAddProductBtn = document.getElementById('cancel-add-product');
                const closeProductFormBtn = document.getElementById('close-product-form');
                
                console.log('üîç √âl√©ments trouv√©s:', {
                    showAddProductBtn: !!showAddProductBtn,
                    addProductForm: !!addProductForm,
                    cancelAddProductBtn: !!cancelAddProductBtn
                });

                if (showAddProductBtn) {
                    showAddProductBtn.addEventListener('click', () => {
                        console.log('üñ±Ô∏è Clic sur "Ajouter un Produit"');
                        addProductForm.classList.add('show');
                        // Activer l'auto-d√©tection de cat√©gorie
                        setTimeout(() => setupCategoryAutoDetect(), 100);
                    });
                }

                // Fermer le modal en cliquant sur le fond
                if (addProductForm) {
                    addProductForm.addEventListener('click', (e) => {
                        if (e.target === addProductForm) {
                            addProductForm.classList.remove('show');
                            addProductForm.reset();
                        }
                    });
                }

                if (cancelAddProductBtn) {
                    cancelAddProductBtn.addEventListener('click', () => {
                        console.log('üñ±Ô∏è Clic sur "Annuler"');
                        addProductForm.classList.remove('show');
                        addProductForm.reset();
                    });
                }

                if (closeProductFormBtn) {
                    closeProductFormBtn.addEventListener('click', () => {
                        console.log('üñ±Ô∏è Clic sur "Fermer (X)"');
                        addProductForm.classList.remove('show');
                        addProductForm.reset();
                    });
                }

                if (addProductForm) {
                    addProductForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        console.log('üìù Soumission du formulaire');
                        await this.handleAddProduct(e);
                    });
                }
                
                // Gestion du profil fournisseur
                const profileForm = document.getElementById('supplier-profile-form');
                const addDeliveryZoneBtn = document.getElementById('add-delivery-zone-btn');
                const cancelProfileBtn = document.getElementById('cancel-profile-btn');
                
                if (profileForm) {
                    profileForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.saveSupplierProfile();
                    });
                }
                
                if (addDeliveryZoneBtn) {
                    addDeliveryZoneBtn.addEventListener('click', () => {
                        this.addDeliveryZone();
                    });
                }
                
                if (cancelProfileBtn) {
                    cancelProfileBtn.addEventListener('click', () => {
                        this.loadSupplierProfile(); // Recharger les valeurs originales
                    });
                }

                // Bouton de test direct
                const testDirectBtn = document.getElementById('test-direct-btn');
                if (testDirectBtn) {
                    testDirectBtn.addEventListener('click', () => {
                        console.log('üß™ Test direct - Affichage du formulaire');
                        addProductForm.classList.add('show');
                        // Activer l'auto-d√©tection de cat√©gorie
                        setTimeout(() => window.setupCategoryAutoDetect(), 100);
                    });
                }
            }

            async loadStats() {
                console.log('üìä Chargement des statistiques...');
                try {
                    const response = await fetch('/api/supplier/stats', {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('üìä Statistiques re√ßues:', result);
                        
                        if (result.success) {
                            document.getElementById('active-products-count').textContent = result.activeProducts || 0;
                            document.getElementById('pending-orders-count').textContent = result.pendingOrders || 0;
                            document.getElementById('active-clients-count').textContent = result.activeClients || 0;
                            const totalOrdersEl = document.getElementById('total-orders-count');
                            if (totalOrdersEl) {
                                totalOrdersEl.textContent = result.totalAmount || '0.00';
                            }
                        }
                    } else {
                        console.error('‚ùå Erreur lors du chargement des statistiques:', response.status);
                        // Valeurs par d√©faut
                        document.getElementById('active-products-count').textContent = '0';
                        document.getElementById('pending-orders-count').textContent = '0';
                        document.getElementById('active-clients-count').textContent = '0';
                    }
                } catch (error) {
                    console.error('‚ùå Erreur lors du chargement des statistiques:', error);
                    // Valeurs par d√©faut
                    document.getElementById('active-products-count').textContent = '0';
                    document.getElementById('pending-orders-count').textContent = '0';
                    document.getElementById('active-clients-count').textContent = '0';
                }
            }
            
            toggleClientsList() {
                const clientsSection = document.getElementById('clients-section');
                if (!clientsSection) {
                    console.error('‚ùå Section clients-section non trouv√©e');
                    return;
                }
                
                const isHidden = clientsSection.style.display === 'none' || !clientsSection.style.display;
                
                if (isHidden) {
                    clientsSection.style.display = 'block';
                    // Charger les clients si pas encore charg√©s
                    const clientsList = document.getElementById('clients-list');
                    if (clientsList && clientsList.querySelector('.loading-container')) {
                        this.loadClients();
                    } else if (clientsList && clientsList.children.length === 0) {
                        this.loadClients();
                    }
                } else {
                    clientsSection.style.display = 'none';
                }
            }
            
            async loadClients() {
                try {
                    const clientsList = document.getElementById('clients-list');
                    if (!clientsList) {
                        console.error('‚ùå clients-list non trouv√©');
                        return;
                    }
                    
                    // Afficher le loading
                    clientsList.innerHTML = '<div class="loading-container"><i class="fas fa-spinner fa-spin"></i> Chargement des clients...</div>';
                    
                    const response = await fetch('/api/suppliers/clients', {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('üë• Clients re√ßus:', result);
                        
                        if (result.success && result.data) {
                            const clients = result.data;
                            
                            // Mettre √† jour le compteur
                            document.getElementById('active-clients-count').textContent = clients.length;
                            
                            if (clients.length === 0) {
                                clientsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Aucun client pour le moment</p>';
                                return;
                            }
                            
                            // Afficher les clients
                            clientsList.innerHTML = clients.map(client => {
                                const stats = client.statistics || {};
                                const address = client.clientAddress || {};
                                const addressStr = address.street || address.city ? 
                                    `${address.street || ''} ${address.postalCode || ''} ${address.city || ''}`.trim() : 
                                    'Non renseign√©';
                                
                                return `
                                    <div class="client-card">
                                        <h3>${client.clientName || 'Client inconnu'}</h3>
                                        <p><strong>Email:</strong> ${client.clientEmail || 'N/A'}</p>
                                        <p><strong>T√©l√©phone:</strong> ${client.clientPhone || 'N/A'}</p>
                                        <p><strong>Adresse:</strong> ${addressStr}</p>
                                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                                            <p><strong>Total commandes:</strong> ${stats.totalOrders || 0}</p>
                                            <p><strong>Montant total:</strong> ${stats.totalAmount || '0.00'}‚Ç¨</p>
                                            <p><strong>En attente:</strong> ${stats.pendingOrders || 0} | <strong>Confirm√©es:</strong> ${stats.confirmedOrders || 0} | <strong>Livr√©es:</strong> ${stats.deliveredOrders || 0}</p>
                                            ${stats.firstOrderDate ? `<p><strong>Premi√®re commande:</strong> ${new Date(stats.firstOrderDate).toLocaleDateString('fr-FR')}</p>` : ''}
                                            ${stats.lastOrderDate ? `<p><strong>Derni√®re commande:</strong> ${new Date(stats.lastOrderDate).toLocaleDateString('fr-FR')}</p>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                            clientsList.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Aucun client pour le moment</p>';
                        }
                    } else {
                        console.error('‚ùå Erreur lors du chargement des clients:', response.status);
                        clientsList.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 2rem;">Erreur lors du chargement des clients</p>';
                    }
                } catch (error) {
                    console.error('‚ùå Erreur lors du chargement des clients:', error);
                    const clientsList = document.getElementById('clients-list');
                    if (clientsList) {
                        clientsList.innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 2rem;">Erreur lors du chargement des clients</p>';
                    }
                }
            }

            async loadProducts() {
                console.log('üì¶ Chargement des produits...');
                const productsGrid = document.getElementById('products-grid');
                
                try {
                    const response = await fetch('/api/products/mine', {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include' // üîê Envoie automatiquement le cookie
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('üì° R√©ponse API:', result);
                        
                        // ‚úÖ L'API retourne { success: true, count: X, data: [...] }
                        const products = result.data || result || [];
                        console.log('‚úÖ Produits extraits:', products);
                        
                        this.displayProducts(products);
                        
                        // Mettre √† jour le compteur
                        document.getElementById('active-products-count').textContent = products.length;
                    } else {
                        console.error('‚ùå Erreur lors du chargement des produits:', response.status);
                        if (productsGrid) {
                            productsGrid.innerHTML = '<p>Erreur lors du chargement des produits</p>';
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erreur lors du chargement des produits:', error);
                    if (productsGrid) {
                        productsGrid.innerHTML = '<p>Erreur lors du chargement des produits</p>';
                    }
                }
            }

            displayProducts(products) {
                const productsGrid = document.getElementById('products-grid');
                if (!productsGrid) return;

                if (products.length === 0) {
                    productsGrid.innerHTML = '<p>Aucun produit enregistr√©</p>';
                    return;
                }

                productsGrid.innerHTML = products.map(product => {
                    // D√©terminer la couleur du badge stock
                    const stock = product.stock || 0;
                    const stockAlert = product.stockAlert || 10;
                    let stockBadgeColor = '#27ae60'; // Vert par d√©faut
                    let stockBadgeText = `${stock} ${product.unit} en stock`;
                    let stockIcon = '<i class="fas fa-check-circle"></i>';
                    
                    if (stock === 0) {
                        stockBadgeColor = '#e74c3c'; // Rouge
                        stockBadgeText = 'Rupture de stock';
                        stockIcon = '<i class="fas fa-exclamation-triangle"></i>';
                    } else if (stock <= stockAlert) {
                        stockBadgeColor = '#f39c12'; // Orange
                        stockBadgeText = `${stock} ${product.unit} (stock bas)`;
                        stockIcon = '<i class="fas fa-exclamation-circle"></i>';
                    }
                    
                    return `
                        <div class="product-card">
                            <h3>${product.name}</h3>
                            <div style="background: ${stockBadgeColor}; color: white; padding: 0.5rem 1rem; border-radius: 20px; margin-bottom: 1rem; text-align: center; font-weight: 600;">
                                ${stockIcon} ${stockBadgeText}
                            </div>
                            <p><strong>Cat√©gorie:</strong> ${product.category}</p>
                            <p><strong>Prix:</strong> ${product.price}‚Ç¨/${product.unit}</p>
                            <p><strong>D√©lai:</strong> ${product.deliveryTime} jour(s)</p>
                            <p><strong>Commande min:</strong> ${product.minOrder} ${product.unit}</p>
                            <p><strong>Seuil d'alerte:</strong> ${stockAlert} ${product.unit}</p>
                            ${product.description ? `<p><strong>Description:</strong> ${product.description}</p>` : ''}
                            ${product.promo > 0 ? `<p><strong>Promotion:</strong> ${product.promo}%</p>` : ''}
                            <div class="product-actions">
                                <button onclick="updateProductStock('${product._id}', '${product.name}', ${stock}, '${product.unit}')" class="btn btn-primary" style="background-color: #3498db;">
                                    <i class="fas fa-boxes"></i> G√©rer stock
                                </button>
                                <button onclick="editProduct('${product._id}')" class="btn btn-secondary">Modifier</button>
                                <button onclick="deleteProduct('${product._id}')" class="btn btn-danger">Supprimer</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async loadOrders() {
                console.log('üìã Chargement des commandes...');
                const ordersList = document.getElementById('orders-list');
                if (!ordersList) {
                    console.error('‚ùå Element orders-list non trouv√©');
                    return;
                }

                try {
                    // V√©rifier l'authentification avant de charger les commandes
                    console.log('üîê V√©rification de l\'authentification...');
                    const authCheck = await fetch('/api/auth/me', {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!authCheck.ok) {
                        console.error('‚ùå Session expir√©e ou invalide');
                        ordersList.innerHTML = '<p style="color: #e74c3c; padding: 2rem; text-align: center;">Session expir√©e. <a href="/index.html?sessionExpired=true" style="color: #e74c3c; text-decoration: underline;">Cliquez ici pour vous reconnecter</a></p>';
                        // NE PAS rediriger automatiquement - laisser l'utilisateur choisir
                        return;
                    }
                    
                    const userData = await authCheck.json();
                    const user = userData?.user || userData;
                    console.log('‚úÖ Utilisateur authentifi√©:', user.role, user.roles);
                    
                    const response = await fetch('/api/orders/supplier', {
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        },
                        credentials: 'include' // üîê Envoie automatiquement le cookie
                    });

                    console.log('üì° R√©ponse API:', response.status, response.statusText);

                    if (response.ok) {
                        const result = await response.json();
                        const orders = result.data || [];
                        console.log('‚úÖ Commandes charg√©es:', orders.length);
                        this.displayOrders(orders);
                        
                        // Mettre √† jour le compteur
                        const pendingOrders = orders.filter(o => o.status === 'pending').length;
                        const pendingCountEl = document.getElementById('pending-orders-count');
                        if (pendingCountEl) {
                            pendingCountEl.textContent = pendingOrders;
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({ message: 'Erreur inconnue' }));
                        console.error('‚ùå Erreur lors du chargement des commandes:', response.status, errorData);
                        const errorMessage = errorData.message || errorData.error || `Erreur ${response.status}: ${response.statusText}`;
                        ordersList.innerHTML = `<p style="color: #e74c3c; padding: 2rem; text-align: center;">Erreur lors du chargement des commandes: ${errorMessage}</p>`;
                        
                        // Si erreur 401 ou 403, afficher un message sans redirection automatique
                        if (response.status === 401 || response.status === 403) {
                            console.warn('‚ö†Ô∏è Erreur d\'authentification - Session peut-√™tre expir√©e');
                            ordersList.innerHTML = `<p style="color: #e74c3c; padding: 2rem; text-align: center;">
                                ‚ö†Ô∏è Votre session a peut-√™tre expir√©. 
                                <a href="/index.html?sessionExpired=true" style="color: #e74c3c; text-decoration: underline; margin-left: 0.5rem;">Cliquez ici pour vous reconnecter</a>
                            </p>`;
                            // NE PAS rediriger automatiquement - laisser l'utilisateur choisir
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erreur lors du chargement des commandes:', error);
                    ordersList.innerHTML = `<p style="color: #e74c3c; padding: 2rem; text-align: center;">Erreur r√©seau: ${error.message}</p>`;
                }
            }

            displayOrders(orders) {
                const ordersList = document.getElementById('orders-list');
                if (!ordersList) return;

                if (orders.length === 0) {
                    ordersList.innerHTML = '<p style="text-align: center; padding: 2rem; color: #666;">Aucune commande re√ßue</p>';
                    return;
                }

                // Trier les commandes : les plus r√©centes en premier
                const sortedOrders = [...orders].sort((a, b) => {
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });

                ordersList.innerHTML = sortedOrders.map(order => {
                    const statusColors = {
                        'pending': '#f39c12',
                        'confirmed': '#3498db',
                        'prepared': '#9b59b6',
                        'shipped': '#3498db',
                        'delivered': '#27ae60',
                        'issue': '#e74c3c',
                        'cancelled': '#e74c3c'
                    };
                    
                    const statusLabels = {
                        'pending': 'En attente',
                        'confirmed': 'Confirm√©e',
                        'prepared': 'Pr√©par√©e',
                        'shipped': 'üì¶ Envoy√©e',
                        'delivered': '‚úÖ Livr√©e',
                        'issue': '‚ö†Ô∏è Probl√®me signal√©',
                        'cancelled': 'Annul√©e'
                    };
                    
                    const customerName = order.customer?.businessName || order.customer?.name || 'Client inconnu';
                    const orderDate = new Date(order.createdAt).toLocaleDateString('fr-FR');
                    const deliveryDate = order.delivery?.requestedDate ? 
                        new Date(order.delivery.requestedDate).toLocaleDateString('fr-FR') : 'Non sp√©cifi√©e';
                    
                    return `
                        <div class="order-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h3 style="margin: 0 0 0.5rem 0; color: #2c3e50;">Commande ${order.orderNumber}</h3>
                                    <p style="margin: 0; color: #666;"><strong>Client:</strong> ${customerName}</p>
                                    <p style="margin: 0; color: #666;"><strong>Date:</strong> ${orderDate}</p>
                                    <p style="margin: 0; color: #666;"><strong>Livraison:</strong> ${deliveryDate}</p>
                                </div>
                                <div>
                                    <span style="background: ${statusColors[order.status]}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9em;">
                                        ${statusLabels[order.status]}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="margin: 1rem 0; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">Articles command√©s:</h4>
                                ${order.items.map(item => `
                                    <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                        <span>${item.productName || item.product?.name || 'Produit'}</span>
                                        <span><strong>${item.quantity} ${item.unit}</strong> √ó ${item.unitPrice.toFixed(2)}‚Ç¨ = ${item.totalPrice.toFixed(2)}‚Ç¨</span>
                                    </div>
                                `).join('')}
                                <div style="border-top: 2px solid #ddd; margin-top: 0.5rem; padding-top: 0.5rem; display: flex; justify-content: space-between;">
                                    <strong>Total:</strong>
                                    <strong style="color: #27ae60; font-size: 1.2em;">${order.pricing.total.toFixed(2)}‚Ç¨</strong>
                                </div>
                            </div>
                            
                            ${order.notes?.customer ? `
                                <div style="margin: 1rem 0; padding: 0.75rem; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                                    <strong>Notes du client:</strong> ${order.notes.customer}
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                                ${order.status === 'pending' ? `
                                    <button onclick="updateOrderStatus('${order._id}', 'confirmed')" class="btn btn-primary">
                                        <i class="fas fa-check"></i> Confirmer
                                    </button>
                                ` : ''}
                                ${order.status === 'confirmed' ? `
                                    <button onclick="updateOrderStatus('${order._id}', 'preparing')" class="btn btn-primary">
                                        <i class="fas fa-hourglass-half"></i> En pr√©paration
                                    </button>
                                ` : ''}
                                ${order.status === 'preparing' ? `
                                    <button onclick="updateOrderStatus('${order._id}', 'shipped')" class="btn btn-primary" style="background-color: #3498db;">
                                        <i class="fas fa-shipping-fast"></i> Marquer comme envoy√©e
                                    </button>
                                ` : ''}
                                ${order.status === 'shipped' ? `
                                    <div style="padding: 0.5rem 1rem; background: #d1ecf1; border-radius: 4px; color: #0c5460;">
                                        <i class="fas fa-info-circle"></i> En attente de confirmation du client
                                    </div>
                                ` : ''}
                                ${order.status !== 'cancelled' && order.status !== 'delivered' && order.status !== 'shipped' && order.status !== 'issue' ? `
                                    <button onclick="cancelOrder('${order._id}')" class="btn btn-danger">
                                        <i class="fas fa-times"></i> Annuler
                                    </button>
                                ` : ''}
                                ${order.status === 'issue' ? `
                                    <div style="padding: 0.5rem 1rem; background: #f8d7da; border-radius: 4px; color: #721c24;">
                                        <i class="fas fa-exclamation-triangle"></i> Le client a signal√© un probl√®me
                                    </div>
                                ` : ''}
                                <button onclick="viewOrderDetails('${order._id}')" class="btn btn-secondary">
                                    <i class="fas fa-eye"></i> D√©tails
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async handleAddProduct(e) {
                console.log('üîÑ Tentative d\'ajout de produit...');
                
                // V√©rifier l'authentification avant d'ajouter le produit
                try {
                    console.log('üîê V√©rification de l\'authentification avant ajout...');
                    const authCheck = await fetch('/api/auth/me', {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!authCheck.ok) {
                        console.error('‚ùå Session expir√©e ou invalide');
                        // Afficher un message d'erreur sans redirection automatique
                        this.showToast('‚ö†Ô∏è Votre session a expir√©. Veuillez vous reconnecter.', 'error');
                        // NE PAS rediriger automatiquement - laisser l'utilisateur choisir
                        return;
                    }
                    
                    const userData = await authCheck.json();
                    const user = userData?.user || userData;
                    console.log('‚úÖ Utilisateur authentifi√©:', user.role, user.roles);
                    
                    // V√©rifier que l'utilisateur est bien un fournisseur
                    const isSupplier = user.role === 'fournisseur' || 
                                      user.role === 'SUPPLIER' ||
                                      (user.roles && Array.isArray(user.roles) && user.roles.some(r => 
                                        r === 'fournisseur' || r === 'SUPPLIER' || r === 'supplier'
                                      )) ||
                                      user.supplierId;
                    
                    if (!isSupplier) {
                        console.error('‚ùå Utilisateur n\'est pas un fournisseur');
                        this.showToast('Vous devez √™tre connect√© en tant que fournisseur pour ajouter des produits', 'error');
                        return;
                    }
                    
                    // Mettre √† jour sessionStorage avec les donn√©es fra√Æches
                    sessionStorage.setItem('user', JSON.stringify(user));
                    console.log('‚úÖ Session v√©rifi√©e et mise √† jour');
                } catch (authError) {
                    console.error('‚ùå Erreur lors de la v√©rification de l\'authentification:', authError);
                    this.showToast('Erreur de connexion. Veuillez r√©essayer.', 'error');
                    return;
                }
                
                // R√©cup√©rer les valeurs du formulaire
                const superPromoActive = document.getElementById('super-promo-active')?.checked || false;
                const toSaveActive = document.getElementById('to-save-active')?.checked || false;
                const promoValue = parseInt(document.getElementById('product-promo').value) || 0;
                // Utiliser la checkbox to-save-active si disponible, sinon le select product-save
                const saveProductValue = toSaveActive || (document.getElementById('product-save')?.value === 'true');
                
                const formData = {
                    name: document.getElementById('product-name').value,
                    category: document.getElementById('product-category').value,
                    price: parseFloat(document.getElementById('product-price').value),
                    unit: document.getElementById('product-unit').value,
                    deliveryTime: parseInt(document.getElementById('delivery-time').value),
                    minOrder: parseInt(document.getElementById('min-order').value),
                    description: document.getElementById('product-description').value,
                    promo: promoValue,
                    saveProduct: saveProductValue,
                    // Construire les objets superPromo et toSave correctement
                    superPromo: superPromoActive ? {
                        active: true,
                        promoPrice: document.getElementById('super-promo-price')?.value ? parseFloat(document.getElementById('super-promo-price').value) : null,
                        promoQuantity: document.getElementById('super-promo-quantity')?.value ? parseInt(document.getElementById('super-promo-quantity').value) : null,
                        endDate: document.getElementById('super-promo-end-date')?.value ? new Date(document.getElementById('super-promo-end-date').value) : null
                    } : {
                        active: false
                    },
                    toSave: saveProductValue ? {
                        active: true,
                        savePrice: document.getElementById('to-save-price')?.value ? parseFloat(document.getElementById('to-save-price').value) : null,
                        saveQuantity: document.getElementById('to-save-quantity')?.value ? parseInt(document.getElementById('to-save-quantity').value) : null,
                        expirationDate: document.getElementById('to-save-expiration')?.value ? new Date(document.getElementById('to-save-expiration').value) : null
                    } : {
                        active: false
                    }
                };

                console.log('üìù Donn√©es du formulaire:', formData);
                console.log('üìù Super Promo active:', superPromoActive);
                console.log('üìù Save Product:', saveProductValue);

                // Validation simple
                if (!formData.name || !formData.category || !formData.price || !formData.unit) {
                    alert('Veuillez remplir tous les champs obligatoires');
                    return;
                }

                // V√©rifier si c'est une √©dition ou une cr√©ation
                const form = document.getElementById('add-product-form');
                const productId = form?.dataset?.productId;
                const isEdit = !!productId;
                
                console.log('üîç V√©rification type de requ√™te:');
                console.log('   - productId:', productId);
                console.log('   - isEdit:', isEdit);
                console.log('   - M√©thode:', isEdit ? 'PUT' : 'POST');
                
                try {
                    const url = isEdit ? `/api/products/${productId}` : '/api/products';
                    const method = isEdit ? 'PUT' : 'POST';
                    
                    // ‚úÖ S√âCURIT√â : Utiliser fetchWithCSRF pour la protection CSRF
                    const fetchFn = (typeof window !== 'undefined' && window.fetchWithCSRF) ? window.fetchWithCSRF : fetch;
                    
                    console.log(`üåê Envoi ${method} vers ${url}`);
                    console.log('üì¶ Donn√©es envoy√©es:', formData);
                    
                    const response = await fetchFn(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include', // üîê Envoie automatiquement le cookie
                        body: JSON.stringify(formData)
                    });

                    console.log('üì° R√©ponse re√ßue:', response.status, response.statusText);

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
                        console.error('‚ùå Erreur lors de la requ√™te:', errorData);
                        throw new Error(errorData.message || errorData.error || `Erreur ${response.status}: ${response.statusText}`);
                    }

                    if (response.ok) {
                        const result = await response.json();
                        console.log(`‚úÖ Produit ${isEdit ? 'modifi√©' : 'ajout√©'}:`, result);
                        this.showToast(`Produit ${isEdit ? 'modifi√©' : 'ajout√©'} avec succ√®s !`, 'success');
                        
                        // Fermer et r√©initialiser le formulaire
                        const form = document.getElementById('add-product-form');
                        form.classList.remove('show');
                        form.reset();
                        
                        // IMPORTANT: Supprimer le productId du dataset pour √©viter les confusions
                        if (form.dataset.productId) {
                            delete form.dataset.productId;
                            console.log('üßπ productId supprim√© du dataset');
                        }
                        
                        // R√©initialiser le titre et le bouton
                        const titleEl = form.querySelector('h3');
                        const submitBtn = form.querySelector('button[type="submit"]');
                        if (titleEl) titleEl.textContent = 'Ajouter un nouveau produit';
                        if (submitBtn) submitBtn.textContent = 'Ajouter le produit';
                        
                        // R√©initialiser les checkboxes de promotion
                        const superPromoCheckbox = document.getElementById('super-promo-active');
                        const toSaveCheckbox = document.getElementById('to-save-active');
                        if (superPromoCheckbox) superPromoCheckbox.checked = false;
                        if (toSaveCheckbox) toSaveCheckbox.checked = false;
                        
                        await this.loadProducts(); // Recharger la liste
                    } else {
                        const errorData = await response.json().catch(() => ({ message: 'Erreur inconnue' }));
                        console.error('‚ùå Erreur lors de l\'ajout:', errorData);
                        const errorMessage = errorData.message || errorData.error || `Erreur ${response.status}: ${response.statusText}`;
                        this.showToast(`Erreur: ${errorMessage}`, 'error');
                        
                        // Si erreur 401 ou 403, v√©rifier la session
                        if (response.status === 401 || response.status === 403) {
                            console.warn('‚ö†Ô∏è Erreur d\'authentification - V√©rification de la session...');
                            const checkSession = await fetch('/api/auth/me', {
                                credentials: 'include'
                            });
                            if (!checkSession.ok) {
                                console.error('‚ùå Session expir√©e');
                                // Afficher un message d'erreur sans redirection automatique
                                this.showToast('‚ö†Ô∏è Votre session a expir√©. Veuillez vous reconnecter.', 'error');
                                // NE PAS rediriger automatiquement - laisser l'utilisateur choisir
                            } else {
                                const userData = await checkSession.json();
                                console.log('‚úÖ Session valide, utilisateur:', userData.user?.role, userData.user?.roles);
                                // Si la session est valide mais l'erreur persiste, c'est un probl√®me de permissions
                                this.showToast('Erreur de permissions. V√©rifiez que vous √™tes bien connect√© en tant que fournisseur.', 'error');
                            }
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erreur lors de l\'ajout:', error);
                    this.showToast(`Erreur: ${error.message || 'Erreur lors de l\'ajout du produit'}`, 'error');
                }
            }

            // ========== GESTION DU PROFIL FOURNISSEUR ==========
            
            async loadSupplierProfile() {
                try {
                    console.log('üìã Chargement du profil fournisseur...');
                    const response = await fetch('/api/suppliers/me', {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const supplier = data.data;
                        
                        console.log('‚úÖ Profil charg√©:', supplier);
                        
                        // Remplir le formulaire
                        const nameEl = document.getElementById('supplier-name');
                        const contactEl = document.getElementById('supplier-contact');
                        const emailEl = document.getElementById('supplier-email');
                        const phoneEl = document.getElementById('supplier-phone');
                        const streetEl = document.getElementById('supplier-address-street');
                        const cityEl = document.getElementById('supplier-address-city');
                        const postalCodeEl = document.getElementById('supplier-address-postalCode');
                        const countryEl = document.getElementById('supplier-address-country');
                        const typeEl = document.getElementById('supplier-type');
                        const isBioEl = document.getElementById('supplier-isBio');
                        const notesEl = document.getElementById('supplier-notes');
                        
                        if (nameEl) nameEl.value = supplier.name || '';
                        if (contactEl) contactEl.value = supplier.contact || '';
                        if (emailEl) emailEl.value = supplier.email || '';
                        if (phoneEl) phoneEl.value = supplier.phone || '';
                        if (streetEl) streetEl.value = supplier.address?.street || '';
                        if (cityEl) cityEl.value = supplier.address?.city || '';
                        if (postalCodeEl) postalCodeEl.value = supplier.address?.postalCode || '';
                        if (countryEl) countryEl.value = supplier.address?.country || 'Belgique';
                        if (typeEl) typeEl.value = supplier.type || '';
                        if (isBioEl) isBioEl.checked = supplier.isBio || false;
                        if (notesEl) notesEl.value = supplier.notes || '';
                        
                        // Charger les zones de livraison avec leurs r√®gles
                        this.deliveryZones = (supplier.deliveryZones || []).map(zone => ({
                            city: zone.city || '',
                            postalCode: zone.postalCode || '',
                            deliveryRules: zone.deliveryRules || {
                                freeDeliveryThreshold: null,
                                deliveryFee: 0,
                                currency: 'EUR'
                            }
                        }));
                        this.renderDeliveryZones();
                    } else {
                        console.error('‚ùå Erreur lors du chargement du profil');
                        this.showToast('Erreur lors du chargement du profil', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Erreur:', error);
                    this.showToast('Erreur lors du chargement du profil', 'error');
                }
            }

            addDeliveryZone() {
                // Emp√™cher l'ajout en mode d√©mo
                if (this.isDemoMode) {
                    this.showToast('Veuillez vous connecter pour ajouter des zones de livraison', 'error');
                    return;
                }
                
                const cityEl = document.getElementById('new-zone-city');
                const postalCodeEl = document.getElementById('new-zone-postalCode');
                
                if (!cityEl || !postalCodeEl) {
                    console.error('‚ùå Champs de zone de livraison non trouv√©s');
                    return;
                }
                
                const city = cityEl.value.trim();
                const postalCode = postalCodeEl.value.trim();
                
                if (!city && !postalCode) {
                    this.showToast('Veuillez renseigner au moins une ville ou un code postal', 'error');
                    return;
                }

                // V√©rifier si la zone existe d√©j√†
                const exists = this.deliveryZones.some(zone => 
                    zone.city === city && zone.postalCode === postalCode
                );

                if (exists) {
                    this.showToast('Cette zone de livraison existe d√©j√†', 'error');
                    return;
                }

                // Ajouter la zone avec r√®gles de livraison par d√©faut
                this.deliveryZones.push({
                    city: city || undefined,
                    postalCode: postalCode || undefined,
                    deliveryRules: {
                        freeDeliveryThreshold: null,
                        deliveryFee: 0,
                        currency: 'EUR'
                    }
                });

                // R√©initialiser les champs
                cityEl.value = '';
                postalCodeEl.value = '';

                // Re-rendre la liste
                this.renderDeliveryZones();
                this.showToast('Zone de livraison ajout√©e', 'success');
            }

            removeDeliveryZone(index) {
                this.deliveryZones.splice(index, 1);
                this.renderDeliveryZones();
                this.showToast('Zone de livraison supprim√©e', 'success');
            }

            renderDeliveryZones() {
                const container = document.getElementById('delivery-zones-list');
                if (!container) return;
                
                if (this.deliveryZones.length === 0) {
                    container.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">Aucune zone de livraison d√©finie</p>';
                    return;
                }
                
                container.innerHTML = this.deliveryZones.map((zone, index) => {
                    const city = zone.city || '';
                    const postalCode = zone.postalCode || '';
                    const deliveryRules = zone.deliveryRules || {};
                    const freeThreshold = deliveryRules.freeDeliveryThreshold || '';
                    const deliveryFee = deliveryRules.deliveryFee || '';
                    
                    return `
                        <div style="border: 1px solid #e74c3c; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                <!-- Colonne gauche : Ville et r√®gles de livraison -->
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                        <i class="fas fa-map-marker-alt" style="color: #e74c3c;"></i>
                                        <strong style="color: #2c3e50; font-size: 1rem;">
                                            ${city}${postalCode ? ` (${postalCode})` : ''}
                                        </strong>
                                    </div>
                                    
                                    <!-- R√®gles de livraison compactes -->
                                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 200px;">
                                            <label style="font-size: 0.85rem; color: #555; white-space: nowrap; min-width: 180px;">
                                                <i class="fas fa-gift" style="color: #e67e22; margin-right: 0.25rem;"></i>
                                                Livraison gratuite √† pd (‚Ç¨):
                                            </label>
                                            <input 
                                                type="number" 
                                                min="0" 
                                                step="0.01" 
                                                placeholder="Ex: 50" 
                                                value="${freeThreshold}"
                                                onchange="window.dashboard.updateDeliveryRule(${index}, 'freeDeliveryThreshold', this.value)"
                                                style="flex: 1; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; max-width: 100px;">
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 200px;">
                                            <label style="font-size: 0.85rem; color: #555; white-space: nowrap; min-width: 180px;">
                                                <i class="fas fa-euro-sign" style="color: #27ae60; margin-right: 0.25rem;"></i>
                                                Sinon frais (‚Ç¨):
                                            </label>
                                            <input 
                                                type="number" 
                                                min="0" 
                                                step="0.01" 
                                                placeholder="Ex: 5" 
                                                value="${deliveryFee}"
                                                onchange="window.dashboard.updateDeliveryRule(${index}, 'deliveryFee', this.value)"
                                                style="flex: 1; padding: 0.4rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; max-width: 100px;">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Bouton supprimer -->
                                <button type="button" class="btn btn-danger" onclick="window.dashboard.removeDeliveryZone(${index})" style="padding: 0.5rem 0.75rem; font-size: 0.85rem; align-self: flex-start;">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            updateDeliveryRule(zoneIndex, ruleKey, value) {
                if (!this.deliveryZones[zoneIndex]) return;
                
                if (!this.deliveryZones[zoneIndex].deliveryRules) {
                    this.deliveryZones[zoneIndex].deliveryRules = {};
                }
                
                if (ruleKey === 'freeDeliveryThreshold') {
                    this.deliveryZones[zoneIndex].deliveryRules.freeDeliveryThreshold = value && value > 0 ? parseFloat(value) : null;
                } else if (ruleKey === 'deliveryFee') {
                    this.deliveryZones[zoneIndex].deliveryRules.deliveryFee = value && value > 0 ? parseFloat(value) : 0;
                }
                
                console.log(`üìù R√®gle de livraison mise √† jour pour zone ${zoneIndex}:`, this.deliveryZones[zoneIndex].deliveryRules);
            }

            async saveSupplierProfile() {
                // Emp√™cher la sauvegarde en mode d√©mo
                if (this.isDemoMode) {
                    this.showToast('Veuillez vous connecter pour sauvegarder les modifications', 'error');
                    return;
                }
                
                try {
                    console.log('üíæ Sauvegarde du profil fournisseur...');
                    
                    const supplierData = {
                        name: document.getElementById('supplier-name')?.value || '',
                        contact: document.getElementById('supplier-contact')?.value || '',
                        email: document.getElementById('supplier-email')?.value || '',
                        phone: document.getElementById('supplier-phone')?.value || '',
                        address: {
                            street: document.getElementById('supplier-address-street')?.value || '',
                            city: document.getElementById('supplier-address-city')?.value || '',
                            postalCode: document.getElementById('supplier-address-postalCode')?.value || '',
                            country: document.getElementById('supplier-address-country')?.value || 'Belgique'
                        },
                        type: document.getElementById('supplier-type')?.value || '',
                        isBio: document.getElementById('supplier-isBio')?.checked || false,
                        notes: document.getElementById('supplier-notes')?.value || '',
                        deliveryZones: this.deliveryZones
                    };

                    console.log('üì¶ Donn√©es √† sauvegarder:', supplierData);

                    // üîí Utiliser fetchWithCSRF pour la protection CSRF
                    const fetchFn = (typeof window !== 'undefined' && window.fetchWithCSRF) ? window.fetchWithCSRF : fetch;
                    
                    const response = await fetchFn('/api/suppliers/me', {
                        method: 'PUT',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(supplierData)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ Profil sauvegard√©:', data);
                        console.log('üì¶ Zones de livraison sauvegard√©es:', data.data?.deliveryZones || []);
                        console.log('üì¶ Nombre de zones:', data.data?.deliveryZones?.length || 0);
                        
                        // Mettre √† jour les zones de livraison locales
                        if (data.data?.deliveryZones) {
                            this.deliveryZones = data.data.deliveryZones;
                            this.renderDeliveryZones();
                        }
                        
                        this.showToast('Profil sauvegard√© avec succ√®s', 'success');
                        
                        // Recharger le profil pour v√©rifier que tout est bien sauvegard√©
                        setTimeout(() => {
                            this.loadSupplierProfile();
                        }, 500);
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Erreur lors de la sauvegarde');
                    }
                } catch (error) {
                    console.error('‚ùå Erreur lors de la sauvegarde:', error);
                    this.showToast(error.message || 'Erreur lors de la sauvegarde', 'error');
                }
            }

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">${type === 'success' ? '‚úì' : '‚úó'}</div>
                    <div class="toast-message">${message}</div>
                `;
                const container = document.getElementById('toast-container');
                if (container) {
                    container.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                }
            }

            async initCityAutocomplete() {
                console.log('üöÄ initCityAutocomplete appel√©e');
                const cityInput = document.getElementById('new-zone-city');
                console.log('üîç Champ new-zone-city trouv√©?', !!cityInput);
                if (!cityInput) {
                    console.warn('‚ö†Ô∏è Champ new-zone-city non trouv√© pour l\'autocomplete');
                    console.warn('   Recherche de tous les inputs...');
                    const allInputs = document.querySelectorAll('input');
                    console.warn('   Inputs trouv√©s:', Array.from(allInputs).map(i => i.id || i.name || i.placeholder));
                    return;
                }
                
                console.log('üîç Initialisation de l\'autocomplete pour les villes...');
                
                // Fonction pour initialiser l'autocomplete
                const doInit = (initFn) => {
                    if (typeof initFn === 'function') {
                        console.log('‚úÖ Initialisation de l\'autocomplete...');
                        initFn('new-zone-city', (city) => {
                            console.log('Ville s√©lectionn√©e:', city);
                        });
                        return true;
                    }
                    return false;
                };
                
                // Essayer d'abord avec la fonction globale (si le script est d√©j√† charg√©)
                if (typeof window.initCityAutocomplete === 'function') {
                    console.log('‚úÖ Fonction globale initCityAutocomplete trouv√©e');
                    doInit(window.initCityAutocomplete);
                    return;
                }
                
                // Sinon, essayer d'importer le module
                try {
                    console.log('‚è≥ Import du module city-autocomplete.js...');
                    // Essayer plusieurs chemins possibles
                    let module = null;
                    try {
                        module = await import('./city-autocomplete.js');
                    } catch (e1) {
                        try {
                            module = await import('/js/city-autocomplete.js');
                        } catch (e2) {
                            module = await import('../js/city-autocomplete.js');
                        }
                    }
                    if (module && module.initCityAutocomplete) {
                        console.log('‚úÖ Module city-autocomplete.js import√©');
                        doInit(module.initCityAutocomplete);
                        // Aussi d√©finir la fonction globale pour les prochaines fois
                        window.initCityAutocomplete = module.initCityAutocomplete;
                    } else {
                        throw new Error('Fonction initCityAutocomplete non trouv√©e dans le module');
                    }
                } catch (error) {
                    console.error('‚ùå Erreur lors de l\'import du module:', error);
                    // Fallback: attendre que le script se charge
                    console.log('‚è≥ Tentative avec la fonction globale...');
                    let attempts = 0;
                    const maxAttempts = 30;
                    const retryInterval = setInterval(() => {
                        attempts++;
                        if (typeof window.initCityAutocomplete === 'function') {
                            clearInterval(retryInterval);
                            console.log('‚úÖ Autocomplete initialis√© apr√®s', attempts, 'tentative(s)');
                            doInit(window.initCityAutocomplete);
                        } else if (attempts >= maxAttempts) {
                            clearInterval(retryInterval);
                            console.error('‚ùå Impossible d\'initialiser l\'autocomplete apr√®s', maxAttempts, 'tentatives');
                        }
                    }, 100);
                }
            }

            /**
             * Charger les avis re√ßus par le fournisseur
             */
            async loadRatings() {
                const container = document.getElementById('ratings-container');
                const loading = document.getElementById('ratings-loading');
                
                if (!container) {
                    console.error('‚ùå Conteneur ratings-container non trouv√©');
                    return;
                }
                
                if (loading) loading.style.display = 'block';
                container.innerHTML = '';
                
                try {
                    // ‚úÖ VALIDATION : Utiliser getStoredUser pour une validation stricte
                    const user = typeof getStoredUser === 'function' ? getStoredUser() : null;
                    if (!user) {
                      console.warn('‚ö†Ô∏è Utilisateur non connect√©');
                      return;
                    }
                    console.log('üìä [loadRatings] User depuis getStoredUser:', user);
                    
                    if (!user || (!user._id && !user.supplierId)) {
                        console.warn('‚ö†Ô∏è [loadRatings] Aucun utilisateur trouv√© dans sessionStorage');
                        // Essayer de r√©cup√©rer depuis l'API
                        try {
                            const authResponse = await fetch('/api/auth/me', {
                                credentials: 'include',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            if (authResponse.ok) {
                                const authData = await authResponse.json();
                                const freshUser = authData.user || authData;
                                console.log('üìä [loadRatings] User r√©cup√©r√© depuis API:', freshUser);
                                if (freshUser) {
                                    sessionStorage.setItem('user', JSON.stringify(freshUser));
                                    Object.assign(user, freshUser);
                                }
                            }
                        } catch (authError) {
                            console.error('‚ùå [loadRatings] Erreur lors de la v√©rification auth:', authError);
                        }
                    }
                    
                    let supplierId = user.supplierId || user._id;
                    
                    console.log('üìä [loadRatings] SupplierId initial:', supplierId);
                    console.log('üìä [loadRatings] Environnement:', window.location.hostname);
                    console.log('üìä [loadRatings] URL compl√®te:', window.location.href);
                    
                    // Si pas d'ID direct, r√©cup√©rer le supplier via l'API
                    if (!supplierId) {
                        console.log('üìä [loadRatings] R√©cup√©ration du supplier via /api/suppliers/me...');
                        const supplierResponse = await fetch('/api/suppliers/me', {
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (supplierResponse.ok) {
                            const supplierData = await supplierResponse.json();
                            supplierId = supplierData.data?._id || supplierData._id;
                            console.log('üìä [loadRatings] SupplierId r√©cup√©r√©:', supplierId);
                        }
                    }
                    
                    if (!supplierId) {
                        throw new Error('ID fournisseur non trouv√©');
                    }
                    
                    console.log('üìä [loadRatings] Appel API pour r√©cup√©rer les avis avec supplierId:', supplierId);
                    const apiUrl = `/api/suppliers/ratings/supplier/${supplierId}`;
                    const fullUrl = `${window.location.origin}${apiUrl}`;
                    console.log('üìä [loadRatings] URL API relative:', apiUrl);
                    console.log('üìä [loadRatings] URL API compl√®te:', fullUrl);
                    console.log('üìä [loadRatings] Credentials:', 'include');
                    
                    const response = await fetch(apiUrl, {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        // Ajouter un cache-buster pour √©viter les probl√®mes de cache
                        cache: 'no-store'
                    });
                    
                    console.log('üìä [loadRatings] R√©ponse API:', response.status, response.statusText);
                    console.log('üìä [loadRatings] Response headers:', Object.fromEntries(response.headers.entries()));
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå [loadRatings] Erreur API - Status:', response.status);
                        console.error('‚ùå [loadRatings] Erreur API - Response:', errorText);
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch (e) {
                            errorData = { message: errorText };
                        }
                        throw new Error(errorData.message || `Erreur ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log('üìä [loadRatings] R√©sultat complet:', result);
                    console.log('üìä [loadRatings] result.success:', result.success);
                    console.log('üìä [loadRatings] result.data:', result.data);
                    
                    // V√©rifier que la structure de r√©ponse est correcte
                    if (!result.success) {
                        throw new Error(result.message || 'Erreur lors de la r√©cup√©ration des avis');
                    }
                    
                    const ratings = result.data?.ratings || [];
                    const averages = result.data?.averages || {
                        averageRating: 0,
                        count: 0,
                        priceAvg: 0,
                        deliveryAvg: 0,
                        qualityAvg: 0,
                        communicationAvg: 0,
                        packagingAvg: 0
                    };
                    
                    console.log('üìä [loadRatings] Nombre d\'avis:', ratings.length);
                    console.log('üìä [loadRatings] Type de ratings:', Array.isArray(ratings) ? 'Array' : typeof ratings);
                    console.log('üìä [loadRatings] Moyennes:', averages);
                    console.log('üìä [loadRatings] Environnement:', window.location.hostname);
                    
                    if (loading) loading.style.display = 'none';
                    
                    if (!ratings || ratings.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: #6c757d;">
                                <i class="fas fa-star" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                <h3 style="color: #2c3e50; margin-bottom: 1rem;">Aucun avis re√ßu pour le moment</h3>
                                <p style="margin-bottom: 1rem;">Vous n'avez pas encore re√ßu d'avis de la part de vos clients.</p>
                                <p style="font-size: 0.9rem; color: #95a5a6;">
                                    Les avis appara√Ætront ici une fois que vos clients auront laiss√© des commentaires sur vos produits et services.
                                </p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Afficher le r√©sum√©
                    container.innerHTML = `
                        <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; color: white;">
                            <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                                <div>
                                    <div style="font-size: 4rem; font-weight: 700; line-height: 1;">
                                        ${averages.averageRating.toFixed(1)}
                                    </div>
                                    <div style="margin-top: 0.5rem; font-size: 1.2rem; opacity: 0.9;">
                                        ${this.renderStars(averages.averageRating)}
                                    </div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem; opacity: 0.9;">
                                        Bas√© sur ${averages.count} avis
                                    </div>
                                    ${averages.priceAvg > 0 || averages.deliveryAvg > 0 || averages.qualityAvg > 0 ? `
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                            ${averages.priceAvg > 0 ? `
                                                <div>
                                                    <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.25rem;">Prix</div>
                                                    <div>${this.renderStars(averages.priceAvg)}</div>
                                                </div>
                                            ` : ''}
                                            ${averages.deliveryAvg > 0 ? `
                                                <div>
                                                    <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.25rem;">Livraison</div>
                                                    <div>${this.renderStars(averages.deliveryAvg)}</div>
                                                </div>
                                            ` : ''}
                                            ${averages.qualityAvg > 0 ? `
                                                <div>
                                                    <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.25rem;">Qualit√©</div>
                                                    <div>${this.renderStars(averages.qualityAvg)}</div>
                                                </div>
                                            ` : ''}
                                            ${averages.communicationAvg > 0 ? `
                                                <div>
                                                    <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.25rem;">Communication</div>
                                                    <div>${this.renderStars(averages.communicationAvg)}</div>
                                                </div>
                                            ` : ''}
                                            ${averages.packagingAvg > 0 ? `
                                                <div>
                                                    <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.25rem;">Emballage</div>
                                                    <div>${this.renderStars(averages.packagingAvg)}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="margin-bottom: 1rem; color: #2c3e50;">Avis d√©taill√©s</h3>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                ${ratings.map(rating => `
                                    <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5rem; background: white;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                            <div>
                                                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem; font-size: 1.1rem;">
                                                    ${rating.reviewer?.name || 'Anonyme'}
                                                    ${rating.site?.siteName ? ` - ${rating.site.siteName}` : ''}
                                                </div>
                                                <div style="color: #6c757d; font-size: 0.9rem;">
                                                    ${new Date(rating.createdAt).toLocaleDateString('fr-FR', { 
                                                        year: 'numeric', 
                                                        month: 'long', 
                                                        day: 'numeric' 
                                                    })}
                                                </div>
                                            </div>
                                            <div>
                                                ${this.renderStars(rating.overallRating)}
                                            </div>
                                        </div>
                                        
                                        ${rating.feedback?.positive || rating.feedback?.negative || rating.feedback?.suggestions ? `
                                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f0f0f0;">
                                                ${rating.feedback.positive ? `
                                                    <div style="margin-bottom: 0.75rem;">
                                                        <div style="font-weight: 600; color: #27ae60; margin-bottom: 0.5rem; font-size: 0.95rem;">
                                                            <i class="fas fa-thumbs-up"></i> Points positifs
                                                        </div>
                                                        <div style="color: #555; font-size: 0.95rem; line-height: 1.6;">${rating.feedback.positive}</div>
                                                    </div>
                                                ` : ''}
                                                ${rating.feedback.negative ? `
                                                    <div style="margin-bottom: 0.75rem; background: #fff5f5; padding: 1rem; border-radius: 6px; border-left: 4px solid #e74c3c;">
                                                        <div style="font-weight: 600; color: #e74c3c; margin-bottom: 0.5rem; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem;">
                                                            <i class="fas fa-thumbs-down"></i> 
                                                            <span>Points √† am√©liorer</span>
                                                            <span style="background: #e74c3c; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-left: auto;">
                                                                <i class="fas fa-lock" style="font-size: 0.7rem;"></i> Priv√©
                                                            </span>
                                                        </div>
                                                        <div style="color: #555; font-size: 0.95rem; line-height: 1.6;">${rating.feedback.negative}</div>
                                                    </div>
                                                ` : ''}
                                                ${rating.feedback.suggestions ? `
                                                    <div style="background: #f0f8ff; padding: 1rem; border-radius: 6px; border-left: 4px solid #3498db;">
                                                        <div style="font-weight: 600; color: #3498db; margin-bottom: 0.5rem; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem;">
                                                            <i class="fas fa-lightbulb"></i> 
                                                            <span>Suggestions</span>
                                                            <span style="background: #3498db; color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-left: auto;">
                                                                <i class="fas fa-lock" style="font-size: 0.7rem;"></i> Priv√©
                                                            </span>
                                                        </div>
                                                        <div style="color: #555; font-size: 0.95rem; line-height: 1.6;">${rating.feedback.suggestions}</div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('‚ùå [loadRatings] Erreur lors du chargement des avis:', error);
                    console.error('‚ùå [loadRatings] Stack:', error.stack);
                    if (loading) loading.style.display = 'none';
                    
                    let errorMessage = error.message || 'Erreur inconnue';
                    // Message plus d√©taill√© pour le d√©bogage
                    if (errorMessage.includes('404')) {
                        errorMessage = 'L\'endpoint API n\'a pas √©t√© trouv√©. V√©rifiez que le serveur est correctement configur√©.';
                    } else if (errorMessage.includes('403')) {
                        errorMessage = 'Vous n\'avez pas les permissions pour acc√©der √† cette ressource.';
                    } else if (errorMessage.includes('401')) {
                        errorMessage = 'Votre session a expir√©. Veuillez vous reconnecter.';
                    } else if (errorMessage.includes('NetworkError') || errorMessage.includes('Failed to fetch')) {
                        errorMessage = 'Erreur de connexion au serveur. V√©rifiez votre connexion internet.';
                    }
                    
                    container.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: #e74c3c;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3 style="color: #e74c3c; margin-bottom: 1rem;">Erreur lors du chargement des avis</h3>
                            <p style="margin-bottom: 1rem;">${errorMessage}</p>
                            <button onclick="window.dashboard.loadRatings()" class="btn btn-primary" style="margin-top: 1rem;">
                                <i class="fas fa-redo"></i> R√©essayer
                            </button>
                        </div>
                    `;
                }
            }

            /**
             * Rendre les √©toiles de notation
             */
            renderStars(rating) {
                const fullStars = Math.floor(rating);
                const hasHalfStar = rating % 1 >= 0.5;
                const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                
                let html = '';
                for (let i = 0; i < fullStars; i++) {
                    html += '<i class="fas fa-star" style="color: #f39c12;"></i>';
                }
                if (hasHalfStar) {
                    html += '<i class="fas fa-star-half-alt" style="color: #f39c12;"></i>';
                }
                for (let i = 0; i < emptyStars; i++) {
                    html += '<i class="far fa-star" style="color: #ddd;"></i>';
                }
                return html;
            }
        }

        // Fonctions globales pour les actions sur les produits
        window.editProduct = async function(productId) {
            console.log('‚úèÔ∏è Modification du produit:', productId);
            try {
                const response = await fetch(`/api/products/${productId}`, {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include' // üîê Envoie automatiquement le cookie
                });
                
                if (response.ok) {
                    const product = await response.json();
                    console.log('üìù Produit √† modifier:', product);
                    
                    // Pr√©-remplir le formulaire
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-category').value = product.category;
                    document.getElementById('product-price').value = product.price;
                    document.getElementById('product-unit').value = product.unit;
                    document.getElementById('delivery-time').value = product.deliveryTime;
                    document.getElementById('min-order').value = product.minOrder;
                    document.getElementById('product-description').value = product.description || '';
                    document.getElementById('product-promo').value = product.promo || 0;
                    document.getElementById('product-save').value = product.saveProduct ? 'true' : 'false';
                    
                    // Afficher le formulaire
                    document.getElementById('add-product-form').classList.add('show');
                    
                    // Changer le titre et le bouton
                    document.querySelector('#add-product-form h3').textContent = 'Modifier le produit';
                    document.querySelector('#add-product-form button[type="submit"]').textContent = 'Mettre √† jour';
                    
                    // Stocker l'ID pour la mise √† jour
                    document.getElementById('add-product-form').dataset.productId = productId;
                } else {
                    throw new Error('Erreur lors du chargement du produit');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la modification:', error);
                alert('Erreur lors du chargement du produit √† modifier');
            }
        };

        window.deleteProduct = async function(productId) {
            console.log('üóëÔ∏è Suppression du produit:', productId);
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce produit ?')) {
                return;
            }
            
            try {
                // üîí Utiliser fetchWithCSRF pour la protection CSRF
                const fetchFn = (typeof window !== 'undefined' && window.fetchWithCSRF) ? window.fetchWithCSRF : fetch;
                
                const response = await fetchFn(`/api/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include' // üîê Envoie automatiquement le cookie
                });
                
                if (response.ok) {
                    console.log('‚úÖ Produit supprim√©');
                    alert('Produit supprim√© avec succ√®s !');
                    
                    // Recharger la liste des produits
                    const dashboard = new SupplierDashboard();
                    await dashboard.loadProducts();
                } else {
                    throw new Error('Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la suppression:', error);
                alert('Erreur lors de la suppression du produit');
            }
        };

        // Fonctions globales pour g√©rer les commandes
        window.updateOrderStatus = async function(orderId, newStatus) {
            console.log('üîÑ Mise √† jour du statut de la commande:', orderId, newStatus);
            
            try {
                // üîí Utiliser fetchWithCSRF pour la protection CSRF
                const fetchFn = (typeof window !== 'undefined' && window.fetchWithCSRF) ? window.fetchWithCSRF : fetch;
                
                const response = await fetchFn(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // üîê Envoie automatiquement le cookie
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    console.log('‚úÖ Statut mis √† jour');
                    showSupplierToast('‚úÖ Statut de la commande mis √† jour !', 'success');
                    
                    // üíæ SAUVEGARDER l'onglet actuel avant le rechargement
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        const currentTab = activeTab.dataset.tab;
                        sessionStorage.setItem('supplier_active_tab', currentTab);
                        console.log(`üíæ Onglet actif sauvegard√©: ${currentTab}`);
                    }
                    
                    // üîÑ Recharger automatiquement avec un hard refresh apr√®s 2 secondes
                    setTimeout(() => {
                        console.log('üîÑ Rechargement automatique (hard refresh)...');
                        // Force un hard refresh en ajoutant un timestamp √† l'URL
                        window.location.href = window.location.href.split('?')[0] + '?refresh=' + Date.now();
                    }, 2000);
                } else {
                    throw new Error('Erreur lors de la mise √† jour du statut');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la mise √† jour:', error);
                showSupplierToast('Erreur lors de la mise √† jour du statut', 'error');
            }
        };

        window.cancelOrder = async function(orderId) {
            console.log('‚ùå Annulation de la commande:', orderId);
            
            if (!confirm('√ätes-vous s√ªr de vouloir annuler cette commande ?')) {
                return;
            }
            
            try {
                // üîí Utiliser fetchWithCSRF pour la protection CSRF
                const fetchFn = (typeof window !== 'undefined' && window.fetchWithCSRF) ? window.fetchWithCSRF : fetch;
                
                const response = await fetchFn(`/api/orders/${orderId}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include' // üîê Envoie automatiquement le cookie
                });
                
                if (response.ok) {
                    console.log('‚úÖ Commande annul√©e');
                    alert('Commande annul√©e');
                    
                    // Recharger les commandes
                    const dashboard = new SupplierDashboard();
                    await dashboard.loadOrders();
                } else {
                    throw new Error('Erreur lors de l\'annulation');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'annulation:', error);
                alert('Erreur lors de l\'annulation de la commande');
            }
        };

        window.viewOrderDetails = async function(orderId) {
            console.log('üëÅÔ∏è Affichage des d√©tails de la commande:', orderId);
            
            try {
                const response = await fetch(`/api/orders/${orderId}`, {
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include' // üîê Envoie automatiquement le cookie
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const order = result.data;
                    
                    // Cr√©er une modal avec les d√©tails
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                    modal.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 2px solid #ddd; padding-bottom: 1rem;">
                                <h2 style="margin: 0; color: #2c3e50;">D√©tails de la commande ${order.orderNumber}</h2>
                                <button onclick="this.closest('div[style*=fixed]').remove()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #666;">&times;</button>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="color: #2c3e50; margin-bottom: 0.5rem;">Informations client</h3>
                                <p><strong>Nom:</strong> ${order.customer?.businessName || order.customer?.name || 'N/A'}</p>
                                <p><strong>Email:</strong> ${order.customer?.email || 'N/A'}</p>
                                <p><strong>T√©l√©phone:</strong> ${order.customer?.phone || 'N/A'}</p>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="color: #2c3e50; margin-bottom: 0.5rem;">Livraison</h3>
                                <p><strong>Date souhait√©e:</strong> ${order.delivery?.requestedDate ? new Date(order.delivery.requestedDate).toLocaleDateString('fr-FR') : 'N/A'}</p>
                                ${order.delivery?.notes ? `<p><strong>Notes:</strong> ${order.delivery.notes}</p>` : ''}
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <h3 style="color: #2c3e50; margin-bottom: 0.5rem;">Articles</h3>
                                ${order.items.map(item => `
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
                                        <div>
                                            <strong>${item.productName}</strong>
                                            <br>
                                            <small>${item.quantity} ${item.unit} √ó ${item.unitPrice.toFixed(2)}‚Ç¨</small>
                                        </div>
                                        <div style="text-align: right;">
                                            <strong>${item.totalPrice.toFixed(2)}‚Ç¨</strong>
                                        </div>
                                    </div>
                                `).join('')}
                                <div style="display: flex; justify-content: space-between; padding: 1rem 0; border-top: 2px solid #ddd; margin-top: 0.5rem;">
                                    <strong style="font-size: 1.2em;">Total:</strong>
                                    <strong style="font-size: 1.2em; color: #27ae60;">${order.pricing.total.toFixed(2)}‚Ç¨</strong>
                                </div>
                            </div>
                            
                            ${order.notes?.customer ? `
                                <div style="background: #fff3cd; padding: 1rem; border-radius: 4px; border-left: 4px solid #ffc107;">
                                    <strong>Notes du client:</strong><br>
                                    ${order.notes.customer}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                } else {
                    throw new Error('Erreur lors du chargement des d√©tails');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des d√©tails:', error);
                alert('Erreur lors du chargement des d√©tails de la commande');
            }
        };

        // ========== GESTION DU STOCK DES PRODUITS ==========
        
        window.updateProductStock = function(productId, productName, currentStock, unit) {
            console.log('üì¶ Gestion du stock pour:', productName);
            
            // Cr√©er la modale de gestion du stock
            const modal = document.createElement('div');
            modal.id = 'stock-management-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
                    <h3 style="margin-top: 0; color: #3498db;">
                        <i class="fas fa-boxes"></i> G√©rer le stock - ${productName}
                    </h3>
                    
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
                        <p style="margin: 0; font-size: 0.9rem; color: #666;">Stock actuel</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 2rem; font-weight: bold; color: #2c3e50;">${currentStock} ${unit}</p>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Action</label>
                        <select id="stock-action" style="width: 100%; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px;">
                            <option value="add">Ajouter au stock</option>
                            <option value="remove">Retirer du stock</option>
                            <option value="set">D√©finir le stock</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Quantit√© (${unit})</label>
                        <input type="number" id="stock-quantity" min="0" step="1" value="10" style="width: 100%; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px; box-sizing: border-box;">
                    </div>
                    
                    <div id="new-stock-preview" style="background: #d1ecf1; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; border-left: 4px solid #3498db;">
                        <p style="margin: 0; font-size: 0.9rem; color: #0c5460;">Nouveau stock</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: bold; color: #3498db;">${currentStock} ${unit}</p>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="saveProductStock('${productId}', ${currentStock})" style="flex: 1; background-color: #27ae60; color: white; border: none; padding: 0.9rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-check"></i> Enregistrer
                        </button>
                        <button onclick="closeStockModal()" style="flex: 1; background-color: #e74c3c; color: white; border: none; padding: 0.9rem; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Mettre √† jour l'aper√ßu en temps r√©el
            const actionSelect = document.getElementById('stock-action');
            const quantityInput = document.getElementById('stock-quantity');
            const preview = document.getElementById('new-stock-preview');
            
            const updatePreview = () => {
                const action = actionSelect.value;
                const quantity = parseInt(quantityInput.value) || 0;
                let newStock = currentStock;
                
                if (action === 'add') {
                    newStock = currentStock + quantity;
                } else if (action === 'remove') {
                    newStock = Math.max(0, currentStock - quantity);
                } else if (action === 'set') {
                    newStock = quantity;
                }
                
                preview.innerHTML = `
                    <p style="margin: 0; font-size: 0.9rem; color: #0c5460;">Nouveau stock</p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: bold; color: #3498db;">${newStock} ${unit}</p>
                `;
            };
            
            actionSelect.addEventListener('change', updatePreview);
            quantityInput.addEventListener('input', updatePreview);
        };
        
        window.saveProductStock = async function(productId, currentStock) {
            const action = document.getElementById('stock-action').value;
            const quantity = parseInt(document.getElementById('stock-quantity').value) || 0;
            let newStock = currentStock;
            
            if (action === 'add') {
                newStock = currentStock + quantity;
            } else if (action === 'remove') {
                newStock = Math.max(0, currentStock - quantity);
            } else if (action === 'set') {
                newStock = quantity;
            }
            
            console.log(`üì¶ Mise √† jour du stock: ${currentStock} ‚Üí ${newStock}`);
            
            try {
                // üîí Utiliser fetchWithCSRF pour la protection CSRF
                const fetchFn = (typeof window !== 'undefined' && window.fetchWithCSRF) ? window.fetchWithCSRF : fetch;
                
                const response = await fetchFn(`/api/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ stock: newStock })
                });
                
                if (response.ok) {
                    console.log('‚úÖ Stock mis √† jour');
                    closeStockModal();
                    showSupplierToast('‚úÖ Stock mis √† jour avec succ√®s !', 'success');
                    
                    // Recharger la liste des produits
                    if (window.dashboard && typeof window.dashboard.loadProducts === 'function') {
                        await window.dashboard.loadProducts();
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Erreur lors de la mise √† jour du stock');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la mise √† jour du stock:', error);
                showSupplierToast('Erreur lors de la mise √† jour du stock', 'error');
            }
        };
        
        window.closeStockModal = function() {
            const modal = document.getElementById('stock-management-modal');
            if (modal) modal.remove();
        };
        
        // ========== SYST√àME DE RAFRA√éCHISSEMENT AUTOMATIQUE FOURNISSEUR ==========
        // ‚ö†Ô∏è D√âSACTIV√â - Les notifications WebSocket remplacent ce syst√®me
        
        let supplierAutoRefreshInterval = null;
        let lastSupplierOrdersCheck = null;
        
        async function checkSupplierOrdersUpdates_DEPRECATED() {
            try {
                // Plus besoin de v√©rifier le token, il est dans le cookie
                const response = await fetch('/api/orders/supplier', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    },
                    credentials: 'include' // üîê Envoie automatiquement le cookie
                });

                if (response.ok) {
                    const result = await response.json();
                    const orders = result.data || [];
                    const currentOrdersMap = new Map(orders.map(o => [o._id, o.status]));
                    
                    // Si c'est la premi√®re v√©rification, enregistrer l'√©tat
                    if (lastSupplierOrdersCheck === null) {
                        lastSupplierOrdersCheck = currentOrdersMap;
                        console.log(`üîÑ [FOURNISSEUR] Premi√®re v√©rification - ${orders.length} commande(s) enregistr√©e(s)`);
                        return; // Ne pas afficher de notification pour les commandes existantes
                    }
                    
                    // D√©tecter les changements sp√©cifiques
                    let hasNewOrder = false;
                    let hasDeliveredOrder = false;
                    let hasIssueOrder = false;
                    let changedOrderNumber = null;
                    
                    // V√©rifier les nouvelles commandes
                    currentOrdersMap.forEach((status, id) => {
                        if (!lastSupplierOrdersCheck.has(id) && status === 'pending') {
                            hasNewOrder = true;
                            const order = orders.find(o => o._id === id);
                            changedOrderNumber = order?.orderNumber;
                        }
                    });
                    
                    // V√©rifier les changements de statut
                    currentOrdersMap.forEach((status, id) => {
                        const oldStatus = lastSupplierOrdersCheck.get(id);
                        if (oldStatus && oldStatus !== status) {
                            const order = orders.find(o => o._id === id);
                            changedOrderNumber = order?.orderNumber;
                            
                            if (status === 'delivered') {
                                hasDeliveredOrder = true;
                                console.log(`‚úÖ Commande ${changedOrderNumber} confirm√©e par le client`);
                            } else if (status === 'issue') {
                                hasIssueOrder = true;
                                console.log(`‚ö†Ô∏è Probl√®me signal√© sur commande ${changedOrderNumber}`);
                            }
                        }
                    });
                    
                    // Afficher les notifications appropri√©es
                    if (hasDeliveredOrder) {
                        showSupplierToast(`‚úÖ Commande ${changedOrderNumber} confirm√©e par le client`, 'success');
                    }
                    if (hasIssueOrder) {
                        showSupplierToast(`‚ö†Ô∏è Probl√®me signal√© sur commande ${changedOrderNumber}`, 'warning');
                    }
                    if (hasNewOrder) {
                        showSupplierToast(`üîî Nouvelle commande re√ßue: ${changedOrderNumber}`, 'info');
                    }
                    
                    // Mettre √† jour l'√©tat
                    if (hasNewOrder || hasDeliveredOrder || hasIssueOrder) {
                        lastSupplierOrdersCheck = currentOrdersMap;
                        
                        // Rafra√Æchir les commandes affich√©es
                        console.log('üîÑ Rechargement des commandes suite √† un changement d√©tect√©');
                        if (window.dashboard && typeof window.dashboard.loadOrders === 'function') {
                            await window.dashboard.loadOrders();
                        }
                    }
                    
                    // Toujours mettre √† jour lastSupplierOrdersCheck pour la prochaine v√©rification
                    lastSupplierOrdersCheck = currentOrdersMap;
                }
            } catch (error) {
                console.error('Erreur lors de la v√©rification des commandes:', error);
            }
        }
        
        // Fonction pour afficher un toast fournisseur (notification temporaire)
        function showSupplierToast(message, type = 'info') {
            const colors = {
                'success': '#27ae60',
                'warning': '#f39c12',
                'error': '#e74c3c',
                'info': '#3498db'
            };
            
            const icons = {
                'success': '‚úì',
                'warning': '‚ö†',
                'error': '‚úï',
                'info': 'üîî'
            };
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-weight: 500;
                animation: slideIn 0.3s ease, fadeOut 0.3s ease 4.7s;
            `;
            
            const icon = icons[type] || icons.info;
            toast.innerHTML = `
                <span style="font-size: 1.2rem;">${icon}</span>
                <span>${message}</span>
            `;
            
            // Ajouter les animations CSS si elles n'existent pas
            if (!document.getElementById('supplier-toast-animations')) {
                const style = document.createElement('style');
                style.id = 'supplier-toast-animations';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(400px); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // Supprimer automatiquement apr√®s 5 secondes
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        function showSupplierOrdersNotification() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #3498db;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                animation: slideIn 0.3s ease;
            `;
            toast.innerHTML = `
                <i class="fas fa-bell"></i>
                <span><strong>Nouvelle commande re√ßue!</strong> V√©rifiez vos commandes en attente.</span>
            `;
            
            document.body.appendChild(toast);
            
            // Mettre √† jour le compteur des commandes en attente
            const pendingBadge = document.getElementById('pending-orders-count');
            if (pendingBadge) {
                const currentCount = parseInt(pendingBadge.textContent) || 0;
                pendingBadge.textContent = currentCount + 1;
                pendingBadge.style.animation = 'pulse 1s 3';
            }
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        
        function startSupplierAutoRefresh_DEPRECATED(intervalSeconds = 15) {
            if (supplierAutoRefreshInterval) {
                clearInterval(supplierAutoRefreshInterval);
            }
            
            console.log(`üîÑ [FOURNISSEUR] D√©marrage du rafra√Æchissement automatique (toutes les ${intervalSeconds}s)`);
            
            // Premi√®re v√©rification imm√©diate
            checkSupplierOrdersUpdates();
            
            // Puis toutes les X secondes
            supplierAutoRefreshInterval = setInterval(checkSupplierOrdersUpdates, intervalSeconds * 1000);
        }

        // ========== AUTO-D√âTECTION DE CAT√âGORIE (GLOBALE) ==========
        
        window.detectCategory = function(productName) {
            const name = productName.toLowerCase().trim();
            
            // Dictionnaire de mots-cl√©s par cat√©gorie
            const categoryKeywords = {
                'fruits-legumes': [
                    'pomme', 'poire', 'banane', 'orange', 'citron', 'fraise', 'framboise', 'myrtille', 'cerise', 'abricot', 'p√™che', 'prune', 'raisin', 'melon', 'past√®que', 'kiwi', 'ananas', 'mangue', 'papaye',
                    'tomate', 'carotte', 'pomme de terre', 'oignon', 'ail', 'poireau', 'courgette', 'aubergine', 'poivron', 'concombre', 'salade', 'laitue', '√©pinard', 'brocoli', 'chou', 'navet', 'radis', 'betterave', 'c√©leri'
                ],
                'viandes': [
                    'b≈ìuf', 'boeuf', 'veau', 'porc', 'agneau', 'mouton', 'poulet', 'dinde', 'canard', 'lapin', 'steak', 'c√¥te', 'r√¥ti', 'filet', 'escalope', 'saucisse', 'merguez', 'jambon', 'lard', 'bacon'
                ],
                'poissons': [
                    'poisson', 'saumon', 'thon', 'cabillaud', 'lieu', 'dorade', 'bar', 'truite', 'maquereau', 'sardine', 'anchois', 'crevette', 'gambas', 'homard', 'crabe', 'moule', 'hu√Ætre', 'coquille', 'calmar', 'poulpe'
                ],
                'epicerie': [
                    'riz', 'p√¢tes', 'farine', 'sucre', 'sel', 'poivre', 'huile', 'vinaigre', 'moutarde', 'ketchup', 'mayonnaise', 'confiture', 'miel', 'chocolat', 'caf√©', 'th√©', 'c√©r√©ales', 'biscuit', 'conserve'
                ],
                'boissons': [
                    'eau', 'jus', 'soda', 'coca', 'limonade', 'sirop', 'vin', 'bi√®re', 'cidre', 'champagne', 'lait', 'boisson'
                ],
                'produits-laitiers': [
                    'lait', 'yaourt', 'fromage', 'beurre', 'cr√®me', 'gruy√®re', 'emmental', 'camembert', 'brie', 'ch√®vre', 'roquefort', 'mozzarella', 'parmesan'
                ],
                'boulangerie': [
                    'pain', 'baguette', 'croissant', 'brioche', 'viennoiserie', 'g√¢teau', 'tarte', 'p√¢tisserie'
                ]
            };
            
            // V√©rifier chaque cat√©gorie
            for (const [category, keywords] of Object.entries(categoryKeywords)) {
                for (const keyword of keywords) {
                    if (name.includes(keyword)) {
                        console.log(`‚úÖ Auto-d√©tection: "${productName}" ‚Üí ${category}`);
                        return category;
                    }
                }
            }
            
            console.log(`‚ùì Pas de cat√©gorie d√©tect√©e pour "${productName}" ‚Üí autres`);
            return 'autres';
        }
        
        // Ajouter l'auto-d√©tection au champ nom du produit
        let categoryAutoDetectActive = false;
        window.setupCategoryAutoDetect = function() {
            const productNameInput = document.getElementById('product-name');
            const categorySelect = document.getElementById('product-category');
            
            if (productNameInput && categorySelect && !categoryAutoDetectActive) {
                productNameInput.addEventListener('input', (e) => {
                    const productName = e.target.value;
                    if (productName.length >= 3) {
                        const detectedCategory = window.detectCategory(productName);
                        categorySelect.value = detectedCategory;
                        console.log(`üîç Cat√©gorie auto-d√©tect√©e: ${detectedCategory}`);
                    }
                });
                categoryAutoDetectActive = true;
                console.log('‚úÖ Auto-d√©tection de cat√©gorie activ√©e');
            } else if (categoryAutoDetectActive) {
                console.log('‚ÑπÔ∏è Auto-d√©tection d√©j√† active');
            }
        }

        // Initialiser le tableau de bord quand la page est charg√©e
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM charg√©, initialisation du dashboard');
            window.dashboard = new SupplierDashboard();
            window.supplierDashboard = window.dashboard; // Alias pour compatibilit√©
            
            // Gestionnaire d'√©v√©nements pour la carte "Clients Actifs"
            const clientsStatCard = document.getElementById('clients-stat-card');
            if (clientsStatCard) {
                clientsStatCard.addEventListener('click', () => {
                    if (window.dashboard && typeof window.dashboard.toggleClientsList === 'function') {
                        window.dashboard.toggleClientsList();
                    } else {
                        console.error('toggleClientsList non disponible');
                    }
                });
            }
            
            // Gestionnaire d'√©v√©nements pour le bouton "Fermer"
            const closeClientsBtn = document.getElementById('close-clients-btn');
            if (closeClientsBtn) {
                closeClientsBtn.addEventListener('click', () => {
                    if (window.dashboard && typeof window.dashboard.toggleClientsList === 'function') {
                        window.dashboard.toggleClientsList();
                    }
                });
            }
            
            // ========== GESTION DES ONGLETS ==========
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;
                    console.log(`üîÑ Changement d'onglet vers: ${targetTab}`);
                    
                    // üíæ SAUVEGARDER l'onglet actif dans sessionStorage
                    sessionStorage.setItem('supplier_active_tab', targetTab);
                    
                    // Retirer la classe active de tous les boutons
                    tabBtns.forEach(b => {
                        b.classList.remove('active');
                        b.style.borderBottom = '3px solid transparent';
                        b.style.color = '#2c3e50';
                    });
                    
                    // Ajouter la classe active au bouton cliqu√©
                    btn.classList.add('active');
                    btn.style.borderBottom = '3px solid #16a085';
                    btn.style.color = '#16a085';
                    
                    // Cacher tous les contenus d'onglets
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        content.style.display = 'none';
                    });
                    
                    // Afficher le contenu de l'onglet s√©lectionn√©
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        targetContent.style.display = 'block';
                        
                        // Charger les donn√©es sp√©cifiques √† l'onglet
                        if (targetTab === 'ratings' && window.dashboard) {
                            console.log('‚≠ê Onglet Avis Re√ßus activ√© - Chargement des avis...');
                            console.log('üîç window.dashboard.loadRatings existe?', typeof window.dashboard.loadRatings);
                            if (typeof window.dashboard.loadRatings === 'function') {
                                window.dashboard.loadRatings();
                            } else {
                                console.error('‚ùå window.dashboard.loadRatings n\'est pas une fonction');
                                console.error('   M√©thodes disponibles:', Object.keys(window.dashboard));
                            }
                        } else if (targetTab === 'profile' && window.dashboard) {
                            window.dashboard.loadSupplierProfile();
                            // Initialiser l'autocompl√©tion pour les villes apr√®s un court d√©lai
                            setTimeout(async () => {
                                console.log('üîÑ Tentative d\'initialisation de l\'autocompl√©tion...');
                                console.log('üîç window.dashboard existe?', !!window.dashboard);
                                console.log('üîç typeof window.dashboard.initCityAutocomplete?', typeof window.dashboard?.initCityAutocomplete);
                                if (window.dashboard && typeof window.dashboard.initCityAutocomplete === 'function') {
                                    console.log('‚úÖ Appel de initCityAutocomplete...');
                                    try {
                                        await window.dashboard.initCityAutocomplete();
                                    } catch (error) {
                                        console.error('‚ùå Erreur lors de l\'initialisation:', error);
                                    }
                                } else {
                                    console.error('‚ùå initCityAutocomplete non trouv√©e dans window.dashboard');
                                    console.error('   window.dashboard:', window.dashboard);
                                    console.error('   M√©thodes disponibles:', window.dashboard ? Object.keys(window.dashboard) : 'N/A');
                                }
                            }, 300);
                        }
                    }
                });
            });
            
            console.log(`‚úÖ ${tabBtns.length} onglet(s) configur√©(s)`);
            
            // üîÑ RESTAURER l'onglet sauvegard√© (si disponible)
            const savedTab = sessionStorage.getItem('supplier_active_tab');
            if (savedTab) {
                console.log(`üîÑ Restauration de l'onglet: ${savedTab}`);
                const savedBtn = document.querySelector(`[data-tab="${savedTab}"]`);
                if (savedBtn) {
                    // Simuler un clic pour activer l'onglet
                    savedBtn.click();
                }
            } else {
                // Si aucun onglet sauvegard√©, initialiser l'autocompl√©tion si l'onglet profile est actif par d√©faut
                const activeTab = document.querySelector('.tab-btn.active')?.dataset.tab;
                if (activeTab === 'profile' && window.dashboard) {
                    setTimeout(() => {
                        if (window.dashboard && typeof window.dashboard.initCityAutocomplete === 'function') {
                            window.dashboard.initCityAutocomplete();
                        }
                    }, 500);
                }
            }
            
            // Activer l'auto-d√©tection de cat√©gorie
            setTimeout(() => {
                window.setupCategoryAutoDetect();
            }, 500);
            
            // ‚ö†Ô∏è NE PLUS utiliser le rafra√Æchissement automatique par polling
            // Les notifications WebSocket sont maintenant instantan√©es
            // startSupplierAutoRefresh(5);
        });
    </script>
    
    <!-- üîî Syst√®me de notifications en temps r√©el -->
    <script src="js/notification-client.js"></script>
    <script type="module" src="js/session-sync.js"></script>
    <script>
        // Initialiser les notifications d√®s le chargement
        document.addEventListener('DOMContentLoaded', () => {
            // Le client se connecte automatiquement si un token est pr√©sent
            
            // Attendre que le client de notifications soit disponible
            const initNotifications = () => {
                if (!window.notificationClient) {
                    console.log('‚è≥ En attente du client de notifications...');
                    setTimeout(initNotifications, 500);
                    return;
                }
                
                console.log('üîî Configuration des gestionnaires de notifications fournisseur');
                
                // Nouvelle commande re√ßue
                window.notificationClient.on('new_order', (notification) => {
                    console.log('üõí NOUVELLE COMMANDE RE√áUE (WebSocket)!', notification);
                    
                    // üîî JOUER LE SON DE NOTIFICATION
                    if (window.notificationClient && typeof window.notificationClient.playSound === 'function') {
                        console.log('   üîä Lecture du son de notification...');
                        window.notificationClient.playSound();
                    } else {
                        console.warn('   ‚ö†Ô∏è notificationClient.playSound non disponible');
                    }
                    
                    // Afficher un toast de notification
                    if (window.dashboard && typeof window.dashboard.showToast === 'function') {
                        window.dashboard.showToast(
                            `üîî Nouvelle commande re√ßue: ${notification.data?.orderNumber || 'N/A'}`,
                            'info'
                        );
                    }
                    
                    // Recharger IMM√âDIATEMENT les commandes
                    if (window.dashboard && typeof window.dashboard.loadOrders === 'function') {
                        console.log('   ‚Üí Rechargement des commandes...');
                        window.dashboard.loadOrders();
                    }
                    
                    // Recharger les stats
                    if (window.dashboard && typeof window.dashboard.loadStats === 'function') {
                        console.log('   ‚Üí Rechargement des stats...');
                        window.dashboard.loadStats();
                    }
                    
                    // Faire vibrer l'onglet Commandes si pas actif
                    const ordersTab = document.querySelector('[data-tab="orders"]');
                    if (ordersTab) {
                        if (!ordersTab.classList.contains('active')) {
                            ordersTab.style.animation = 'pulse 1s 3';
                            setTimeout(() => {
                                ordersTab.style.animation = '';
                            }, 3000);
                        } else {
                            // Si d√©j√† sur l'onglet commandes, scroller vers la nouvelle commande
                            console.log('   ‚Üí D√©j√† sur l\'onglet commandes');
                        }
                    }
                });
                
                // Probl√®me signal√© sur une commande
                window.notificationClient.on('order_issue', (notification) => {
                    console.log('‚ö†Ô∏è PROBL√àME SIGNAL√â (WebSocket)!', notification);
                    
                    // Recharger les commandes
                    if (window.dashboard && typeof window.dashboard.loadOrders === 'function') {
                        window.dashboard.loadOrders();
                    }
                });
                
                // Changement de statut de commande (notamment quand le client confirme la r√©ception)
                window.notificationClient.on('order_status_change', (notification) => {
                    console.log('üîÑ CHANGEMENT DE STATUT DE COMMANDE (WebSocket)!', notification);
                    
                    // Si le nouveau statut est "delivered", c'est que le client a confirm√© la r√©ception
                    if (notification.data && notification.data.newStatus === 'delivered') {
                        console.log('‚úÖ R√©ception confirm√©e par le client - Rechargement des commandes...');
                        showSupplierToast('‚úÖ Le client a confirm√© la r√©ception de la commande !', 'success');
                    }
                    
                    // Recharger les commandes pour afficher le nouveau statut
                    if (window.dashboard && typeof window.dashboard.loadOrders === 'function') {
                        console.log('   ‚Üí Rechargement des commandes...');
                        window.dashboard.loadOrders();
                    }
                    
                    // Recharger les stats
                    if (window.dashboard && typeof window.dashboard.loadStats === 'function') {
                        console.log('   ‚Üí Rechargement des stats...');
                        window.dashboard.loadStats();
                    }
                });
                
                // Connexion √©tablie
                window.notificationClient.on('connected', () => {
                    console.log('‚úÖ Service de notifications en temps r√©el actif pour FOURNISSEUR');
                });
                
                // D√©connexion
                window.notificationClient.on('disconnected', () => {
                    console.warn('‚ö†Ô∏è Service de notifications d√©connect√©');
                });
                
                // Gestionnaire g√©n√©rique pour toutes les notifications
                window.notificationClient.on('notification', (notification) => {
                    console.log('üîî Notification g√©n√©rique re√ßue:', notification.type);
                    // Ce gestionnaire est appel√© pour toutes les notifications
                    // Les gestionnaires sp√©cifiques (new_order, etc.) sont appel√©s en premier
                });
                
                console.log('‚úÖ Gestionnaires de notifications configur√©s');
            };
            
            initNotifications();
        });
    </script>
    
    <script src="js/init.js"></script>
    <script src="js/supplier-barcode-lookup.js"></script>
</body>
</html>
