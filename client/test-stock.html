<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Stock - ChAIf SES</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 2rem; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 2rem; border-radius: 12px; }
        button { background-color: #27ae60; color: white; border: none; padding: 1rem 2rem; border-radius: 8px; cursor: pointer; font-size: 1rem; margin: 0.5rem; }
        button:hover { background-color: #229954; }
        .info { background: #e8f5e9; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
        .error { background: #ffebee; padding: 1rem; border-radius: 8px; margin: 1rem 0; color: #c62828; }
        #stock-table-body tr { border-bottom: 1px solid #ddd; }
        #stock-table-body td { padding: 1rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { background: #f5f5f5; padding: 1rem; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-vial"></i> Test Syst√®me de Stock</h1>
        
        <div class="info">
            <strong>üìã Instructions :</strong>
            <ol>
                <li>Connectez-vous d'abord sur <a href="index.html">index.html</a></li>
                <li>Revenez ici et cliquez sur "Tester la connexion"</li>
                <li>Cliquez sur "Ajouter un article test"</li>
                <li>Cliquez sur "Charger le stock"</li>
            </ol>
        </div>

        <div style="margin: 2rem 0;">
            <button onclick="testConnection()">
                <i class="fas fa-plug"></i> Tester la connexion
            </button>
            <button onclick="testAddStock()">
                <i class="fas fa-plus"></i> Ajouter un article test
            </button>
            <button onclick="testLoadStock()">
                <i class="fas fa-download"></i> Charger le stock
            </button>
        </div>

        <div id="result"></div>

        <h3>Stock actuel :</h3>
        <table>
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Cat√©gorie</th>
                    <th>Quantit√©</th>
                    <th>Unit√©</th>
                </tr>
            </thead>
            <tbody id="stock-table-body">
                <tr>
                    <td colspan="4" style="text-align: center; color: #999;">
                        Cliquez sur "Charger le stock"
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = isError ? 'error' : 'info';
            resultDiv.innerHTML = `<strong>${isError ? '‚ùå' : '‚úÖ'}</strong> ${message}`;
            console.log(message);
        }

        async function testConnection() {
            const token = localStorage.getItem('token');
            if (!token) {
                showResult('Aucun token trouv√©. Connectez-vous d\'abord sur index.html', true);
                return;
            }

            showResult(`Token trouv√© : ${token.substring(0, 30)}...`);

            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(`‚úÖ Connect√© en tant que : ${data.user?.name || 'Utilisateur'} (${data.user?.role || 'role inconnu'})`);
                } else {
                    showResult(`Token invalide ou expir√© (${response.status})`, true);
                }
            } catch (error) {
                showResult(`Erreur de connexion : ${error.message}`, true);
            }
        }

        async function testAddStock() {
            const token = localStorage.getItem('token');
            if (!token) {
                showResult('Connectez-vous d\'abord !', true);
                return;
            }

            showResult('üîÑ Ajout d\'un article test...');

            const testItem = {
                name: `Test Tomates ${Date.now()}`,
                category: 'legumes',
                quantity: 10,
                unit: 'kg',
                source: 'manual'
            };

            try {
                const response = await fetch('/api/stock', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testItem)
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult(`‚úÖ Article ajout√© : ${testItem.name} - ${testItem.quantity} ${testItem.unit}`);
                    testLoadStock(); // Recharger automatiquement
                } else {
                    const error = await response.json();
                    showResult(`Erreur ${response.status} : ${error.message || 'Erreur inconnue'}`, true);
                }
            } catch (error) {
                showResult(`Erreur : ${error.message}`, true);
            }
        }

        async function testLoadStock() {
            const token = localStorage.getItem('token');
            if (!token) {
                showResult('Connectez-vous d\'abord !', true);
                return;
            }

            showResult('üîÑ Chargement du stock...');

            try {
                const response = await fetch('/api/stock', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const stockData = result.data?.items || [];
                    showResult(`‚úÖ ${stockData.length} article(s) en stock`);

                    const tbody = document.getElementById('stock-table-body');
                    if (stockData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">Aucun article en stock</td></tr>';
                    } else {
                        tbody.innerHTML = stockData.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.category}</td>
                                <td style="font-weight: bold;">${item.quantity}</td>
                                <td>${item.unit}</td>
                            </tr>
                        `).join('');
                    }
                } else {
                    showResult(`Erreur ${response.status} lors du chargement`, true);
                }
            } catch (error) {
                showResult(`Erreur : ${error.message}`, true);
            }
        }
    </script>
</body>
</html>

