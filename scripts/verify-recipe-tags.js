// scripts/verify-recipe-tags.js
import mongoose from 'mongoose';
import RecipeEnriched from '../models/Recipe.js';
import dotenv from 'dotenv';

dotenv.config();

const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/chef-ses';

async function verifyRecipeTags() {
    try {
        console.log('üîå Connexion √† MongoDB...');
        await mongoose.connect(MONGODB_URI);
        console.log('‚úÖ Connect√© √† MongoDB\n');

        // R√©cup√©rer toutes les recettes
        const recipes = await RecipeEnriched.find({});
        console.log(`üìä Total de recettes: ${recipes.length}\n`);

        // Statistiques
        const stats = {
            total: recipes.length,
            withTags: 0,
            withoutTags: 0,
            withTexture: 0,
            withoutTexture: 0,
            withAgeGroup: 0,
            withoutAgeGroup: 0,
            withDiet: 0,
            withoutDiet: 0,
            withPathologies: 0,
            withoutPathologies: 0,
            byCategory: {},
            byTexture: {},
            byEstablishment: {
                cantine_scolaire: 0,
                ehpad: 0,
                hopital: 0,
                cantine_entreprise: 0
            }
        };

        const missingTagsRecipes = [];
        const wellTaggedRecipes = [];

        recipes.forEach(recipe => {
            // Tags
            if (recipe.tags && recipe.tags.length > 0) {
                stats.withTags++;
            } else {
                stats.withoutTags++;
            }

            // Texture
            if (recipe.texture && recipe.texture !== 'normale') {
                stats.withTexture++;
                stats.byTexture[recipe.texture] = (stats.byTexture[recipe.texture] || 0) + 1;
            } else {
                stats.withoutTexture++;
            }

            // Age Group
            if (recipe.ageGroup && (recipe.ageGroup.min || recipe.ageGroup.max)) {
                stats.withAgeGroup++;
            } else {
                stats.withoutAgeGroup++;
            }

            // Diet (restrictions alimentaires)
            if (recipe.diet && recipe.diet.length > 0) {
                stats.withDiet++;
            } else {
                stats.withoutDiet++;
            }

            // Pathologies
            if (recipe.pathologies && recipe.pathologies.length > 0) {
                stats.withPathologies++;
            } else {
                stats.withoutPathologies++;
            }

            // Par cat√©gorie
            const cat = recipe.category || 'unknown';
            stats.byCategory[cat] = (stats.byCategory[cat] || 0) + 1;

            // Par √©tablissement
            if (recipe.establishmentTypes) {
                recipe.establishmentTypes.forEach(type => {
                    if (stats.byEstablishment.hasOwnProperty(type)) {
                        stats.byEstablishment[type]++;
                    }
                });
            }

            // V√©rifier si la recette est "bien tagg√©e"
            const isWellTagged = 
                recipe.tags && recipe.tags.length > 0 &&
                recipe.texture &&
                recipe.category &&
                recipe.establishmentTypes && recipe.establishmentTypes.length > 0;

            if (!isWellTagged) {
                missingTagsRecipes.push({
                    name: recipe.name,
                    category: recipe.category || 'N/A',
                    tags: recipe.tags || [],
                    texture: recipe.texture || 'N/A',
                    establishmentTypes: recipe.establishmentTypes || [],
                    ageGroup: recipe.ageGroup || null,
                    diet: recipe.diet || [],
                    pathologies: recipe.pathologies || []
                });
            } else {
                wellTaggedRecipes.push(recipe.name);
            }
        });

        // Affichage des r√©sultats
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìä RAPPORT D\'ANALYSE DES TAGS DE RECETTES');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

        console.log('üìà STATISTIQUES GLOBALES:');
        console.log(`   Total recettes: ${stats.total}`);
        console.log(`   ‚úÖ Bien tagg√©es: ${wellTaggedRecipes.length}`);
        console.log(`   ‚ö†Ô∏è  Manque tags: ${missingTagsRecipes.length}`);
        console.log('');

        console.log('üè∑Ô∏è  TAGS:');
        console.log(`   ‚úÖ Avec tags: ${stats.withTags} (${(stats.withTags / stats.total * 100).toFixed(1)}%)`);
        console.log(`   ‚ùå Sans tags: ${stats.withoutTags} (${(stats.withoutTags / stats.total * 100).toFixed(1)}%)`);
        console.log('');

        console.log('ü•Ñ TEXTURES:');
        console.log(`   ‚úÖ Avec texture sp√©cifique: ${stats.withTexture}`);
        console.log(`   ‚ÑπÔ∏è  Texture normale: ${stats.withoutTexture}`);
        Object.entries(stats.byTexture).forEach(([texture, count]) => {
            console.log(`      - ${texture}: ${count}`);
        });
        console.log('');

        console.log('üë• GROUPES D\'√ÇGE:');
        console.log(`   ‚úÖ Avec ageGroup: ${stats.withAgeGroup}`);
        console.log(`   ‚ùå Sans ageGroup: ${stats.withoutAgeGroup}`);
        console.log('');

        console.log('üçΩÔ∏è  RESTRICTIONS ALIMENTAIRES:');
        console.log(`   ‚úÖ Avec diet: ${stats.withDiet}`);
        console.log(`   ‚ùå Sans diet: ${stats.withoutDiet}`);
        console.log('');

        console.log('üè• PATHOLOGIES:');
        console.log(`   ‚úÖ Avec pathologies: ${stats.withPathologies}`);
        console.log(`   ‚ùå Sans pathologies: ${stats.withoutPathologies}`);
        console.log('');

        console.log('üìÇ PAR CAT√âGORIE:');
        Object.entries(stats.byCategory).sort((a, b) => b[1] - a[1]).forEach(([cat, count]) => {
            console.log(`   ${cat}: ${count}`);
        });
        console.log('');

        console.log('üè¢ PAR √âTABLISSEMENT:');
        Object.entries(stats.byEstablishment).forEach(([type, count]) => {
            console.log(`   ${type}: ${count}`);
        });
        console.log('');

        if (missingTagsRecipes.length > 0) {
            console.log('‚ö†Ô∏è  RECETTES AVEC TAGS MANQUANTS (20 premi√®res):');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
            
            missingTagsRecipes.slice(0, 20).forEach((recipe, index) => {
                console.log(`${index + 1}. "${recipe.name}"`);
                console.log(`   Cat√©gorie: ${recipe.category}`);
                console.log(`   Tags: ${recipe.tags.length > 0 ? recipe.tags.join(', ') : '‚ùå AUCUN'}`);
                console.log(`   Texture: ${recipe.texture}`);
                console.log(`   √âtablissements: ${recipe.establishmentTypes.length > 0 ? recipe.establishmentTypes.join(', ') : '‚ùå AUCUN'}`);
                console.log(`   Age Group: ${recipe.ageGroup ? `${recipe.ageGroup.min}-${recipe.ageGroup.max}` : '‚ùå AUCUN'}`);
                console.log(`   Diet: ${recipe.diet.length > 0 ? recipe.diet.join(', ') : 'Aucune'}`);
                console.log(`   Pathologies: ${recipe.pathologies.length > 0 ? recipe.pathologies.join(', ') : 'Aucune'}`);
                console.log('');
            });

            if (missingTagsRecipes.length > 20) {
                console.log(`   ... et ${missingTagsRecipes.length - 20} autres recettes\n`);
            }
        }

        // Exemples de recettes bien tagg√©es
        console.log('‚úÖ EXEMPLES DE RECETTES BIEN TAGG√âES (5 premi√®res):');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
        
        const samplesWithDetails = await RecipeEnriched.find({
            _id: { $in: recipes.filter(r => 
                r.tags && r.tags.length > 0 &&
                r.texture &&
                r.establishmentTypes && r.establishmentTypes.length > 0
            ).slice(0, 5).map(r => r._id) }
        });

        samplesWithDetails.forEach((recipe, index) => {
            console.log(`${index + 1}. "${recipe.name}"`);
            console.log(`   Tags: ${recipe.tags.join(', ')}`);
            console.log(`   Texture: ${recipe.texture}`);
            console.log(`   Cat√©gorie: ${recipe.category}`);
            console.log(`   √âtablissements: ${recipe.establishmentTypes.join(', ')}`);
            if (recipe.ageGroup && (recipe.ageGroup.min || recipe.ageGroup.max)) {
                console.log(`   Age Group: ${recipe.ageGroup.min || 0}-${recipe.ageGroup.max || '99'} ans`);
            }
            if (recipe.diet && recipe.diet.length > 0) {
                console.log(`   Diet: ${recipe.diet.join(', ')}`);
            }
            if (recipe.pathologies && recipe.pathologies.length > 0) {
                console.log(`   Pathologies: ${recipe.pathologies.join(', ')}`);
            }
            console.log('');
        });

        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìã R√âSUM√â:');
        console.log(`   ${wellTaggedRecipes.length}/${stats.total} recettes bien tagg√©es (${(wellTaggedRecipes.length / stats.total * 100).toFixed(1)}%)`);
        
        if (missingTagsRecipes.length > 0) {
            console.log(`   ‚ö†Ô∏è  ${missingTagsRecipes.length} recettes n√©cessitent des am√©liorations`);
        } else {
            console.log('   ‚úÖ Toutes les recettes sont correctement tagg√©es !');
        }
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

        await mongoose.connection.close();
        console.log('‚úÖ Connexion ferm√©e');

    } catch (error) {
        console.error('‚ùå Erreur:', error);
        process.exit(1);
    }
}

// Ex√©cution
verifyRecipeTags();

