<!DOCTYPE html>
<html lang="fr">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EHPAD - ChAIf SES</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/components/modal.css">
  <link rel="stylesheet" href="css/utilities/common-styles.css">
  <link rel="stylesheet" href="css/utilities/accessibility.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Poppins', sans-serif; background-color: #f3e5f5; color: #333; line-height: 1.6; margin: 0; padding: 0; }
    .page-container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    header { background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%); color: #fff; padding: 1.5rem 2rem; border-radius: 12px; margin-bottom: 2.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
    header h1 { margin: 0; font-size: 1.8em; font-weight: 600; }
    .card { background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 2rem; }
    .card h2 { margin-top: 0; margin-bottom: 1.5rem; color: #2d3748; font-weight: 600; font-size: 1.4em; display: flex; align-items: center; }
    .card h2 i { margin-right: 0.75rem; color: #9c27b0; }
    /* ‚úÖ ACCESSIBILIT√â : Exception pour les headers avec fond color√© - texte blanc */
    .card-header-purple h2,
    .card-header-green h2,
    .card-header-purple .card-header-title,
    .card-header-green .card-header-title {
      color: #ffffff !important;
    }
    label { display: block; margin-bottom: 0.6rem; font-weight: 500; color: #495057; font-size: 0.9rem; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.8rem 1rem; border: 1px solid #ced4da; border-radius: 8px; box-sizing: border-box; font-family: 'Poppins', sans-serif; font-size: 0.95rem; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #9c27b0; box-shadow: 0 0 0 0.2rem rgba(156, 39, 176, 0.25); outline: none; }
    button { background-color: #9c27b0; color: white; border: none; padding: 0.9rem 1.8rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: background-color 0.3s ease, transform 0.1s ease; }
    button:hover { background-color: #7b1fa2; transform: translateY(-2px); }
    #logout-btn { background-color: #c0392b; font-size: 0.9rem; padding: 0.7rem 1.2rem; }
    
    .tab-navigation { display: flex; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); margin-bottom: 2rem; overflow: hidden; }
    .tab-btn { flex: 1; background: #f8f9fa; border: none; padding: 1rem 1.5rem; cursor: pointer; font-weight: 500; color: #6c757d; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .tab-btn:hover { background: #e9ecef; color: #495057; }
    .tab-btn.active { background: #9c27b0; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Styles pour les switches */
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #9c27b0;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #9c27b0;
    }
    
    /* Animations pour les toasts */
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <header>
      <div class="flex-center-gap">
        <i class="fas fa-heartbeat icon-large"></i>
        <div>
          <h1 id="site-name" class="m-0" style="font-size: 1.8em;">EHPAD</h1>
          <p id="group-name" class="m-0 text-label-sm opacity-90">Vulpia Group</p>
        </div>
      </div>
      <div class="flex-center-gap">
        <button onclick="showMyOrders()" style="background-color: #3498db; padding: 0.7rem 1.2rem; font-size: 0.9rem;">
          <i class="fas fa-receipt"></i> Mes Commandes
        </button>
        <div id="cart-badge" onclick="showCart()" class="relative flex-center-gap-sm" style="cursor: pointer; background: #27ae60; padding: 0.7rem 1rem; border-radius: 8px;">
          <i class="fas fa-shopping-cart icon-medium"></i>
          <span style="font-weight: 600;">Panier</span>
          <span id="cart-count" class="absolute" style="top: -8px; right: -8px; background: #e74c3c; color: white; border-radius: 50%; width: 24px; height: 24px; display: none; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">0</span>
        </div>
        <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> D√©connexion</button>
      </div>
    </header>

    <div class="tab-navigation">
      <button class="tab-btn active" data-tab="menus"><i class="fas fa-utensils"></i> Menus</button>
      <button class="tab-btn" data-tab="residents"><i class="fas fa-users"></i> R√©sidents</button>
      <button class="tab-btn" data-tab="recipe-generator"><i class="fas fa-magic"></i> G√©n√©rateur IA</button>
      <button class="tab-btn" data-tab="stock"><i class="fas fa-boxes"></i> Stock</button>
      <button class="tab-btn" data-tab="suppliers"><i class="fas fa-truck"></i> Fournisseurs</button>
      <button class="tab-btn" data-tab="supplier-comparison"><i class="fas fa-balance-scale"></i> Comparaison</button>
      <button class="tab-btn" data-tab="foodcost"><i class="fas fa-chart-line"></i> Food Cost</button>
      <button class="tab-btn" data-tab="settings"><i class="fas fa-cog"></i> Param√®tres</button>
    </div>

    <!-- Onglet Menus -->
    <div id="menus-tab" class="tab-content active">
      <!-- Calculateur de portions (au-dessus du g√©n√©rateur) -->
      <div class="card card-border-purple mb-1-5">
        <div class="card-header-purple">
          <h2 class="card-header-title">
            <i class="fas fa-scale-balanced"></i>
            Calculateur de portions
          </h2>
          <p class="text-subtitle">Renseignez le nombre de r√©sidents par type de portion. Nous calculons les portions √©quivalentes.</p>
        </div>
        <div class="grid-3-col mb-1">
          <div class="form-group">
            <label for="portion-normal">Portion normale (auto)</label>
            <input type="number" id="portion-normal" min="0" value="0" readonly>
          </div>
          <div class="form-group">
            <label for="portion-demi">Demi-portion (√ó0,5) (auto)</label>
            <input type="number" id="portion-demi" min="0" value="0" readonly>
          </div>
          <div class="form-group">
            <label for="portion-double">Double portion (√ó1.5) (auto)</label>
            <input type="number" id="portion-double" min="0" value="0" readonly>
          </div>
        </div>
        <div class="flex-wrap-between">
          <div class="flex-wrap">
            <div class="summary-box">
              <strong>Total r√©sidents:</strong>
              <span id="calc-total-residents">0</span>
            </div>
            <div class="summary-box-alt">
              <strong>Total portions √©quivalentes:</strong>
              <span id="calc-total-portions">0</span>
            </div>
          </div>
          <div class="button-group">
            <button id="calc-refresh" style="background:#9c27b0;">
              <i class="fas fa-rotate"></i> Recalculer depuis r√©sidents
            </button>
            <button id="calc-apply-to-generator" style="background:#9c27b0;">
              <i class="fas fa-arrow-down"></i> Appliquer au g√©n√©rateur
            </button>
            <button id="calc-reset" style="background:#6c757d;">
              R√©initialiser
            </button>
          </div>
        </div>
      </div>
      <!-- G√©n√©rateur IA Personnalis√© avec Crit√®res Nutritionnels -->
      <div class="card card-border-green mb-2">
        <div class="card-header-green">
          <h2 class="card-header-title"><i class="fas fa-flask"></i> G√©n√©rateur IA Personnalis√©</h2>
          <p class="text-subtitle-sm">Cr√©ez des menus sur-mesure avec des objectifs nutritionnels sp√©cifiques</p>
        </div>
        
        <form id="generate-custom-menu-form">
          <div class="grid-2-col mb-1-5">
            <div class="form-group">
              <label for="custom-menu-people"><i class="fas fa-users"></i> Nombre de personnes *</label>
              <input type="number" id="custom-menu-people" min="1" max="100" value="4" required>
            </div>
            <div class="form-group">
              <label for="custom-menu-type"><i class="fas fa-clock"></i> Type de repas *</label>
              <select id="custom-menu-type" required>
                <option value="d√©jeuner">D√©jeuner</option>
                <option value="d√Æner">D√Æner</option>
                <option value="petit-d√©jeuner">Petit-d√©jeuner</option>
                <option value="collation">Collation</option>
              </select>
            </div>
            <div class="form-group">
              <label for="custom-menu-period"><i class="fas fa-calendar-week"></i> P√©riode</label>
              <select id="custom-menu-period">
                <option value="1">Un jour</option>
                <option value="7">Semaine (7 jours)</option>
                <option value="30">Mois (30 jours)</option>
              </select>
            </div>
          </div>

          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;"><i class="fas fa-bullseye"></i> Objectifs Nutritionnels</label>
            <div id="nutritional-goals-container" style="background: #f9fafb; padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb;">
              <div id="nutritional-goals-list" style="margin-bottom: 1rem;">
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Aucun objectif ajout√©. Cliquez sur "Ajouter un objectif" ci-dessous.</p>
              </div>
              <button type="button" id="add-goal-btn" class="btn btn-outline" style="width: 100%; border-style: dashed; background: white; color: #10b981; border-color: #10b981;">
                <i class="fas fa-plus"></i> Ajouter un objectif nutritionnel
              </button>
            </div>
          </div>

          <div class="form-group" style="margin-bottom: 1.5rem;">
            <label for="custom-menu-restrictions"><i class="fas fa-ban"></i> Restrictions alimentaires (optionnel)</label>
            <select id="custom-menu-restrictions" multiple style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; min-height: 100px;">
              <option value="sans lactose">Sans lactose</option>
              <option value="sans gluten">Sans gluten</option>
              <option value="v√©g√©tarien">V√©g√©tarien</option>
              <option value="v√©g√©talien">V√©g√©talien</option>
              <option value="sans porc">Sans porc</option>
              <option value="sans arachides">Sans arachides</option>
              <option value="sans fruits √† coque">Sans fruits √† coque</option>
            </select>
            <small style="color: #6b7280;">Maintenez Ctrl (Cmd sur Mac) pour s√©lectionner plusieurs options</small>
          </div>

          <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #10b981;">
            <p style="margin: 0; color: #047857; font-size: 0.9rem;">
              <i class="fas fa-lightbulb"></i> 
              <strong>Exemples d'utilisation :</strong><br>
              ‚Ä¢ Menu riche en prot√©ines (35g) pour seniors<br>
              ‚Ä¢ Menu anti-an√©mie (Fer 10mg + Vitamine C 80mg)<br>
              ‚Ä¢ Menu sant√© osseuse (Calcium 800mg + Vitamine D 15¬µg)<br>
              ‚Ä¢ Menu digestif (Fibres 12g)<br>
              ‚Ä¢ Menu immunitaire (Vitamine C 100mg + Zinc 8mg)
            </p>
          </div>

          <!-- Suggestions rapides d'objectifs -->
          <div style="margin-bottom: 1rem;">
            <label style="font-weight: 600; margin-bottom: .5rem; display: block; color:#374151;">Suggestions rapides</label>
            <div id="quick-goal-suggestions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: .5rem;">
              <button type="button" class="btn btn-outline quick-goal" data-goals='[{"nutrient":"proteins","label":"Prot√©ines","target":35,"unit":"g"}]'>
                ü•© Riche en prot√©ines (35g)
              </button>
              <button type="button" class="btn btn-outline quick-goal" data-goals='[{"nutrient":"iron","label":"Fer","target":10,"unit":"mg"},{"nutrient":"vitaminC","label":"Vitamine C","target":80,"unit":"mg"}]'>
                ü©∏ Anti-an√©mie (Fer 10mg + Vit C 80mg)
              </button>
              <button type="button" class="btn btn-outline quick-goal" data-goals='[{"nutrient":"calcium","label":"Calcium","target":800,"unit":"mg"},{"nutrient":"vitaminD","label":"Vitamine D","target":15,"unit":"¬µg"}]'>
                ü¶¥ Sant√© osseuse (Ca 800mg + Vit D 15¬µg)
              </button>
              <button type="button" class="btn btn-outline quick-goal" data-goals='[{"nutrient":"fibers","label":"Fibres","target":12,"unit":"g"}]'>
                üåæ Digestif (Fibres 12g)
              </button>
              <button type="button" class="btn btn-outline quick-goal" data-goals='[{"nutrient":"vitaminC","label":"Vitamine C","target":100,"unit":"mg"},{"nutrient":"zinc","label":"Zinc","target":8,"unit":"mg"}]'>
                üõ°Ô∏è Immunit√© (Vit C 100mg + Zinc 8mg)
              </button>
              <button type="button" class="btn btn-outline quick-goal" data-goals='[{"nutrient":"calories","label":"Calories","target":500,"unit":"kcal"},{"nutrient":"proteins","label":"Prot√©ines","target":25,"unit":"g"}]'>
                ‚öñÔ∏è √ânergie l√©g√®re (500 kcal + 25g prot)
              </button>
              <button type="button" class="btn btn-outline quick-goal" data-goals='[{"nutrient":"calories","label":"Calories","target":800,"unit":"kcal"},{"nutrient":"proteins","label":"Prot√©ines","target":35,"unit":"g"}]'>
                üîã √ânergie √©lev√©e (800 kcal + 35g prot)
              </button>
              <button type="button" class="btn btn-outline quick-goal" data-goals='[{"nutrient":"carbs","label":"Glucides","target":50,"unit":"g"},{"nutrient":"fibers","label":"Fibres","target":10,"unit":"g"}]'>
                üçû Diab√®te (Glucides 50g + Fibres ‚â•10g)
              </button>
            </div>
          </div>

          <div id="custom-menu-progress" style="display: none; background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: #92400e;"></i>
            <p style="margin: 0.5rem 0 0 0; color: #92400e; font-weight: 600;">G√©n√©ration en cours...</p>
            <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.85rem;" id="custom-progress-text">Analyse des ingr√©dients disponibles...</p>
          </div>

          <button type="submit" style="width: 100%; padding: 1rem; font-size: 1.1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none;">
            <i class="fas fa-flask"></i> G√©n√©rer le menu personnalis√©
          </button>
        </form>

        <div id="custom-menu-results" style="display: none; margin-top: 2rem;"></div>

        <div id="generated-menus-list" style="margin-top: 2rem; display: none;">
          <h3 style="margin-bottom: 1rem; color: #374151;"><i class="fas fa-list"></i> Menus g√©n√©r√©s r√©cemment</h3>
          <div id="generated-menus-container" style="display: grid; gap: 1rem;"></div>
        </div>
        
        <!-- Bouton pour g√©n√©rer menu pour tous les r√©sidents -->
        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
          <button id="generate-menu-all-residents-btn" style="background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%); color: white; padding: 1rem 2rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
            <i class="fas fa-users"></i>
            G√©n√©rer menu pour tous les r√©sidents
          </button>
        </div>
      </div>
    </div>

    <!-- Onglet Stock -->
    <div id="stock-tab" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-boxes"></i> Gestion du Stock - EHPAD</h2>
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
          <button id="add-stock-item-btn"><i class="fas fa-plus"></i> Ajouter un article</button>
          <button id="refresh-stock-btn" style="background-color: #3498db;"><i class="fas fa-sync"></i> Actualiser</button>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
          <input type="text" id="stock-search" placeholder="Rechercher..." style="flex: 1; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px;">
          <select id="stock-category-filter" style="padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px;">
            <option value="">Toutes les cat√©gories</option>
            <option value="legumes">L√©gumes</option>
            <option value="viandes">Viandes</option>
            <option value="poissons">Poissons</option>
            <option value="produits-laitiers">Produits laitiers</option>
            <option value="cereales">C√©r√©ales</option>
            <option value="fruits">Fruits</option>
            <option value="epices">√âpices</option>
            <option value="boissons">Boissons</option>
            <option value="autres">Autres</option>
          </select>
        </div>

        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
              <th style="padding: 1rem; text-align: left;">Nom</th>
              <th style="padding: 1rem; text-align: left;">Cat√©gorie</th>
              <th style="padding: 1rem; text-align: center;">Quantit√©</th>
              <th style="padding: 1rem; text-align: center;">Seuil d'alerte</th>
              <th style="padding: 1rem; text-align: center;">Prix d'achat</th>
              <th style="padding: 1rem; text-align: center;">Expiration</th>
              <th style="padding: 1rem; text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="stock-table-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Onglet Fournisseurs -->
    <div id="suppliers-tab" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-truck"></i> Gestion des Fournisseurs</h2>
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
          <button id="add-supplier-btn"><i class="fas fa-plus"></i> Ajouter un fournisseur</button>
          <button id="refresh-suppliers-btn" style="background-color: #3498db;"><i class="fas fa-sync"></i> Actualiser</button>
        </div>
        <div id="suppliers-list"></div>
      </div>
    </div>

    <!-- Onglet Comparaison Fournisseurs -->
    <div id="supplier-comparison-tab" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-balance-scale"></i> Comparaison des Fournisseurs</h2>
        <p style="color: #6c757d; margin-bottom: 1.5rem;">
          Comparez les produits similaires entre vos fournisseurs disponibles. L'IA analyse automatiquement les produits et leurs prix pour vous aider √† faire le meilleur choix.
        </p>
        
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
          <button id="refresh-comparison-btn" style="background-color: #3498db;"><i class="fas fa-sync"></i> Actualiser</button>
          <button id="filter-comparison-btn" style="background-color: #6c757d;"><i class="fas fa-filter"></i> Filtrer</button>
        </div>

        <div id="comparison-loading" style="display: none; text-align: center; padding: 2rem;">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #9c27b0;"></i>
          <p>Analyse en cours...</p>
        </div>

        <div id="comparison-results"></div>
      </div>
    </div>

    <!-- Onglet R√©sidents -->
    <div id="residents-tab" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-users"></i> Gestion des R√©sidents</h2>
        
        <!-- R√©sum√© statistiques -->
        <div id="residents-summary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; display: none;">
          <h3 style="margin: 0 0 1rem 0; color: white; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-chart-pie"></i> R√©sum√© des R√©sidents
          </h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div style="background: rgba(255,255,255,0.3); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 0.9rem; opacity: 1; margin-bottom: 0.5rem; color: #ffffff; font-weight: 500;">Total R√©sidents</div>
              <div style="font-size: 2rem; font-weight: 700; color: #ffffff;" id="summary-total-residents">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.3); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 0.9rem; opacity: 1; margin-bottom: 0.5rem; color: #ffffff; font-weight: 500;">Total Portions</div>
              <div style="font-size: 2rem; font-weight: 700; color: #ffffff;" id="summary-total-portions">0</div>
            </div>
          </div>
          <div id="summary-allergies-restrictions" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 0.75rem;">
            <!-- Les allergies et restrictions seront g√©n√©r√©es dynamiquement -->
          </div>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
          <button id="add-resident-btn" style="background-color: #4caf50;">
            <i class="fas fa-user-plus"></i> Ajouter un r√©sident
          </button>
          <button id="refresh-residents-btn" style="background-color: #3498db;">
            <i class="fas fa-sync"></i> Actualiser
          </button>
          <button id="generate-menu-residents-btn" style="background-color: #9c27b0;">
            <i class="fas fa-magic"></i> G√©n√©rer menu pour s√©lection
          </button>
        </div>
        
        <!-- Filtres -->
        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
          <input type="text" id="resident-search" placeholder="Rechercher un r√©sident..." style="flex: 1; min-width: 200px; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px;">
          <select id="medical-filter" style="padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px;">
            <option value="">Toutes les conditions m√©dicales</option>
            <option value="diabete_type2">Diab√®te type 2</option>
            <option value="hypertension">Hypertension</option>
            <option value="dysphagie">Dysphagie</option>
            <option value="alzheimer">Alzheimer</option>
            <option value="parkinson">Parkinson</option>
            <option value="denutrition">D√©nutrition</option>
          </select>
          <select id="texture-filter" style="padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px;">
            <option value="">Toutes les textures</option>
            <option value="iddsi_7">IDDSI 7 - Normal</option>
            <option value="iddsi_6">IDDSI 6 - Morceaux tendres</option>
            <option value="iddsi_5">IDDSI 5 - Hach√© lubrifi√©</option>
            <option value="iddsi_4">IDDSI 4 - Pur√©e lisse</option>
            <option value="iddsi_3">IDDSI 3 - Pur√©e fluide</option>
            <option value="finger_food">Finger Food</option>
          </select>
        </div>
        
        <!-- Liste des r√©sidents -->
        <div id="residents-list">
          <!-- Les r√©sidents seront charg√©s dynamiquement -->
        </div>
      </div>
    </div>

    <!-- Onglet G√©n√©rateur de Recettes IA -->
    <div id="recipe-generator-tab" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-magic"></i> G√©n√©rateur de Recettes par IA</h2>
        <p style="color: #666; margin-bottom: 2rem;">
          G√©n√©rez de nouvelles recettes adapt√©es aux besoins sp√©cifiques de votre EHPAD
        </p>
        
        <!-- Formulaire de g√©n√©ration -->
        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
          <h3 style="margin-bottom: 1rem; color: #2c3e50;">Configuration de la g√©n√©ration</h3>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <!-- Contexte fixe pour EHPAD -->
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Contexte d'√©tablissement</label>
              <div style="padding: 0.8rem; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 8px; color: #2c3e50; font-weight: 600;">
                <i class="fas fa-hospital"></i> EHPAD
              </div>
              <input type="hidden" id="generator-context" value="ehpad">
            </div>
            
            <!-- Nombre de recettes -->
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Nombre de recettes</label>
              <input type="number" id="generator-count" value="5" min="1" max="20" style="width: 100%; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px;">
            </div>
          </div>
          
          <!-- Filtres -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <!-- Texture -->
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Texture (IDDSI)</label>
              <select id="generator-texture" style="width: 100%; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px;">
                <option value="iddsi_7">IDDSI 7 - Normal facile √† mastiquer</option>
                <option value="iddsi_6">IDDSI 6 - Petites morceaux tendres</option>
                <option value="iddsi_5">IDDSI 5 - Hach√© lubrifi√©</option>
                <option value="iddsi_4">IDDSI 4 - Pur√©e lisse</option>
                <option value="iddsi_3">IDDSI 3 - Pur√©e fluide</option>
                <option value="iddsi_2">IDDSI 2 - Liquide l√©g√®rement √©pais</option>
                <option value="iddsi_1">IDDSI 1 - Liquide tr√®s l√©g√®rement √©pais</option>
                <option value="iddsi_0">IDDSI 0 - Liquide</option>
                <option value="finger_food">Finger Food</option>
              </select>
            </div>
            
            <!-- Pathologies -->
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Pathologies</label>
              <select id="generator-pathologies" multiple style="width: 100%; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px; height: 100px;">
                <option value="diab√®te">Diab√®te</option>
                <option value="hypertension">Hypertension</option>
                <option value="insuffisance_r√©nale">Insuffisance r√©nale</option>
                <option value="dysphagie">Dysphagie</option>
                <option value="alzheimer">Alzheimer</option>
                <option value="parkinson">Parkinson</option>
                <option value="denutrition">D√©nutrition</option>
              </select>
            </div>
            
            <!-- R√©gimes alimentaires -->
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">R√©gimes alimentaires</label>
              <select id="generator-diet" multiple style="width: 100%; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px; height: 100px;">
                <option value="sans_sel">Sans sel ajout√©</option>
                <option value="hyperprot√©in√©">Hyperprot√©in√©</option>
                <option value="hypocalorique">Hypocalorique</option>
                <option value="v√©g√©tarien">V√©g√©tarien</option>
                <option value="sans_gluten">Sans gluten</option>
                <option value="sans_lactose">Sans lactose</option>
              </select>
            </div>
            
            <!-- Allerg√®nes -->
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Allerg√®nes √† √©viter</label>
              <select id="generator-allergens" multiple style="width: 100%; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px; height: 100px;">
                <option value="gluten">Gluten</option>
                <option value="lactose">Lactose</option>
                <option value="oeufs">≈íufs</option>
                <option value="arachides">Arachides</option>
                <option value="fruits_coque">Fruits √† coque</option>
                <option value="poisson">Poisson</option>
                <option value="crustac√©s">Crustac√©s</option>
              </select>
            </div>
          </div>
          
          <!-- Bouton de g√©n√©ration -->
          <button id="generate-recipes-btn" style="width: 100%; padding: 1rem; background: #9c27b0; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s;">
            <i class="fas fa-magic"></i> G√©n√©rer des recettes
          </button>
        </div>
        
        <!-- R√©sultats -->
        <div id="generated-recipes-results" style="display: none;">
          <h3 style="color: #2c3e50; margin-bottom: 1rem;">Recettes g√©n√©r√©es</h3>
          <div id="generated-recipes-list"></div>
        </div>
        
        <!-- Statistiques -->
        <div class="card" style="margin-top: 2rem;">
          <h3 style="color: #2c3e50; margin-bottom: 1rem;">Statistiques des recettes g√©n√©r√©es</h3>
          <div id="stats-content">
            <p>Chargement des statistiques...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Onglet Food Cost -->
    <div id="foodcost-tab" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-chart-line"></i> Suivi du Food Cost</h2>
        
        <!-- Statistiques globales -->
        <div id="foodcost-stats"></div>
        
        <!-- Actions -->
        <div style="display: flex; gap: 1rem; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
          <h3 style="margin: 0;"><i class="fas fa-calendar-alt"></i> P√©riodes de suivi</h3>
          <button id="create-period-btn" class="btn btn-primary">
            <i class="fas fa-plus"></i> Nouvelle p√©riode
          </button>
        </div>
        
        <!-- Liste des p√©riodes -->
        <div id="foodcost-periods" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
          <!-- Les p√©riodes seront charg√©es dynamiquement -->
        </div>
      </div>
    </div>

    <!-- Onglet Param√®tres -->
    <div id="settings-tab" class="tab-content">
      <div class="card">
        <h2><i class="fas fa-cog"></i> Param√®tres du Site</h2>
        <p style="color: #7f8c8d; margin-bottom: 2rem;">Configurez les informations de votre site et les pr√©f√©rences de notifications.</p>
        
        <form id="site-settings-form">
          <!-- Informations du site -->
          <div class="form-section" style="border: 2px solid #9c27b0; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; background: #f8f9fa;">
            <h3 style="margin-top: 0; color: #9c27b0; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-building"></i> Informations du Site
            </h3>
            
            <div class="form-group">
              <label for="site-name">Nom du site *</label>
              <input type="text" id="site-name" required placeholder="Ex: EHPAD Saint-Michel">
            </div>
            
            <div class="form-group">
              <label for="site-address-street">Adresse</label>
              <input type="text" id="site-address-street" placeholder="Rue et num√©ro">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label for="site-address-city">Ville</label>
                <input type="text" id="site-address-city" placeholder="Ville">
              </div>
              <div class="form-group">
                <label for="site-address-postalCode">Code postal</label>
                <input type="text" id="site-address-postalCode" placeholder="Code postal">
              </div>
              <div class="form-group">
                <label for="site-address-country">Pays</label>
                <input type="text" id="site-address-country" placeholder="Pays" value="Belgique">
              </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
              <div class="form-group">
                <label for="site-contact-phone">T√©l√©phone</label>
                <input type="tel" id="site-contact-phone" placeholder="+32 2 123 45 67">
              </div>
              <div class="form-group">
                <label for="site-contact-email">Email</label>
                <input type="email" id="site-contact-email" placeholder="contact@example.com">
              </div>
            </div>
          </div>
          
          <!-- Responsable -->
          <div class="form-section" style="border: 2px solid #3498db; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; background: #f8f9fa;">
            <h3 style="margin-top: 0; color: #3498db; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-user-tie"></i> Responsable
            </h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label for="responsable-name">Nom du responsable *</label>
                <input type="text" id="responsable-name" required placeholder="Nom complet">
              </div>
              <div class="form-group">
                <label for="responsable-phone">T√©l√©phone</label>
                <input type="tel" id="responsable-phone" placeholder="+32 2 123 45 67">
              </div>
              <div class="form-group">
                <label for="responsable-email">Email</label>
                <input type="email" id="responsable-email" placeholder="email@example.com">
              </div>
            </div>
            
            <div class="form-group" style="margin-top: 1rem;">
              <label for="responsable-position">Fonction</label>
              <input type="text" id="responsable-position" placeholder="Ex: Directeur, Responsable cuisine, etc.">
            </div>
          </div>
          
          <!-- Param√®tres de notifications -->
          <div class="form-section" style="border: 2px solid #e74c3c; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; background: #fff5f5;">
            <h3 style="margin-top: 0; color: #e74c3c; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-bell"></i> Notifications
            </h3>
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #ddd;">
                <div>
                  <label for="notification-badge" style="font-weight: 600; margin-bottom: 0.25rem; display: block;">
                    <i class="fas fa-badge-check" style="color: #3498db; margin-right: 0.5rem;"></i>
                    Badge de notification
                  </label>
                  <small style="color: #7f8c8d;">Afficher un badge sur les ic√¥nes lors de nouvelles notifications</small>
                </div>
                <label class="switch">
                  <input type="checkbox" id="notification-badge">
                  <span class="slider"></span>
                </label>
              </div>
              
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #ddd;">
                <div>
                  <label for="notification-sound" style="font-weight: 600; margin-bottom: 0.25rem; display: block;">
                    <i class="fas fa-volume-up" style="color: #e74c3c; margin-right: 0.5rem;"></i>
                    Sonnerie de notification
                  </label>
                  <small style="color: #7f8c8d;">Jouer un son lors de nouvelles notifications</small>
                </div>
                <label class="switch">
                  <input type="checkbox" id="notification-sound">
                  <span class="slider"></span>
                </label>
              </div>
              
              <div id="sound-volume-container" style="display: none; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #ddd;">
                <label for="sound-volume" style="font-weight: 600; margin-bottom: 0.5rem; display: block;">
                  <i class="fas fa-sliders-h" style="color: #e74c3c; margin-right: 0.5rem;"></i>
                  Volume du son (%)
                </label>
                <input type="range" id="sound-volume" min="0" max="100" value="50" style="width: 100%;">
                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.85rem; color: #7f8c8d;">
                  <span>0%</span>
                  <span id="sound-volume-value">50%</span>
                  <span>100%</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Boutons d'action -->
          <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
            <button type="button" id="cancel-settings-btn" style="background-color: #6c757d;">
              <i class="fas fa-times"></i> Annuler
            </button>
            <button type="submit" style="background-color: #9c27b0;">
              <i class="fas fa-save"></i> Enregistrer les modifications
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modale pour ajouter les objectifs nutritionnels -->
  <div id="add-nutritional-goal-modal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="margin: 0;">Ajouter un Objectif Nutritionnel</h3>
        <button class="modal-close" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Liste des objectifs d√©j√† ajout√©s -->
        <div id="modal-goals-list" style="margin-bottom: 1rem; display: none;">
          <h4 style="font-size: 0.95rem; color: #374151; margin-bottom: 0.5rem;">
            <i class="fas fa-check-circle" style="color: #10b981;"></i> Objectifs ajout√©s :
          </h4>
          <div id="modal-goals-container" style="background: #f0fdf4; padding: 0.75rem; border-radius: 6px; border: 1px solid #86efac; margin-bottom: 1rem;"></div>
        </div>
        
        <form id="add-nutritional-goal-form">
          <div class="form-group">
            <label for="goal-nutrient">Nutriment *</label>
            <select id="goal-nutrient" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
              <optgroup label="Prot√©ines & √ânergie">
                <option value="proteins">Prot√©ines (g)</option>
                <option value="calories">Calories (kcal)</option>
              </optgroup>
              <optgroup label="Vitamines">
                <option value="vitaminC">Vitamine C (mg)</option>
                <option value="vitaminD">Vitamine D (¬µg)</option>
                <option value="vitaminA">Vitamine A (¬µg)</option>
                <option value="vitaminE">Vitamine E (mg)</option>
                <option value="vitaminK">Vitamine K (¬µg)</option>
                <option value="vitaminB6">Vitamine B6 (mg)</option>
                <option value="vitaminB9">Vitamine B9 (¬µg)</option>
                <option value="vitaminB12">Vitamine B12 (¬µg)</option>
              </optgroup>
              <optgroup label="Min√©raux">
                <option value="iron">Fer (mg)</option>
                <option value="calcium">Calcium (mg)</option>
                <option value="magnesium">Magn√©sium (mg)</option>
                <option value="zinc">Zinc (mg)</option>
                <option value="phosphore">Phosphore (mg)</option>
                <option value="potassium">Potassium (mg)</option>
              </optgroup>
              <optgroup label="Autres">
                <option value="fibers">Fibres (g)</option>
                <option value="carbs">Glucides (g)</option>
                <option value="lipids">Lipides (g)</option>
              </optgroup>
            </select>
          </div>
          <div class="form-group">
            <label for="goal-target">Objectif par personne *</label>
            <input type="number" id="goal-target" min="0" step="0.1" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;" placeholder="Ex: 35">
          </div>
          <div style="background: #f3f4f6; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
            <p style="margin: 0; font-size: 0.85rem; color: #4b5563;">
              <strong>üí° Exemples de valeurs recommand√©es :</strong><br>
              ‚Ä¢ Prot√©ines : 25-40g<br>
              ‚Ä¢ Fer : 8-15mg<br>
              ‚Ä¢ Calcium : 800-1200mg<br>
              ‚Ä¢ Vitamine C : 80-120mg<br>
              ‚Ä¢ Fibres : 10-15g
            </p>
          </div>
        </form>
      </div>
      <div class="modal-footer" style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
        <button type="button" class="btn btn-secondary modal-close" style="background-color: #6c757d;">Annuler</button>
        <button type="submit" form="add-nutritional-goal-form" class="btn btn-outline" style="background: white; color: #10b981; border-color: #10b981;">
          <i class="fas fa-plus"></i> Ajouter un autre
        </button>
        <button type="button" id="add-goal-and-close-btn" class="btn btn-primary" style="background-color: #10b981;">
          <i class="fas fa-check"></i> Ajouter et fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

  <!-- Modal G√©n√©rer menu pour r√©sidents -->
  <div id="generate-menu-residents-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto; padding: 2rem;">
    <div style="background: white; max-width: 900px; margin: 2rem auto; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative;">
      <!-- Header -->
      <div style="background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%); color: white; padding: 1.5rem 2rem; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; color: white; display: flex; align-items: center; gap: 0.75rem;">
          <i class="fas fa-users"></i>
          G√©n√©rer un menu pour les r√©sidents
        </h2>
        <button onclick="closeGenerateMenuResidentsModal()" style="background: rgba(255,255,255,0.3); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: background 0.2s; font-weight: 600;">
          &times;
        </button>
      </div>
      
      <!-- Contenu -->
      <div style="padding: 2rem;">
        <!-- R√©sum√© des r√©sidents -->
        <div id="residents-summary-modal" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
          <h3 style="margin: 0 0 1rem 0; color: white; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-chart-pie"></i> R√©sum√© des R√©sidents
          </h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div style="background: rgba(255,255,255,0.3); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 0.9rem; opacity: 1; margin-bottom: 0.5rem; color: #ffffff; font-weight: 500;">Total R√©sidents</div>
              <div style="font-size: 2rem; font-weight: 700; color: #ffffff;" id="modal-summary-total-residents">0</div>
            </div>
            <div style="background: rgba(255,255,255,0.3); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <div style="font-size: 0.9rem; opacity: 1; margin-bottom: 0.5rem; color: #ffffff; font-weight: 500;">Total Portions</div>
              <div style="font-size: 2rem; font-weight: 700; color: #ffffff;" id="modal-summary-total-portions">0</div>
            </div>
          </div>
          <div style="margin-top: 1rem;">
            <div style="font-size: 0.9rem; opacity: 1; margin-bottom: 0.75rem; font-weight: 600; color: #ffffff;">Allergies et Restrictions</div>
            <div id="modal-summary-allergies-restrictions" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; max-height: 300px; overflow-y: auto;">
              <!-- Les allergies et restrictions seront g√©n√©r√©es dynamiquement -->
            </div>
          </div>
        </div>
        
        <!-- Options de g√©n√©ration -->
        <div style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
          <h3 style="margin: 0 0 1rem 0; color: #111827;">Options de g√©n√©ration</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div class="form-group">
              <label for="modal-menu-type"><i class="fas fa-clock"></i> Type de repas *</label>
              <select id="modal-menu-type" required style="width: 100%; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px;">
                <option value="d√©jeuner">D√©jeuner</option>
                <option value="d√Æner">D√Æner</option>
                <option value="petit-d√©jeuner">Petit-d√©jeuner</option>
                <option value="collation">Collation</option>
              </select>
            </div>
            <div class="form-group">
              <label for="modal-menu-period"><i class="fas fa-calendar-week"></i> P√©riode</label>
              <select id="modal-menu-period" style="width: 100%; padding: 0.8rem; border: 1px solid #ced4da; border-radius: 8px;">
                <option value="1">Un jour</option>
                <option value="7">Semaine (7 jours)</option>
                <option value="30">Mois (30 jours)</option>
              </select>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;"><i class="fas fa-bullseye"></i> Objectifs Nutritionnels (optionnel)</label>
            <div id="modal-nutritional-goals-container" style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb;">
              <div id="modal-nutritional-goals-list" style="margin-bottom: 1rem;">
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Aucun objectif ajout√© (optionnel). Les menus seront g√©n√©r√©s avec une grande vari√©t√©.</p>
              </div>
              <button type="button" id="modal-add-goal-btn" class="btn btn-outline" style="width: 100%; border-style: dashed; background: white; color: #10b981; border-color: #10b981;">
                <i class="fas fa-plus"></i> Ajouter un objectif nutritionnel
              </button>
            </div>
          </div>
        </div>
        
        <!-- Actions -->
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
          <button onclick="closeGenerateMenuResidentsModal()" style="background: #6c757d; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;">
            Annuler
          </button>
          <button id="generate-menu-residents-confirm-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-magic"></i>
            G√©n√©rer le menu
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- üßπ Script de nettoyage des anciens tokens (doit √™tre charg√© en premier) -->
  <script src="js/token-cleanup.js"></script>
  
  <!-- üîí Helper CSRF (doit √™tre charg√© avant les autres scripts qui font des requ√™tes) -->
  <script type="module" src="js/csrf-helper.js"></script>
  
  <!-- ‚úÖ Helper de validation (doit √™tre charg√© avant les scripts qui utilisent les donn√©es utilisateur) -->
  <script type="module" src="js/validation-helper.js"></script>
  
  <script type="module" src="js/supplier-common.js"></script>
  <script type="module" src="js/supplier-comparison.js"></script>
  <script type="module" src="js/order-tracking.js"></script>
  <script type="module" src="js/stock-common.js"></script>
  <script type="module" src="js/ehpad-dashboard.js"></script>
  <script type="module" src="js/resident-management.js"></script>
  <script src="js/recipe-generator.js"></script>
  <script src="js/foodcost-manager.js"></script>
  <script src="js/init.js"></script>
  <!-- Classe Modal r√©utilisable (doit √™tre charg√©e avant les scripts qui l'utilisent) -->
  <script src="js/modal.js"></script>
  <!-- G√©n√©rateur de menu personnalis√© avec objectifs nutritionnels -->
  <script src="js/custom-menu-generator.js"></script>
  <!-- Utilitaires pour les r√©sidents (doit √™tre charg√© avant ehpad-menu-calculator.js) -->
  <script src="js/resident-utils.js"></script>
  <!-- Module pour le calculateur de portions et la g√©n√©ration de menu pour r√©sidents -->
  <script src="js/ehpad-menu-calculator.js"></script>
  
  <script>
      // ===== Helper pour la gestion coh√©rente des erreurs =====
      /**
       * G√®re les erreurs de mani√®re coh√©rente : log + toast utilisateur
       * @param {Error|string} error - L'erreur ou le message d'erreur
       * @param {string} userMessage - Message √† afficher √† l'utilisateur (optionnel)
       * @param {boolean} showToast - Si true, affiche un toast √† l'utilisateur (d√©faut: true)
       * @param {string} context - Contexte de l'erreur pour le log (optionnel)
       */
      function handleError(error, userMessage = null, showToast = true, context = '') {
        const errorMessage = error instanceof Error ? error.message : String(error);
        const fullContext = context ? `[${context}] ` : '';
        
        // Toujours logger l'erreur
        console.error(`‚ùå ${fullContext}${errorMessage}`, error instanceof Error ? error : '');
        
        // Afficher un toast si demand√© et si showToast est disponible
        if (showToast && typeof window.showToast === 'function') {
          const message = userMessage || errorMessage || 'Une erreur est survenue';
          window.showToast(message, 'error');
        }
      }

      /**
       * G√®re les erreurs API de mani√®re coh√©rente
       * @param {Response} response - La r√©ponse fetch
       * @param {string} context - Contexte de l'erreur
       * @param {string} userMessage - Message √† afficher √† l'utilisateur
       * @returns {Promise<{success: boolean, data: any, error: string}>}
       */
      async function handleAPIResponse(response, context = '', userMessage = null) {
        try {
          if (!response.ok) {
            const errorText = await response.text();
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: errorText || `Erreur HTTP ${response.status}` };
            }
            const errorMsg = errorData.error || errorData.message || `Erreur HTTP ${response.status}`;
            handleError(errorMsg, userMessage || `Erreur lors de la requ√™te: ${errorMsg}`, true, context);
            return { success: false, data: null, error: errorMsg };
          }

          const data = await response.json();
          return { success: true, data, error: null };
        } catch (error) {
          handleError(error, userMessage || 'Erreur lors du traitement de la r√©ponse', true, context);
          return { success: false, data: null, error: error.message };
        }
      }

      const $n = document.getElementById('portion-normale');
      const $h = document.getElementById('portion-demi');
      const $d = document.getElementById('portion-double');
      const $totalResidents = document.getElementById('calc-total-residents');
      const $totalPortions = document.getElementById('calc-total-portions');
      const $apply = document.getElementById('calc-apply-to-generator');
      const $refresh = document.getElementById('calc-refresh');
      const $reset = document.getElementById('calc-reset');

      function toNum(el){ return Math.max(0, parseFloat(el?.value || '0') || 0); }

      function refreshTotals(){
        const normal = toNum($n);
        const demi = toNum($h);
        const dbl = toNum($d);
        const residents = normal + demi + dbl;
        const portions = normal + 0.5 * demi + 1.5 * dbl;
        $totalResidents.textContent = residents.toString();
        $totalPortions.textContent = (Math.round(portions * 100) / 100).toString();
        return { residents, portions };
      }

      // Les champs sont en lecture seule: calcul√©s automatiquement depuis les fiches r√©sidents
      refreshTotals();

      if ($apply) {
        $apply.addEventListener('click', (e) => {
          e.preventDefault();
          const { portions } = refreshTotals();
          const target = document.getElementById('custom-menu-people');
          if (target) {
            target.value = Math.max(1, Math.round(portions));
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
      }

      if ($reset) {
        $reset.addEventListener('click', (e) => {
          e.preventDefault();
          [$n, $h, $d].forEach(el => { if (el) el.value = '0'; });
          refreshTotals();
        });
      }

      // ===== Helpers pour la normalisation des donn√©es de portion =====
      /**
       * Obtient la taille de portion normalis√©e d'un r√©sident
       * Selon le mod√®le Resident, portionSize est au niveau racine : 0.5, 1, ou 2
       * @param {Object} resident - L'objet r√©sident
       * @returns {number} - La taille de portion (0.5, 1, ou 2), par d√©faut 1
       */
      function getPortionSize(resident) {
        if (!resident) return 1;
        
        // ‚úÖ NORMALIS√â : Utiliser uniquement resident.portionSize (selon le mod√®le)
        const portionSize = resident.portionSize;
        
        // Valider que c'est une valeur valide (0.5, 1, ou 2)
        if (portionSize === 0.5 || portionSize === 1 || portionSize === 2) {
          return portionSize;
        }
        
        // Si la valeur est null/undefined ou invalide, retourner la valeur par d√©faut
        return 1;
      }

      /**
       * Calcule le multiplicateur de portion √©quivalente
       * - 0.5 (demi-portion) = 0.5 portions √©quivalentes
       * - 1 (portion normale) = 1 portion √©quivalente
       * - 2 (double portion) = 1.5 portions √©quivalentes (√ó1.5)
       * @param {number} portionSize - La taille de portion (0.5, 1, ou 2)
       * @returns {number} - Le multiplicateur de portions √©quivalentes
       */
      function calculatePortionEquivalent(portionSize) {
        if (portionSize === 0.5) return 0.5;
        if (portionSize === 2) return 1.5; // Double portion = √ó1.5
        return 1; // Portion normale ou valeur par d√©faut
      }

      /**
       * Calcule le total de portions √©quivalentes pour un tableau de r√©sidents
       * @param {Array} residents - Tableau de r√©sidents
       * @returns {number} - Total de portions √©quivalentes
       */
      function calculateTotalPortions(residents) {
        if (!Array.isArray(residents)) return 0;
        
        return residents.reduce((total, resident) => {
          const portionSize = getPortionSize(resident);
          return total + calculatePortionEquivalent(portionSize);
        }, 0);
      }

      // ===== Fonction de compatibilit√© (d√©pr√©ci√©e, √† supprimer progressivement) =====
      /**
       * @deprecated Utiliser getPortionSize() et calculatePortionEquivalent() √† la place
       * Fonction conserv√©e temporairement pour compatibilit√© avec l'ancien code
       */
      function getPortionMultiplier(raw) {
        if (raw == null) return 1;
        const s = String(raw).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
        // numeric
        const num = parseFloat(s.replace(',', '.'));
        if (!isNaN(num) && num > 0) {
          if (num <= 0.6) return 0.5; // treat ~0.5 as demi
          if (num >= 1.4) return 1.5; // treat ~1.5-2 as double (√ó1.5)
          return 1;
        }
        // keywords
        if (/(demi|1\/2|half|¬Ω)/.test(s)) return 0.5;
        if (/(double|x2|2x|\b2\b)/.test(s)) return 1.5; // Double portion = √ó1.5
        return 1;
      }

      async function prefillFromResidents() {
        try {
          // ‚úÖ VALIDATION : Utiliser getStoredUser pour une validation stricte
          const user = typeof getStoredUser === 'function' ? getStoredUser() : null;
          if (!user) {
            // Fonction non-bloquante : pas de toast, juste un log de debug
            console.debug('‚ö†Ô∏è [prefillFromResidents] Utilisateur non connect√©, pr√©-remplissage ignor√©');
            return;
          }
          
          const siteId = user?.siteId;
          if (!siteId || (typeof isValidObjectId === 'function' && !isValidObjectId(siteId))) {
            // Fonction non-bloquante : pas de toast, juste un log
            console.warn('‚ö†Ô∏è [prefillFromResidents] SiteId invalide ou manquant');
            return;
          }

          // üîê S√âCURIT√â : Le backend filtre d√©j√† par siteId
          const resp = await fetch(`/api/residents/site/${siteId}`, {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });
          
          // ‚úÖ VALIDATION : Parser la r√©ponse de mani√®re s√©curis√©e
          let data;
          if (typeof safeAPIParse === 'function') {
            const parsed = await safeAPIParse(resp, {
              required: ['success', 'data'],
              types: { success: 'boolean', data: 'object' }
            });
            if (!parsed.success) {
              // Fonction non-bloquante : pas de toast, juste un log
              console.warn('‚ö†Ô∏è [prefillFromResidents] R√©ponse API invalide:', parsed.error);
              return;
            }
            data = parsed.data;
          } else {
            if (!resp.ok) {
              // Fonction non-bloquante : pas de toast, mais log l'erreur
              const errorText = await resp.text().catch(() => 'Erreur inconnue');
              console.warn(`‚ö†Ô∏è [prefillFromResidents] Erreur HTTP ${resp.status}:`, errorText);
              return;
            }
            data = await resp.json();
          }
          
          // Le backend a d√©j√† filtr√© par siteId, les r√©sidents retourn√©s sont s√©curis√©s
          const residents = Array.isArray(data?.data) ? data.data : [];

          // ‚úÖ NORMALIS√â : Utiliser getPortionSize() pour acc√©der de mani√®re coh√©rente √† portionSize
          let normal = 0, demi = 0, dbl = 0;
          residents.forEach(resident => {
            const portionSize = getPortionSize(resident);
            if (portionSize === 2) dbl++; // Double portion
            else if (portionSize === 0.5) demi++; // Demi-portion
            else normal++; // Portion normale (1 ou valeur par d√©faut)
          });

          if ($n) $n.value = String(normal);
          if ($h) $h.value = String(demi);
          if ($d) $d.value = String(dbl);

          const totals = refreshTotals();
          // Mettre aussi √† jour le g√©n√©rateur directement
          const target = document.getElementById('custom-menu-people');
          if (target) target.value = Math.max(1, Math.round(totals.portions));
        } catch (error) {
          // Fonction non-bloquante : pas de toast, mais log l'erreur pour le d√©bogage
          handleError(error, null, false, 'prefillFromResidents');
        }
      }

      prefillFromResidents();

      if ($refresh) {
        $refresh.addEventListener('click', (e) => {
          e.preventDefault();
          prefillFromResidents();
        });
      }

      // ===== Suggestions rapides: appliquer des objectifs pr√©d√©finis =====
      const suggestionButtons = document.querySelectorAll('.quick-goal');
      suggestionButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          try {
            // ‚úÖ VALIDATION : Parser JSON de mani√®re s√©curis√©e
            const goals = typeof safeJSONParse === 'function' 
              ? safeJSONParse(btn.getAttribute('data-goals') || '[]', [], (val) => Array.isArray(val))
              : JSON.parse(btn.getAttribute('data-goals') || '[]');
            if (!Array.isArray(goals) || goals.length === 0) return;
            // Remplacer les objectifs actuels par la suggestion
            customMenuGenerator.nutritionalGoals = goals.map(g => ({
              nutrient: g.nutrient,
              label: g.label,
              target: g.target,
              unit: g.unit,
              minIngredientValue: customMenuGenerator.getMinIngredientValue ? customMenuGenerator.getMinIngredientValue(g.nutrient) : 0
            }));
            if (typeof customMenuGenerator.renderNutritionalGoals === 'function') {
              customMenuGenerator.renderNutritionalGoals();
            }
            if (typeof customMenuGenerator.showToast === 'function') {
              customMenuGenerator.showToast('‚úÖ Objectifs appliqu√©s: ' + goals.map(g=>g.label+" "+g.target+g.unit).join(' ‚Ä¢ '), 'success');
            }
          } catch (error) {
            // Erreur non-critique : log mais pas de toast pour ne pas perturber l'utilisateur
            handleError(error, null, false, 'quick-goal-suggestion');
          }
        });
      });

      // ===== Modal G√©n√©rer menu pour r√©sidents =====
      const generateMenuResidentsBtn = document.getElementById('generate-menu-all-residents-btn');
      const generateMenuResidentsModal = document.getElementById('generate-menu-residents-modal');
      const generateMenuResidentsConfirmBtn = document.getElementById('generate-menu-residents-confirm-btn');

      // Ouvrir la modal
      if (generateMenuResidentsBtn) {
        generateMenuResidentsBtn.addEventListener('click', async () => {
          await openGenerateMenuResidentsModal();
        });
      }

      // Fonction pour ouvrir la modal et charger les donn√©es
      async function openGenerateMenuResidentsModal() {
        if (!generateMenuResidentsModal) {
          handleError('Modal non trouv√©e', 'Erreur: Impossible d\'ouvrir la modal', true, 'openGenerateMenuResidentsModal');
          return;
        }
        generateMenuResidentsModal.style.display = 'block';
        
        try {
          // ‚úÖ VALIDATION : Utiliser getStoredUser pour une validation stricte
          const user = typeof getStoredUser === 'function' ? getStoredUser() : null;
          if (!user) {
            handleError('Utilisateur non connect√©', 'Erreur: Utilisateur non connect√©', true, 'openGenerateMenuResidentsModal');
            return;
          }
          const siteId = user?.siteId;
          if (!siteId || (typeof isValidObjectId === 'function' && !isValidObjectId(siteId))) {
            handleError('Site ID invalide ou manquant', 'Erreur: Site ID invalide ou manquant', true, 'openGenerateMenuResidentsModal');
            return;
          }

          // üîê S√âCURIT√â : Le backend filtre d√©j√† par siteId et statut
          // Le filtrage c√¥t√© client est une double s√©curit√© pour l'UI uniquement
          const response = await fetch(`/api/residents/site/${siteId}?status=actif&limit=1000`, {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });
          
          // ‚úÖ VALIDATION : Parser la r√©ponse de mani√®re s√©curis√©e
          let data;
          if (typeof safeAPIParse === 'function') {
            const parsed = await safeAPIParse(response, {
              required: ['success', 'data'],
              types: { success: 'boolean', data: 'object' }
            });
            if (!parsed.success) {
              handleError(parsed.error || 'R√©ponse API invalide', 'Erreur lors du chargement des r√©sidents', true, 'openGenerateMenuResidentsModal');
              return;
            }
            data = parsed.data;
          } else {
            if (!response.ok) {
              const apiResult = await handleAPIResponse(response, 'openGenerateMenuResidentsModal', 'Erreur lors du chargement des r√©sidents');
              if (!apiResult.success) return;
              data = apiResult.data;
            } else {
              data = await response.json();
            }
          }
          
          // Le backend a d√©j√† filtr√© par siteId et statut 'actif'
          // Filtrage c√¥t√© client : double s√©curit√© pour l'UI (ne devrait jamais filtrer si le backend fonctionne correctement)
          const allResidents = data?.data || [];
          const siteIdStr = String(siteId);
          const activeResidents = allResidents.filter(r => {
            // V√©rifier le statut (d√©j√† fait par le backend, mais double s√©curit√©)
            const status = r.status ? String(r.status).toLowerCase().trim() : '';
            if (status !== 'actif') {
              console.warn(`‚ö†Ô∏è [openGenerateMenuResidentsModal] R√©sident ${r.firstName} ${r.lastName} avec statut "${status}" retourn√© par le backend (devrait √™tre filtr√©)`);
              return false;
            }
            
            // V√©rifier que le r√©sident appartient bien √† ce site (d√©j√† fait par le backend, mais double s√©curit√©)
            const residentSiteId = r.siteId ? (r.siteId._id ? String(r.siteId._id) : String(r.siteId)) : null;
            if (!residentSiteId || residentSiteId !== siteIdStr) {
              console.error(`üö® [openGenerateMenuResidentsModal] S√âCURIT√â - R√©sident ${r.firstName} ${r.lastName} du site ${residentSiteId} retourn√© pour le site ${siteIdStr} (le backend devrait avoir filtr√©)`);
              return false;
            }
            
            return true;
          });
          
          console.log(`üìä [openGenerateMenuResidentsModal] R√©sidents charg√©s pour site ${siteIdStr}: ${allResidents.length} retourn√©s par le backend, ${activeResidents.length} apr√®s filtrage client (double s√©curit√©)`);
          
          displayResidentsSummaryInModal(activeResidents);
        } catch (error) {
          handleError(error, 'Erreur lors du chargement des r√©sidents', true, 'openGenerateMenuResidentsModal');
        }
      }

      window.closeGenerateMenuResidentsModal = function() {
        if (generateMenuResidentsModal) generateMenuResidentsModal.style.display = 'none';
      };

      if (generateMenuResidentsModal) {
        generateMenuResidentsModal.addEventListener('click', (e) => {
          if (e.target === generateMenuResidentsModal) closeGenerateMenuResidentsModal();
        });
      }

      function displayResidentsSummaryInModal(residents) {
        // Filtrer uniquement les r√©sidents ACTIFS (double s√©curit√©)
        const activeResidents = (residents || []).filter(r => {
          const status = r.status ? String(r.status).toLowerCase().trim() : '';
          return status === 'actif';
        });
        
        if (activeResidents.length === 0) {
          document.getElementById('modal-summary-total-residents').textContent = '0';
          document.getElementById('modal-summary-total-portions').textContent = '0';
          const container = document.getElementById('modal-summary-allergies-restrictions');
          // S√©curis√© : utilisation de createElement et textContent au lieu de innerHTML
          container.textContent = ''; // Vider le conteneur
          const emptyDiv = document.createElement('div');
          emptyDiv.style.cssText = 'grid-column: 1/-1; text-align: center; opacity: 1; padding: 1rem; color: #ffffff;';
          emptyDiv.textContent = 'Aucun r√©sident actif trouv√©';
          container.appendChild(emptyDiv);
          return;
        }

        document.getElementById('modal-summary-total-residents').textContent = activeResidents.length;

        // ‚úÖ NORMALIS√â : Utiliser calculateTotalPortions() pour un calcul coh√©rent
        const totalPortions = calculateTotalPortions(activeResidents);
        document.getElementById('modal-summary-total-portions').textContent = Math.round(totalPortions * 100) / 100;

        // Fonction pour normaliser le nom d'allerg√®ne (√©viter les doublons)
        const normalizeAllergen = (name) => {
          const normalized = String(name).toLowerCase().trim();
          const variants = {
            'oeufs': 'oeufs', 'oeuf': 'oeufs', 'eggs': 'oeufs',
            'arachides': 'arachides', 'peanuts': 'arachides',
            'fruits_a_coque': 'fruits_a_coque', 'nuts': 'fruits_a_coque', 'noix': 'fruits_a_coque',
            'soja': 'soja', 'soy': 'soja',
            'poisson': 'poisson', 'fish': 'poisson',
            'crustaces': 'crustaces', 'shellfish': 'crustaces',
            'mollusques': 'mollusques', 'molluscs': 'mollusques',
            'celeri': 'celeri', 'celery': 'celeri',
            'moutarde': 'moutarde', 'mustard': 'moutarde',
            'gluten': 'gluten',
            'lactose': 'lactose',
            'sesame': 'sesame',
            'sulfites': 'sulfites',
            'lupin': 'lupin'
          };
          return variants[normalized] || normalized;
        };

        const allergiesCount = {}, restrictionsCount = {};
        activeResidents.forEach(resident => {
          // Utiliser un Set pour √©viter de compter deux fois le m√™me r√©sident pour le m√™me allerg√®ne
          const residentAllergens = new Set();
          
          if (resident.nutritionalProfile?.allergies?.length > 0) {
            resident.nutritionalProfile.allergies.forEach(allergy => {
              const allergen = allergy.allergen || allergy;
              const normalized = normalizeAllergen(allergen);
              residentAllergens.add(normalized);
            });
          }
          if (resident.nutritionalProfile?.intolerances?.length > 0) {
            resident.nutritionalProfile.intolerances.forEach(intolerance => {
              const substance = intolerance.substance || intolerance;
              const normalized = normalizeAllergen(substance);
              residentAllergens.add(normalized);
            });
          }
          
          // Compter chaque allerg√®ne une seule fois par r√©sident
          residentAllergens.forEach(allergen => {
            allergiesCount[allergen] = (allergiesCount[allergen] || 0) + 1;
          });
          
          if (resident.nutritionalProfile?.dietaryRestrictions?.length > 0) {
            resident.nutritionalProfile.dietaryRestrictions.forEach(restriction => {
              const rn = restriction.restriction || restriction.type || restriction;
              const normalized = String(rn).toLowerCase().trim();
              restrictionsCount[normalized] = (restrictionsCount[normalized] || 0) + 1;
            });
          }
        });

        const container = document.getElementById('modal-summary-allergies-restrictions');
        // S√©curis√© : vider le conteneur avant d'ajouter de nouveaux √©l√©ments
        container.textContent = '';
        
        // Fonction helper pour cr√©er un √©l√©ment d'allergie/restriction de mani√®re s√©curis√©e
        const createAllergyRestrictionItem = (name, count, iconClass, iconColor) => {
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'background: rgba(255,255,255,0.3); padding: 0.75rem 1rem; border-radius: 8px; backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; color: #ffffff;';
          
          // Conteneur pour le nom avec ic√¥ne
          const nameSpan = document.createElement('span');
          nameSpan.style.cssText = 'font-weight: 500; font-size: 0.9rem; display: flex; align-items: center;';
          
          // Ic√¥ne (s√©curis√©e : classe FontAwesome hardcod√©e)
          const icon = document.createElement('i');
          icon.className = iconClass;
          // S√©curis√© : iconColor est une valeur hardcod√©e pass√©e en param√®tre, pas des donn√©es utilisateur
          icon.style.cssText = `margin-right: 0.5rem; color: ${iconColor};`;
          nameSpan.appendChild(icon);
          
          // Nom (s√©curis√© : utilisation de textContent)
          const nameText = document.createTextNode(name);
          nameSpan.appendChild(nameText);
          
          // Conteneur pour le count
          const countSpan = document.createElement('span');
          countSpan.style.cssText = 'background: rgba(255,255,255,0.45); padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 700; font-size: 0.85rem; color: #ffffff;';
          // S√©curis√© : count est un nombre, converti en string avec textContent
          countSpan.textContent = String(count);
          
          itemDiv.appendChild(nameSpan);
          itemDiv.appendChild(countSpan);
          return itemDiv;
        };
        
        // Cr√©er les √©l√©ments pour les allergies
        const allergiesEntries = Object.entries(allergiesCount).sort((a, b) => b[1] - a[1]);
        if (allergiesEntries.length > 0) {
          allergiesEntries.forEach(([allergen, count]) => {
            // S√©curis√© : formatAllergenName retourne une string, utilis√©e avec textContent
            const formattedName = formatAllergenName(allergen);
            const item = createAllergyRestrictionItem(
              formattedName,
              count,
              'fas fa-exclamation-triangle',
              '#ffc107'
            );
            container.appendChild(item);
          });
        }
        
        // Cr√©er les √©l√©ments pour les restrictions
        const restrictionsEntries = Object.entries(restrictionsCount).sort((a, b) => b[1] - a[1]);
        if (restrictionsEntries.length > 0) {
          restrictionsEntries.forEach(([restriction, count]) => {
            // S√©curis√© : formatRestrictionName retourne une string, utilis√©e avec textContent
            const formattedName = formatRestrictionName(restriction);
            const item = createAllergyRestrictionItem(
              formattedName,
              count,
              'fas fa-ban',
              '#e74c3c'
            );
            container.appendChild(item);
          });
        }
        
        // Message si aucune allergie ou restriction
        if (allergiesEntries.length === 0 && restrictionsEntries.length === 0) {
          const emptyDiv = document.createElement('div');
          emptyDiv.style.cssText = 'grid-column: 1/-1; text-align: center; opacity: 1; padding: 1rem; color: #ffffff;';
          emptyDiv.textContent = 'Aucune allergie ou restriction enregistr√©e';
          container.appendChild(emptyDiv);
        }
      }

      function formatAllergenName(allergen) {
        const names = {'gluten': 'Gluten', 'lactose': 'Lactose', 'oeufs': '≈íufs', 'oeuf': '≈íufs', 'eggs': '≈íufs',
          'arachides': 'Arachides', 'peanuts': 'Arachides', 'fruits_a_coque': 'Fruits √† coque', 'nuts': 'Fruits √† coque',
          'noix': 'Fruits √† coque', 'soja': 'Soja', 'soy': 'Soja', 'poisson': 'Poisson', 'fish': 'Poisson',
          'crustaces': 'Crustac√©s', 'shellfish': 'Crustac√©s', 'mollusques': 'Mollusques', 'molluscs': 'Mollusques',
          'celeri': 'C√©leri', 'celery': 'C√©leri', 'moutarde': 'Moutarde', 'mustard': 'Moutarde',
          'sesame': 'S√©same', 'sulfites': 'Sulfites', 'lupin': 'Lupin'};
        return names[allergen.toLowerCase()] || allergen.charAt(0).toUpperCase() + allergen.slice(1);
      }

      function formatRestrictionName(restriction) {
        const names = {'vegetarien': 'V√©g√©tarien', 'vegan': 'V√©gan', 'sans_gluten': 'Sans gluten',
          'gluten_free': 'Sans gluten', 'sans_lactose': 'Sans lactose', 'lactose_free': 'Sans lactose',
          'halal': 'Halal', 'casher': 'Casher', 'kosher': 'Casher', 'sans_porc': 'Sans porc', 'no_pork': 'Sans porc',
          'sans_viande_rouge': 'Sans viande rouge', 'no_red_meat': 'Sans viande rouge', 'sans_sel': 'Sans sel',
          'salt_free': 'Sans sel', 'hyposode': 'Hyposod√©', 'pauvre_en_sucre': 'Pauvre en sucre', 'low_sugar': 'Pauvre en sucre',
          'diabetique': 'Diab√©tique', 'diabetic': 'Diab√©tique'};
        return names[restriction.toLowerCase()] || restriction.charAt(0).toUpperCase() + restriction.slice(1);
      }

      if (generateMenuResidentsConfirmBtn) {
        generateMenuResidentsConfirmBtn.addEventListener('click', async () => {
          const mealType = document.getElementById('modal-menu-type')?.value;
          const period = document.getElementById('modal-menu-period')?.value || '1';
          if (!mealType) {
            handleError('Type de repas non s√©lectionn√©', 'Veuillez s√©lectionner un type de repas', true, 'generateMenuResidentsConfirm');
            return;
          }
          closeGenerateMenuResidentsModal();
          try {
            // ‚úÖ VALIDATION : Utiliser getStoredUser pour une validation stricte
            const user = typeof getStoredUser === 'function' ? getStoredUser() : null;
            if (!user) {
              handleError('Utilisateur non connect√©', 'Erreur: Utilisateur non connect√©', true, 'generateMenuResidentsConfirm');
              return;
            }
            const siteId = user?.siteId;
            if (!siteId || (typeof isValidObjectId === 'function' && !isValidObjectId(siteId))) {
              handleError('Site ID invalide ou manquant', 'Erreur: Site ID invalide ou manquant', true, 'generateMenuResidentsConfirm');
              return;
            }
            // üîê S√âCURIT√â : Le backend filtre d√©j√† par siteId et statut
            const response = await fetch(`/api/residents/site/${siteId}?status=actif&limit=1000`, { credentials: 'include' });
            
            // ‚úÖ VALIDATION : Parser la r√©ponse de mani√®re s√©curis√©e
            let data;
            if (typeof safeAPIParse === 'function') {
              const parsed = await safeAPIParse(response, {
                required: ['success', 'data'],
                types: { success: 'boolean', data: 'object' }
              });
              if (!parsed.success) {
                handleError(parsed.error || 'R√©ponse API invalide', 'Erreur lors du chargement des r√©sidents', true, 'generateMenuResidentsConfirm');
                return;
              }
              data = parsed.data;
            } else {
              if (!response.ok) {
                const apiResult = await handleAPIResponse(response, 'generateMenuResidentsConfirm', 'Erreur lors du chargement des r√©sidents');
                if (!apiResult.success) return;
                data = apiResult.data;
              } else {
                data = await response.json();
              }
            }
            
            // Le backend a d√©j√† filtr√© par siteId et statut 'actif'
            // Filtrage c√¥t√© client : double s√©curit√© pour l'UI (ne devrait jamais filtrer si le backend fonctionne correctement)
            const allResidents = data?.data || [];
            const siteIdStr = String(siteId);
            const residents = allResidents.filter(r => {
              // V√©rifier le statut (d√©j√† fait par le backend, mais double s√©curit√©)
              const status = r.status ? String(r.status).toLowerCase().trim() : '';
              if (status !== 'actif') {
                console.warn(`‚ö†Ô∏è [generateMenuResidentsConfirm] R√©sident avec statut "${status}" retourn√© par le backend (devrait √™tre filtr√©)`);
                return false;
              }
              
              // V√©rifier que le r√©sident appartient bien √† ce site (d√©j√† fait par le backend, mais double s√©curit√©)
              const residentSiteId = r.siteId ? (r.siteId._id ? String(r.siteId._id) : String(r.siteId)) : null;
              if (!residentSiteId || residentSiteId !== siteIdStr) {
                console.error(`üö® [generateMenuResidentsConfirm] S√âCURIT√â - R√©sident du site ${residentSiteId} retourn√© pour le site ${siteIdStr} (le backend devrait avoir filtr√©)`);
                return false;
              }
              
              return true;
            });
            console.log(`üìä [generateMenuResidentsConfirm] R√©sidents pour site ${siteIdStr}: ${allResidents.length} retourn√©s par le backend, ${residents.length} apr√®s filtrage client (double s√©curit√©)`);
            
            // ‚úÖ NORMALIS√â : Utiliser calculateTotalPortions() pour un calcul coh√©rent
            const totalPortions = calculateTotalPortions(residents);
            const peopleInput = document.getElementById('custom-menu-people');
            const typeSelect = document.getElementById('custom-menu-type');
            const periodSelect = document.getElementById('custom-menu-period');
            if (peopleInput) peopleInput.value = Math.max(1, Math.round(totalPortions));
            if (typeSelect) typeSelect.value = mealType;
            if (periodSelect) periodSelect.value = period;
            if (typeof customMenuGenerator !== 'undefined' && customMenuGenerator.generateCustomMenu) {
              await customMenuGenerator.generateCustomMenu();
            }
            const resultsDiv = document.getElementById('custom-menu-results');
            if (resultsDiv) resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
          } catch (error) {
            handleError(error, 'Erreur lors de la g√©n√©ration du menu', true, 'generateMenuResidentsConfirm');
          }
        });
      }
  </script>

  <!--  SystÔøΩme de notifications en temps rÔøΩel -->
  <script src="js/notification-client.js"></script>
  <!-- supplier-common.js est d√©j√† charg√© plus haut en tant que module -->
  <script>
    // Initialiser les notifications pour le dashboard EHPAD
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üîî Initialisation des notifications EHPAD');
      
      // Attendre que le client de notifications et supplier-common.js soient charg√©s
      const initNotifications = () => {
        if (!window.notificationClient) {
          console.log('‚è≥ En attente du client de notifications...');
          setTimeout(initNotifications, 500);
          return;
        }
        
        if (typeof window.showMyOrders !== 'function') {
          console.log('‚è≥ En attente de supplier-common.js...');
          setTimeout(initNotifications, 500);
          return;
        }
        
        console.log('‚úÖ Client de notifications et supplier-common.js charg√©s');
        
        // √âcouter les changements de statut de commande
        window.notificationClient.on('order_status_change', (notification) => {
          console.log('üì¶ CHANGEMENT DE STATUT (WebSocket):', notification);
          console.log('   Commande:', notification.data?.orderNumber);
          console.log('   Nouveau statut:', notification.data?.newStatus);
          
          // Recharger les commandes si la fonction existe
          if (typeof window.showMyOrders === 'function') {
            console.log('   ‚Üí Rechargement des commandes (showMyOrders)...');
            setTimeout(() => {
              window.showMyOrders();
            }, 500); // Petit d√©lai pour laisser le backend sauvegarder
          } else if (typeof loadCustomerOrders === 'function') {
            console.log('   ‚Üí Rechargement des commandes (loadCustomerOrders)...');
            setTimeout(() => {
              loadCustomerOrders();
            }, 500);
          } else {
            console.warn('   ‚ö†Ô∏è Aucune fonction de rechargement trouv√©e');
          }
          
          // Recharger aussi le badge des commandes
          if (typeof loadOrdersBadgeOnly === 'function') {
            setTimeout(() => {
              loadOrdersBadgeOnly();
            }, 1000);
          }
        });
        
        // √âcouter les nouvelles commandes (pour le fournisseur, mais aussi utile pour le site)
        window.notificationClient.on('new_order', (notification) => {
          console.log('üõí NOUVELLE COMMANDE (WebSocket):', notification);
          
          // Recharger les commandes
          if (typeof window.showMyOrders === 'function') {
            setTimeout(() => {
              window.showMyOrders();
            }, 500);
          } else if (typeof loadCustomerOrders === 'function') {
            setTimeout(() => {
              loadCustomerOrders();
            }, 500);
          }
        });
      };
      
      initNotifications();
      
      // D√©marrer la v√©rification p√©riodique des commandes (toutes les 10 secondes)
      // Attendre que checkOrdersUpdates soit disponible
      const startPeriodicCheck = () => {
        if (typeof window.checkOrdersUpdates === 'function') {
          console.log('üîÑ D√©marrage de la v√©rification p√©riodique des commandes...');
          setInterval(window.checkOrdersUpdates, 10000); // V√©rifier toutes les 10 secondes
        } else {
          console.log('‚è≥ En attente de checkOrdersUpdates...');
          setTimeout(startPeriodicCheck, 500);
        }
      };
      
      startPeriodicCheck();
    });
  </script>
  <script src="js/dashboard-notifications.js"></script>
  <script type="module" src="js/messages-display.js"></script>
  <script src="js/promotion-notifications.js"></script>

</body>
</html>
